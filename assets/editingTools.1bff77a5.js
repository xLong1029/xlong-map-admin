import{e as h,y as d,b as X,d as oi,co as Aa,mx as Da,a4 as Ga,w as G,r as c,az as $a,H as Pt,i as v,nf as Ra,uO as Ia,jt as La,vA as Pa,ni as Va,cB as Et,mA as je,mY as za,tz as Ca,cT as Ha,eN as qe,cV as ie,cO as $e,vB as Na,ak as z,hg as Ua,vC as Xa,gM as Z,uZ as Za,vD as Ya,vE as ka,nK as ne,vF as xi,vG as si,mj as At,aN as lt,io as ri,ij as li,h as ft,a as L,nm as J,oK as V,kp as Tt,lY as Re,oG as We,vH as oa,aP as pi,aQ as hi,X as Fa,oM as Ba,aO as wi,af as ja,vI as qa,jC as Wa,vJ as sa,n as D,vK as Ja,vL as Ka,t as qt,Y as Dt,ns as at,vM as ae,vN as ci,vO as Qa,vP as Wt,vQ as be,vR as ra,kD as Ei,n2 as R,oU as q,nn as w,no as E,oX as tn,hJ as Me,ne as la,cP as Y,oV as Se,l as pa,o$ as di,i9 as ui,gQ as Ie,vS as en,nz as ha,vT as an,vU as ca,oC as yt,vV as nn,p3 as on,ox as sn,hX as nt,l7 as Je,iu as Ke,l6 as Ft,p0 as rn,oY as ln,nE as da,vW as pn,cn as Qe,a7 as hn,ay as Bt,v1 as cn,vX as dn,vY as Yt,cH as ua,v4 as Le,F as un,vi as Gt,vZ as gn,v_ as ga,hr as Pe,v$ as ti,w0 as _n,w1 as mn,nJ as xe,m4 as Ve,nQ as we,oL as vn,G as gi,w2 as Oi,w3 as yn,na as pe,nw as _a,kQ as _i,w4 as ma,w5 as fn,mB as Ti,iv as Mn,p as mi,w6 as Kt,w7 as bn,v3 as vt,aC as xt,w8 as Ai,w9 as Di,qY as Sn,i6 as Ee,wa as xn,wb as wn,o6 as ue,ht as En,n1 as On,wc as va,oI as Gi,wd as Tn,fD as ei,dj as An,nj as mt,la as Dn,we as Gn,vh as ya,wf as $n,wg as Rn,U as Oe,ch as In,ad as et,wh as $i,i5 as Ln,n3 as fa,nx as ii,ny as Ma,wi as Pn,nH as oe,p4 as Vn,it as zn,wj as Ri,wk as Ii,oB as Cn,qT as Hn,wl as Nn,bC as ai,aR as Un,wm as Xn,oO as ge,nq as Zn,o3 as Yn,mz as kn,oo as Fn,oQ as Qt,oT as Li,ah as Xe,n7 as _e,v8 as Pi,om as Bn,on as jn,op as qn,p6 as Wn}from"./index.a33ecea7.js";import{x as Jn,d as Te,b as se,a as re,e as Ze}from"./quantityFormatUtils.f35d4e58.js";import{x as Kn}from"./TextOverlayItem.90d2b48f.js";import{d as Qn,a as Mt,b as he,t as ze,m as to,l as eo}from"./automaticLengthMeasurementUtils.fa72e8ed.js";import{y as m,r as vi}from"./settings.3514c0cd.js";import{e as Ht,I as Ct}from"./GraphicState.ca18c216.js";import{_ as Vi}from"./VerticesVisualElement.07fc61c6.js";import{H as io,B as ao,M as zi,A as no,G as oo,S as me,Y as Ci}from"./editPlaneUtils.4a822bf1.js";import{t as Vt}from"./manipulatorUtils.21377cc7.js";import{r as le,p as Ce,a as yi,l as so,c as ro,n as lo}from"./TranslateTooltipInfos.000feb03.js";import{v as Ae,x as po,D as ho}from"./euclideanLengthMeasurementUtils.a30cc4ff.js";import{i as co}from"./automaticAreaMeasurementUtils.f39d02ec.js";import{r as ba,s as uo,N as go,j as _o,u as mo,_ as vo,h as yo,o as Hi,q as fo,I as Mo,B as bo,K as So,J as xo}from"./sliceToolUtils.409c391e.js";import{o as wo}from"./Factory.06c97619.js";import{i as Eo,p as Oo}from"./ExtentTooltipInfos.de8fbf8a.js";import"./LineVisualElement.ea11337b.js";import"./measurementUtils.43da56cb.js";import"./euclideanAreaMeasurementUtils.cab0339e.js";const To=3025,Ao={default:15,far:25};let rt=class extends oi{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=Aa(async i=>{const n=await Da("esri/core/t9n/Units");Ga(i),this._messagesUnits=n}),e=()=>qe(this.context,i=>i.editGeometryOperations);this.addHandles([G(()=>[c(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>$a(e,i,()=>this._update())),Pt(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return v(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return Ao[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(v(t))return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:n}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const a=e.length;for(let o=0;o<a;++o){const s=[];if(e[o].iterateVertices(_=>{s.push(n.toXYZ(_.pos))}),o===0&&c(this.stagedVertex)&&s.push(n.toXYZ(this.stagedVertex)),s.length<2)continue;const r=s[0],l=s[s.length-1];i.type==="polygon"&&s.length>2&&!Ra(r,l)&&s.push(r);const p=a===1&&!Ia(s,!1,!1);let u=Do,g=Go;this.toScreenPointArray(t,r,u);for(let _=1;_<s.length;++_){const M=s[_-1],f=s[_];this.toScreenPointArray(t,f,g),this._addLabel(t,M,u,f,g,p),[u,g]=[g,u]}}this._destroyUnusedLabels()}_addLabel(t,e,i,n,a,o){const{label:s}=this._getOrCreateLabel(t);if(!this.visible||La(i,a)<To)return void(s.visible=!1);const r=c(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":Pa(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,p=Qn(e,n,l,r),u=this._messagesUnits,g=Va(t.view);s.text=c(u)&&c(p)?Jn(u,p,g):"",s.visible=!0;const _=a[0]-i[0],M=a[1]-i[1];o?Et(K,-M,_):Et(K,M,-_),je(K,K),za(K,K,this._edgeDistancePixels),Ca(te,i,a,.5),Ha(te,te,K),s.position=[te[0],te[1]],Math.abs(K[0])>Math.abs(K[1])?s.anchor=K[0]>0?"left":"right":s.anchor=-K[1]<0?"top":"bottom"}_getOrCreateLabel(t){var n;if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new Kn({fontSize:10,anchor:"center"});(n=t.view.overlay)==null||n.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){qe(this.context,e=>{var i;return(i=e.view.overlay)==null?void 0:i.items.remove(t)}),t.destroy()}};h([d()],rt.prototype,"context",void 0),h([d()],rt.prototype,"stagedVertex",void 0),h([d()],rt.prototype,"visible",void 0),h([d()],rt.prototype,"edgeDistance",void 0),h([d()],rt.prototype,"updating",null),h([d()],rt.prototype,"_messagesUnits",void 0),h([d()],rt.prototype,"_edgeDistancePixels",null),rt=h([X("esri.views.interactive")],rt);const K=ie(),te=ie(),Do=$e(),Go=$e();let De=class extends rt{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},n,a=$e()){const{spatialReference:o}=i.data.coordinateHelper;return Na(n,o,e,t,Ni),t.state.camera.projectToScreen(Ni,a),a}};De=h([X("esri.views.3d.interactive.SegmentLabels3D")],De);const Ni=z();let Nt=class extends io{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Ua({mode:t,offset:e})}normalizeCtorArgs(t){var e;if(!t.elevationInfo){const i=(e=t.hasZ)!=null?e:!0;return{...t,elevationInfo:Xa(i)}}return t}initializeGraphic(t){const e=this._createGraphicState=new Ht({graphic:t});return Z([this.view.maskOccludee(t),this.view.trackGraphicState(e),G(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:i,isDraped:n})=>{qe(i,a=>a.isDraped=n)},ft)])}makeDrawOperation(){const{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new Za({view:this.view,manipulators:this.manipulators,geometryType:ao(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ya(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new ka(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ne,segmentLabels:e?new De:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:xi(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){const{view:e}=this;return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],this._updateVerticalLineVisualElement(t),null):(this._activeVertexVisualElement=new Vi({view:e,spatialReference:e.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:m.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=m.colorToVec4(m.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,this._verticalLineVisualElement=new si({view:e,extensionType:m.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:At.OccludeAndTransparent}),m.visualElements.zVerticalLine.apply(this._verticalLineVisualElement),Pt(()=>{this._activeVertexVisualElement=L(this._activeVertexVisualElement),this._verticalLineVisualElement=L(this._verticalLineVisualElement)}))}_updateVerticalLineVisualElement(t){const e=this._verticalLineVisualElement;if(v(e))return;const{renderCoordsHelper:i,elevationProvider:n}=this.view;lt(Ut,t[0],t[1],t[2]),Ui.setFromElevationInfo(this.elevationInfo),Ut[2]=ri(Ut,n,Ui,i),i.toRenderCoords(Ut,this.view.spatialReference,Ut)?(e.setStartEndFromWorldDownAtLocation(Ut),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ct({view:this.view,geometry:t,elevationInfo:e,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:xi(this.hasZ,e)==="on-the-ground",attached:!1}),m.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),m.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Pt(()=>{this._outlineVisualElement=L(this._outlineVisualElement)})}onRegularVerticesChanged(t){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Vi({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:m.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Pt(()=>{this._verticesVisualElement=L(this._verticesVisualElement)}))}};h([d({constructOnly:!0})],Nt.prototype,"elevationInfo",void 0),h([d({constructOnly:!0})],Nt.prototype,"geometryType",void 0),h([d()],Nt.prototype,"type",void 0),h([d({constructOnly:!0})],Nt.prototype,"view",void 0),Nt=h([X("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Nt);const Ui=new li,Ut=z();var it;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(it||(it={}));var A;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(A||(A={}));class Sa{constructor(){this.grabbingState=it.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=it.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,n)=>{if(n===A.TRANSLATE_Z&&(this.zManipulator=i),i instanceof J&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),v(this.firstGrabbedXY)&&i.grabbing&&n===A.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=it.ANY,n){case A.TRANSLATE_Z:this.grabbingState|=it.Z;break;case A.TRANSLATE_XY:this.grabbingState|=it.XY}})}}function $o(t){const{view:e,graphic:i}=t,n=new Ht({graphic:i}),a=Ro(t,n),o=[a,Io(t,a.visualElement,n),e.maskOccludee(i),e.trackGraphicState(n)];return{visualElement:a.visualElement,remove:()=>Z(o).remove()}}function Ro(t,e){const{view:i,graphic:n}=t,a=new Ct({view:i,geometry:ni(n)?n.geometry:null,elevationInfo:V(n),attached:!1});m.visualElements.lineGraphics.shadowStyle.apply(a);const o=()=>{a.attached=e.displaying};m.visualElements.lineGraphics.outline.apply(a);const s=[G(()=>e.displaying,o),G(()=>e.isDraped,r=>{a.isDraped=r}),e.on("changed",()=>a.geometry=ni(n)?n.geometry:null),Tt(a)];return o(),{visualElement:a,remove:()=>Z(s).remove()}}function Io(t,e,i){const{graphic:n,view:a}=t,o=[],s=V(n),r=s.mode==="on-the-ground"||!s.offset&&s.mode!=="absolute-height",l=new Sa,p=new si({view:a,extensionType:m.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:At.OccludeAndTransparent});m.visualElements.pointGraphics.shadowStyle.apply(p);const u=Re(m.visualElements.heightPlaneAngleCutoff),g=new We({view:a,attached:!1,angleCutoff:u});m.visualElements.heightPlane.apply(g);let _=1,M=1;const f=()=>{if(l.update(t),!i.displaying||r&&(i.isDraped||!ni(n)||!n.geometry.hasZ))return e.laserlineEnabled=!1,p.attached=!1,void(g.attached=!1);e.laserlineEnabled=!0;const x=l.grabbingState&it.XY?m.visualElements.laserlineAlphaMultiplier:1;x!==_&&(_=x,m.visualElements.lineGraphics.shadowStyle.apply(e,x),m.visualElements.pointGraphics.shadowStyle.apply(p,x));const I=l.grabbingState&it.Z?m.visualElements.laserlineAlphaMultiplier:1;I!==M&&(M=I,m.visualElements.heightPlane.apply(g,I)),Lo(p,l),Po(t,e,g,l)};m.visualElements.zVerticalLine.apply(p),o.push(i.on("changed",f),G(()=>i.displaying,f),e.events.on("attachment-origin-changed",f),Tt(p),Tt(g));const y=[],b=()=>{Z(y).remove(),y.length=0,t.forEachManipulator(x=>y.push(x.events.on("grab-changed",f))),t.forEachManipulator(x=>y.push(x.events.on("select-changed",f))),f()};return b(),o.push(t.onManipulatorsChanged(b),oa(()=>Z(y))),Z(o)}function Lo(t,e){const i=e.numSelected===1?e.firstSelected:e.numSelected>1&&c(e.firstGrabbedXY)?e.firstGrabbedXY:null;c(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function Po(t,e,i,n){if(n.numSelected>0){lt(It,0,0,0);let a=0;t.forEachManipulator((o,s)=>{s===A.TRANSLATE_XY&&o.selected&&o instanceof J&&(pi(It,It,o.renderLocation),a++)}),a>0?(i.heightManifoldTarget=hi(It,It,1/a),i.attached=!0):i.attached=!1}else{const a=e.attachmentOrigin;c(a)&&t.view.renderCoordsHelper.toRenderCoords(a,It)?(i.heightManifoldTarget=It,i.attached=!0):i.attached=!1}}function ni(t){return c(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const It=z();function Vo(t){const{view:e,graphic:i}=t,n=new Ht({graphic:i}),a=[],o=Co(t,n,a);return zo(t,n,a,o),a.push(e.trackGraphicState(n)),{visualElement:o,remove(){Z(a).remove()}}}function zo(t,e,i,n){const{view:a,graphic:o}=t,s=new si({view:a,extensionType:m.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:At.OccludeAndTransparent});m.visualElements.zVerticalLine.apply(s);const r=new We({view:a,intersectsLineInfinite:!0,attached:!1});m.visualElements.pointGraphics.shadowStyle.apply(r);const l=Re(m.visualElements.heightPlaneAngleCutoff),p=new We({view:a,attached:!1,angleCutoff:l});m.visualElements.heightPlane.apply(p);const u=V(t.graphic),g=li.fromElevationInfo(u),_=u.mode==="on-the-ground"||!u.offset&&u.mode!=="absolute-height",M=new Sa;let f=1,y=1;const b=()=>{M.update(t);const x=fi(o),I=_&&(e.isDraped||v(x)||!x.hasZ);let C=!0;if(!I&&c(x)){const T=ri(x,a.elevationProvider,g,a.renderCoordsHelper);lt(tt,x.x,x.y,T),wi(tt,x.spatialReference,tt,a.renderCoordsHelper.spatialReference),s.setStartEndFromWorldDownAtLocation(tt),r.intersectsWorldUpAtLocation=tt}else C=!1;const $t=M.grabbingState&it.Z?m.visualElements.laserlineAlphaMultiplier:1;$t!==f&&(f=$t,m.visualElements.heightPlane.apply(p,$t));const k=ja(Xo);!I&&e.displaying&&n.calculateMapBounds(k)&&wi(qa(k,tt),a.spatialReference,tt,a.renderCoordsHelper.spatialReference)?(p.heightManifoldTarget=tt,p.attached=!0):p.attached=!1;const ht=M.grabbingState&it.XY?m.visualElements.laserlineAlphaMultiplier:1;ht!==y&&(y=ht,m.visualElements.pointGraphics.shadowStyle.apply(r,ht));const de=C&&e.displaying&&!I;r.attached=de,s.attached=de};i.push(G(()=>[e.displaying,e.isDraped],b),e.on("changed",b)),t.forEachManipulator(x=>{i.push(x.events.on("grab-changed",b))}),i.push(Tt(r)),i.push(Tt(s)),i.push(Tt(p)),b()}function Co(t,e,i){const{view:n,graphic:a}=t,o=new Ba({view:n,geometry:fi(a),elevationInfo:V(a),attached:!1});return Ho(t,o,e,i),i.push(Tt(o)),o}function fi(t){const e=t.geometry;return v(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function Ho(t,e,i,n){const a=()=>e.attached=i.displaying;No(t,e,i,n),m.visualElements.pointGraphics.outline.apply(e),n.push(G(()=>i.displaying,a,ft))}function No(t,e,i,n){const{view:a,graphic:o}=t;let s=null;const r=p=>{c(s)&&(s.remove(),s=null),i.isDraped&&c(p)&&(s=Uo(a,p,()=>{e.geometry=p}))},l=()=>{const p=fi(o);r(p),e.geometry=p};n.push(i.on("changed",l),oa(()=>s)),l()}function Uo(t,e,i){const n=t.elevationProvider.spatialReference;Wa(e,tt,n);const a=tt[0],o=tt[1];return t.elevationProvider.on("elevation-change",s=>{sa(s.extent,a,o)&&i()})}const tt=z(),Xo=Fa();function He(t){switch(D(t.graphic.geometry).type){case"point":case"mesh":return Vo(t);case"polygon":case"polyline":return $o(t);default:return null}}const Zo=[1,.5,0],xa=128,pt=70,Yo=80,wa=.02,ko=54,Fo=100,Ea=Math.ceil(pt/3*2),Lt=160,Ye=.5,ke=24,Xt=9,Bo=Lt+30,Xi=Lt+53,jo=60,qo=23,Wo=5*Math.PI/12,Jo=1*Math.PI/3,Zi=10,Yi=.2,ki=30,Fi=53,Bi=.2,ji=.3,Ko=200,Qo=3,ts=1e6;class ce{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(n=>{!i&&e(n)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,n)=>{i instanceof J&&e(i,n)})}}function Ne(t,e,i,n){const a=t.graphic,o=(s,r)=>e({action:s,graphic:a,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY});return i((s,r,l)=>(r.next(p=>(p.action==="start"&&o("start",p),p)).next(Ja(a,n)).next(p=>{switch(p.action){case"start":case"update":(p.translationX||p.translationY||p.translationZ)&&o("update",p);break;case"end":o("end",p)}return p}),{steps:r,cancel:l=l.next(Ka(a)).next(p=>(o("end",{screenDeltaX:0,screenDeltaY:0}),p))}))}function Oa(t){if(v(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],n=e[1];return Math.atan2(n[1]-i[1],n[0]-i[0])}function Ge(t){if(v(t)||v(t.axis))return 1;const{mapStart:e,mapEnd:i,axis:n}=t,a=[i.x-e.x,i.y-e.y];return a[0]*n[0]+a[1]*n[1]>0?1:-1}class es extends ce{constructor(e){super(),this._handles=new qt,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=pt,this._updateAfterDrag=!1,this.events=new Dt,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this._handles=L(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:i}of this._arrowManipulatorInfos)e(i,A.TRANSLATE_XY)}createGraphicDragPipeline(e,i,n){const a=i.graphic,o=V(a),s=D(a.geometry).spatialReference;return Ne(i,n,r=>this.createDragPipeline((l,p,u,g,_)=>({steps:p,cancel:u}=e(l,p,u,g,_),r(l,p,u)),o,s,a),this._view.state.viewingMode)}createDragPipeline(e,i,n,a){return Z(this._arrowManipulatorInfos.map(({manipulator:o},s)=>at(o,(r,l,p,u,g)=>{const _=l.next(M=>({...M,manipulatorType:A.TRANSLATE_XY})).next(ae(this._view,r.elevationAlignedLocation)).next(ci(this._view,r.elevationAlignedLocation,i,n,a)).next(Qa(r.location,this.angle+(s+1)*Math.PI*.5)).next(Wt());e(r,_,p,u,g)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},n){const a=this._radius/pt,o=ko*a,s=o*Math.sqrt(3)/2,r=be(this._opaqueMaterial,s,o/2,o/2,wa);ra(r,Ei(q.get(),lt(R.get(),0,-s/3,0))),e.renderObjects=[new w(r,E.Focused),new w(r.instantiate({material:this._transparentMaterial}),E.Unfocused)],e.radius=s/3*2*1.2;const l=tn(q.get(),n*Math.PI/2),p=Ei(q.get(),lt(R.get(),0,Fo*a,0));Me(i,l,p)}_createManipulators(){for(let e=0;e<4;e++){const i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,i=la(q.get(),e,Y(0,0,1));if(v(i))return;const n=Se(q.get(),lt(R.get(),this.displayScale,this.displayScale,this.displayScale)),a=Me(q.get(),n,i);for(const o of this._arrowManipulatorInfos){const s=Me(q.get(),a,o.transform);o.manipulator.modelTransform=s}}_createArrowManipulator(e){const i=new J({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Y(0,0,1)}}),n={manipulator:i,transform:Ie()};return this._updateArrowManipulator(n,e),this._handles.add(i.events.on("drag",a=>{this._updateAfterDrag&&a.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),n}_createMaterial(e=1){const i=pa.toUnitRGBA(vi.main);return i[3]*=e,new di({color:i,transparent:e!==1,cullFace:ui.Back,renderOccluded:At.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class is{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this._lastDragEvent)&&c(this._next)){const i=this._lastDragEvent.mapEnd,n=this._snap(this._lastDragEvent.screenEnd);if(c(n)){const a={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:e===!0?n:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(a)}}this._enabled=e}_snap(e){const i=c(this._view)?this._view.toMap(e,{exclude:[]}):null;return c(i)&&c(this._view)&&(i.z=en(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(e,i){this._view=e,this._elevationInfo=i,this._lastDragEvent=null;const n=new ha;return this._next=n,[a=>{if(this._lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const o=this._snap(a.screenEnd);return c(o)?{action:a.action,mapStart:a.mapStart,mapEnd:o,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}},n]}}class as extends ce{constructor(e){super(),this._snapToScene=new is,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=pt,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,A.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,i,n){const a=i.graphic,o=V(a),s=D(a.geometry).spatialReference;return Ne(i,n,r=>this.createDragPipeline((l,p,u,g,_)=>({steps:p,cancel:u}=e(l,p,u,g,_),r(l,p,u)),o,s,a),this._view.state.viewingMode)}createDragPipeline(e,i,n,a){const o=this._view;return at(this._manipulator,(s,r,l,p,u)=>{const g=r.next(ae(o,s.elevationAlignedLocation)).next(ci(o,s.elevationAlignedLocation,i,n,a)).next(...this._snapToScene.createDragEventPipelineStep(o,i)).next(_=>({..._,manipulatorType:A.TRANSLATE_XY})).next(Wt());e(s,g,l,p,u)})}_updateManipulatorTransform(){const e=Se(q.get(),lt(R.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new J({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Y(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=an(this._discMaterial,wa,1,xa,Y(0,0,1),Y(0,0,0));e.transformation=Se(Ie(),Y(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new w(e,E.Focused),new w(e.instantiate({material:this._discMaterialTransparent}),E.Unfocused)],this._manipulator.radius=Yo*(this._radius/pt)}_createMaterial(e=1){const i=pa.toUnitRGBA(vi.main);return i[3]*=e,new di({color:i,transparent:e!==1,cullFace:ui.Back,renderOccluded:At.Transparent})}get test(){return{discManipulator:this._manipulator}}}class ns extends ce{constructor(e){super(),this._radius=pt,this.events=new Dt,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,A.TRANSLATE_Z)}createGraphicDragPipeline(e,i,n){const a=D(i.graphic.geometry).spatialReference;return Ne(i,n,o=>this.createDragPipeline((s,r,l,p,u)=>({steps:r,cancel:l}=e(s,r,l,p,u),o(s,r,l)),a),this._view.state.viewingMode)}createDragPipeline(e,i){const n=this._view;return at(this._manipulator,(a,o,s,r,l)=>{const p=o.next(u=>({...u,manipulatorType:A.TRANSLATE_Z})).next(ca(n,a.renderLocation,i)).next(Wt());e(a,p,s,r,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/pt,i=m.zManipulator.height*e,n=m.zManipulator.coneHeight*e,a=m.zManipulator.coneWidth*e,o=m.zManipulator.width*e,s=[Y(0,0,0),Y(0,0,i)],r=[Y(0,0,0),Y(0,0,i+n)],l=x=>{const I=Ie();if(rn(I,I,[0,0,i]),ln(I,I,Math.PI/2),x){const C=1+2*x/a;da(I,I,[C,C,C])}return I},p=l(0),u=(x,I)=>{const C=pn(m.zManipulator.color,I);return[C.r/255,C.g/255,C.b/255,m.zManipulator.color.a*x]},g=yt(u(1,.25),At.Occlude),_=yt(u(1,0),At.Occlude),M=yt(u(.7,0),m.zManipulator.renderOccluded),f=yt(u(.85,0),m.zManipulator.renderOccluded),y=nn(g,s,o/2,16,!1),b=on(g,n,a/2,16,!1);b.transformation=p,this._manipulator.renderObjects=[new w(b,E.Unfocused),new w(y,E.Unfocused),new w(b.instantiate({material:_}),E.Focused),new w(y.instantiate({material:_}),E.Focused),new w(b.instantiate({material:M}),E.Unfocused),new w(y.instantiate({material:M}),E.Unfocused),new w(b.instantiate({material:f}),E.Focused),new w(y.instantiate({material:f}),E.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[r]}}_createManipulator(){const e=new J({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=i=>{const n=this._view.state.camera,a=qi;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const o=sn(n.eye,a),s=n.computeRenderPixelSizeAtDist(o),r=nt(Zt,a,n.eye);Je(r,r);const l=os;this._view.renderCoordsHelper.worldUpAtPosition(qi,l);const p=Math.abs(Ke(r,l)),u=Ft(Zt,r,l),g=Ft(Zt,u,l),_=Qe(p,.01,1),M=1-Math.sqrt(1-_*_)/_/n.fullWidth,f=this._radius/pt,y=m.zManipulator.width*f;hi(g,Je(g,g),(1/M-1)*o+s*y),i[12]-=Zt[0],i[13]-=Zt[1],i[14]-=Zt[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const qi=z(),Zt=z(),os=z();class zt extends ce{constructor(e){super(),this._handles=new qt,this._interactive=!0;const{tool:i,view:n,snapToScene:a,radius:o}=e;this._view=n,this.xyManipulation=new as({tool:i,view:n,snapToScene:a,radius:o}),this.xyAxisManipulation=new es({tool:i,view:n,radius:o}),this.zManipulation=new ns({tool:i,view:n,radius:o}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(s=>this._handles.add(s.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,i,n){return Z([this.xyManipulation.createGraphicDragPipeline((a,o,s,r,l)=>e(S.XY,a,o,s,r,l),i,n),this.xyAxisManipulation.createGraphicDragPipeline((a,o,s,r,l)=>e(S.XY_AXIS,a,o,s,r,l),i,n),this.zManipulation.createGraphicDragPipeline((a,o,s,r,l)=>e(S.Z,a,o,s,r,l),i,n)])}createDragPipeline(e,i,n,a){return Z([this.xyManipulation.createDragPipeline((o,s,r,l,p)=>e(S.XY,o,s,r,l,p),i,n,a),this.xyAxisManipulation.createDragPipeline((o,s,r,l,p)=>e(S.XY_AXIS,o,s,r,l,p),i,n,a),this.zManipulation.createDragPipeline((o,s,r,l,p)=>e(S.Z,o,s,r,l,p),n)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this.xyAxisManipulation.angle=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,A.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,A.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,A.TRANSLATE_Z))}get _xyAxisVisible(){const e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(hn("esri-mobile"))return;const n=[];i.forEachManipulator(o=>n.push(o)),e.forEachManipulator(o=>n.push(o));const a=()=>{const o=[];this._xyAxisVisible||e.forEachManipulator(s=>o.push(s.disableDisplay())),this._handles.remove(Wi),this._handles.add(o,Wi)};for(const o of n)this._handles.add(o.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(Bt(()=>{var o;return(o=this._view.inputManager)==null?void 0:o.latestPointerType},a)),a()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this._interactive||i.grabbing})}static radiusForSymbol(e){const i=c(e)&&e.type==="point-3d"&&e.symbolLayers;return!!i&&i.length>0&&i.some(n=>n.type==="icon")?Ea:pt}}const Wi="disable-xy-axis-display";var S;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(S||(S={}));class Mi extends ce{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,A.TRANSLATE_XY)}createGraphicDragPipeline(e){return Ne(this._graphicState,e,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(e){const i=this._view,n=this._graphicState.graphic,a=c(n.geometry)?n.geometry.spatialReference:null;return at(this._manipulator,(o,s,r,l,p)=>{const u=s.next(dn(p,i,n,a)).next(Yt()).next(Wt());e(o,u,r,l,p)})}_createManipulator(){const e=this._view,i=this._graphicState.graphic;this._manipulator=new cn({graphic:i,view:e,selectable:!0,cursor:"move"})}}class ss{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class rs{constructor(e,i,n){this.dx=e,this.dy=i,this.allGraphics=n,this.type="graphic-move"}}class Ji{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let ct=class extends ua(Dt.EventedMixin(Le)){constructor(t){super(t),this.graphics=new un,this.enableZ=!0,this.tooltipOptions=new Gt,this.type="move-3d",this._tooltip=null}initialize(){const{graphics:t,view:e}=this;this.addHandles([t.on("change",()=>this._refreshManipulators()),G(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new he({view:e}):L(this._tooltip)},gi)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=L(this._tooltip),this._moveManipulation=L(this._moveManipulation),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){var e;this.handles.removeAll(),(e=this._moveManipulation)==null||e.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(i=>gn(i)===ga.SUPPORTED).map(i=>new ls(i));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(i=>this.view.trackGraphicState(i.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new Mi({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator(n=>this.handles.add([n.events.on("immediate-click",a=>{this.emit("immediate-click",{...a,graphic:i.graphic}),a.stopPropagation()}),n.events.on("grab-changed",({action:a})=>{const{tooltipOptions:o,_tooltip:s}=this;v(s)||(a==="start"?s.info=new le({tooltipOptions:o}):s.clear())})])),this.handles.add(e.manipulationXY.createDragPipeline((n,a,o,s)=>this._buildDragEventPipeline(t,S.XY,n,a,o,s)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new zt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?zt.radiusForSymbol(t[0].graphic.symbol):pt});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(o=>{this.handles.add(o.events.on("immediate-click",s=>{e.zManipulation.hasManipulator(o)||this.graphics.length!==1||this.emit("immediate-click",{...s,graphic:this.graphics.getItemAt(0)}),s.stopPropagation()}))});const i=o=>s=>{this.handles.add(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;v(l)||(r==="focus"?this._updateMoveTooltip(t,o):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.Z));const n=()=>this._updateMoveManipulation(t);for(const o of t)this.handles.add([o.state.on("changed",n),G(()=>o.state.displaying,n)]);const a=t[t.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(e.createDragPipeline((o,s,r,l,p)=>this._buildDragEventPipeline(t,o,s,r,l,p),V(a.graphic),D(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(t){for(const e of t){const i=e.graphic,n=He({view:this.view,graphic:i,forEachManipulator:a=>{var o;(o=e.manipulationXY)==null||o.forEachManipulator(a),this._moveManipulation.forEachManipulator(a)},onManipulatorsChanged:()=>Pt()});v(n)||(e.geometryRepresentation=n.visualElement,e.geometryRepresentation instanceof Ct&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),G(()=>e.state.isDraped,()=>this._updateMoveManipulation(t))]),this.handles.add(n))}}_updateMoveManipulationAngle(t){this._moveManipulation.angle=Oa(t.graphic.geometry)}_updateMoveManipulation(t){var o,s;const e=Pe(0,0,0,this.view.spatialReference);let i=0,n=!1;const a=this._moveManipulation;for(const r of t){if(!r.state.displaying)continue;const l=r.state.graphic;this.enableZ&&Vt(l)&&(n=!0);const p=r.geometryRepresentation instanceof Ct&&!r.state.isDraped?r.geometryRepresentation.attachmentOrigin:ti(this.view,l);if(c(p)){const{x:u,y:g,z:_}=p;e.x+=u,e.y+=g,_&&((o=e.z)!=null||(e.z=0),e.z+=_),i++}}i>0?(e.x/=i,e.y/=i,(s=e.z)!=null||(e.z=0),e.z/=i,a.location=e,a.xyManipulation.available=!0,a.xyAxisManipulation.available=!0,a.zManipulation.available=n):a.available=!1}_buildDragEventPipeline(t,e,i,n,a,o){const s=[],r=[];let l=null,p=null;const u=()=>{for(const g of s)g.dragging=!1;s.length=0,r.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(t.length===1&&e===S.XY){const g=t[0].graphic;({steps:n,cancel:a}=this._buildSnappingPipelineSteps(g,V(g),n,a,o))}return a=a.next(g=>p==null?void 0:p(g)).next(()=>(this.emit("graphic-move-stop",new Ji(r)),this.destroyed||u(),null)),{steps:n=n.next(g=>{var _,M;if(g.action==="start"){s.length=0,r.length=0;for(const f of t)f.dragging||!((_=f.manipulationXY)!=null&&_.hasManipulator(i))&&((M=f.manipulationXY)==null?void 0:M.grabbing)||(s.push(f),r.push(f.graphic),f.dragging=!0);if(r.length!==0&&(this._moveManipulation.interactive=!1,l=_n(r,this.view.state.viewingMode),p=mn(r),this.emit("graphic-move-start",new ss(r)),this.destroyed))return null}return r.length!==0?g:null}).next(g=>l==null?void 0:l(g)).next(g=>(this._updateMoveTooltip(t,e,g),g)).next(g=>{switch(g.action){case"start":case"update":if(g.translationX||g.translationY||g.translationZ){const _=this.view.toScreen(g.mapStart),M=this.view.toScreen(g.mapEnd),f=M.x-_.x,y=M.y-_.y;if(this.emit("graphic-move",new rs(f,y,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Ji(r)),this.destroyed)return null;u()}return null}),cancel:a}}_updateMoveTooltip(t,e,i){const{tooltipOptions:n,_tooltip:a}=this;if(v(a))return;a.clear();const o=t.length===0?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(e){case S.XY:a.info=new le({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,(s,r)=>Mt(s,r,o));break;case S.XY_AXIS:a.info=new yi({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,(s,r)=>{const l=Mt(s,r,o);return Te(l,Ge(i))});break;case S.Z:a.info=new Ce({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,Ae)}}_updateMoveTooltipDistance(t,e,i){if(c(e)&&e.action!=="end"){const{mapStart:n,mapEnd:a}=e,o=i(n,a);t.distance=c(o)?o:se}}_buildSnappingPipelineSteps(t,e,i,n,a){const o=t.geometry;if(v(o)||o.type!=="point"&&o.type!=="mesh")return{steps:i,cancel:n};const s=(o.type==="point"?o:o.anchor).clone(),r=new xe({elevationInfo:e,pointer:a,editGeometryOperations:Ve.fromGeometry(s,this.view.state.viewingMode),visualizer:new ne,excludeFeature:t}),l=this.snappingManager,{snappingStep:p,cancelSnapping:u}=we({snappingContext:r,snappingManager:l,updatingHandles:this.updatingHandles});return n=n.next(u),{steps:i=i.next(g=>(s.z=vn(this.view,s,V(t),{mode:"absolute-height",offset:0}),{...g,snapOrigin:r.coordinateHelper.pointToVector(s)})).next(...p),cancel:n}}get test(){return{tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],ct.prototype,"view",void 0),h([d()],ct.prototype,"graphics",void 0),h([d({constructOnly:!0,nonNullable:!0})],ct.prototype,"enableZ",void 0),h([d({constructOnly:!0,type:Gt})],ct.prototype,"tooltipOptions",void 0),h([d({constructOnly:!0})],ct.prototype,"snappingManager",void 0),h([d()],ct.prototype,"type",void 0),h([d()],ct.prototype,"updating",null),ct=h([X("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],ct);class ls{constructor(e){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Ht({graphic:e})}get graphic(){return this.state.graphic}}function Ki(t,e,i){const n=i.mode==="on-the-ground"?Oi.XY:Oi.XYZ;return new yn(t,n,e,0)}function Qi(t,e,i){const n=z();if(!t.renderCoordsHelper.toRenderCoords(e,n))return null;const a=ta(t,e,pe(i.plane)),o=ta(t,e,i.edgeDirection);if(v(a)||v(o))return null;const s=Ft(z(),a,o);return _a(n,s,_i())}function ta(t,e,i){const n=Pe(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),a=z(),o=z();return t.renderCoordsHelper.toRenderCoords(e,a)&&t.renderCoordsHelper.toRenderCoords(n,o)?ma(o,a,o):null}function ps(t,e,i){const n=pe(t),a=ma(z(),e,i),o=Ft(z(),a,n),s=Ft(z(),a,o);return fn(a[0],a[1],a[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}function hs(t,e,i){const n=i.projectToRenderScreen(t,Ti()),a=i.projectToRenderScreen(e,Ti());return c(n)&&c(a)?Mn(nt(n,n,a)):0}let Ot=class extends ze{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=se,this.area=null,this.totalLength=null}};h([d()],Ot.prototype,"type",void 0),h([d()],Ot.prototype,"distance",void 0),h([d()],Ot.prototype,"area",void 0),h([d()],Ot.prototype,"totalLength",void 0),Ot=h([X("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Ot);let P=class extends Dt.EventedMixin(mi){constructor(t){super(t),this._vertexManipulatorMaterial=yt(m.colorToVec4(m.reshapeManipulators.vertex.color),m.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Kt(m.colorToVec4(m.reshapeManipulators.vertex.outlineColor),m.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Kt(m.colorToVec4(m.reshapeManipulators.vertex.hoverOutlineColor),m.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=yt(m.colorToVec4(m.reshapeManipulators.edge.color),m.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Kt(m.colorToVec4(m.reshapeManipulators.edge.outlineColor),m.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=yt(m.colorToVec4(m.reshapeManipulators.edgeOffset.color),m.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=yt(m.colorToVec4(m.reshapeManipulators.edgeOffset.hoverColor),m.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=yt(m.colorToVec4(m.reshapeManipulators.selected.color),m.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Kt(m.colorToVec4(m.reshapeManipulators.selected.outlineColor),m.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Kt(m.colorToVec4(m.reshapeManipulators.selected.hoverOutlineColor),m.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._manipulatorHandles=new qt,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=$.NONE,this._recreatingManipulators=!1,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new Ht({graphic:t});this._tooltip=new he({view:e}),this.addHandles([G(()=>i.displaying,n=>{for(const a of this._manipulatorInfos)a.manipulator.available=n}),G(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:n,enabled:a,edgeOffsetEnabled:o})=>{c(n)&&(n.visible=a,n.edgeDistance=o?"far":"default")},ft),Bt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),ft),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=L(this._segmentLabels),this._tooltip=L(this._tooltip),this._removeManipulators()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=L(this._moveManipulation),this._graphicMoveManipulation=L(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(v(this._editGeometryOperations))return;const e=V(this.graphic);for(const i of this._editGeometryOperations.data.components){const n=t==null?void 0:t.byComponentIndex.get(i.index);for(const a of i.vertices){const o=n==null?void 0:n.has(a.index);this._createVertexOrEdgeManipulator(a,e,o)}for(const a of i.edges)this._createVertexOrEdgeManipulator(a,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(v(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(v(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(t){const e={byComponentIndex:new Map};if(c(t)&&c(this.inputGeometry)&&bn(t,this.inputGeometry)){for(const i of this._manipulatorInfos)if(i.type==="vertex"&&i.manipulator.selected){const{index:n,component:{index:a}}=i.handle,{byComponentIndex:o}=e,s=o.get(a)||new Set;s.add(n),o.set(a,s)}}this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=L(this._editGeometryOperations),this._segmentLabels=L(this._segmentLabels),v(t)||(this._editGeometryOperations=Ve.fromGeometry(t,this.view.state.viewingMode),this._createManipulators(e),this._segmentLabels=new De({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:V(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled})),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let i=0;const n=[],a=this._manipulatorInfos.some(s=>s.type==="vertex"&&s.manipulator.selected),o=t===kt.SELECTED_OR_ALL&&a;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.grabbing||o&&!s.manipulator.selected||n.push(s),i++);if(n.length===0)return e;if(this._moveVertices(n,e),n.length===i){if(this._updateEventState($.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState($.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((t,e)=>e.type==="vertex"&&e.manipulator.selected?t+1:t,0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState($.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:n}=t;if(!e&&!i&&!n)return;const a=[];for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.selected&&!o.manipulator.grabbing||o===t.info)&&a.push(o);this._moveVertices(a,t,vt.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case $.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case $.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case $.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case $.MOVING:switch(this._reshapeEventState){case $.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case $.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case $.RESHAPING:switch(this._reshapeEventState){case $.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case $.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,i=this._graphicState;if(this._graphicMoveManipulation=new Mi({tool:t,view:e,graphicState:i}),this.enableMoveGraphic){let n=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((a,o,s)=>{o.next(r=>this._trackNumDragging(r)).next(r=>(r.action==="start"&&(n=D(this._editGeometryOperations).createUndoGroup()),r)).next(r=>this._perGraphicManipulatorDragAction(kt.ALL,r)).next(r=>(this._updateTranslateGraphicTooltip(S.XY,r),r)).next(r=>{r.action==="end"&&(this._tooltip.clear(),n=xt(n))}),s.next(()=>this._onDragCancel(!0,()=>n=xt(n)))})),this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!1)))}else this._graphicMoveManipulation.forEachManipulator(n=>{n.grabbable=!1,n.cursor=null});this._graphicMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(n.events.on("immediate-click",a=>{this._manipulatorInfos.some(o=>o.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...a,graphic:this.graphic}),a.stopPropagation()})))}_createMoveManipulation(t){const{graphic:e,handles:i,tool:n,view:a}=this,o=this._graphicState;this._moveManipulation=new zt({tool:n,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Vt(e),snapToScene:!1,radius:zt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(l=>i.add([l.events.on("immediate-click",p=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(u=>u.manipulator.selected)||this.emit("immediate-click",{...p,graphic:e}),p.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const s=l=>p=>{i.add(p.events.on("focus-changed",({action:u})=>{u==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(s(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(s(S.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=D(e.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,p,u,g,_)=>{const{snappingStep:M,cancelSnapping:f}=we({predicate:y=>!!y.info,snappingManager:n.snappingManager,snappingContext:new xe({editGeometryOperations:D(this._editGeometryOperations),elevationInfo:t,pointer:_,excludeFeature:e,visualizer:new ne}),updatingHandles:this.updatingHandles,useZ:!1});return g=g.next(y=>(this._onDragCancel(),y)).next(f),{steps:u=u.next(y=>this._trackNumDragging(y)).next(y=>{const b=this._manipulatorInfos.filter(x=>x.type==="vertex"&&x.manipulator.selected);return y.manipulatorType===A.TRANSLATE_XY&&b.length===1?{...y,info:b[0],snapOrigin:b[0].handle.pos}:y}).next(Ai(this.view,t,e)).next(...M).next(Yt()).next(y=>this._perGraphicManipulatorDragAction(kt.SELECTED_OR_ALL,y)).next(y=>(this._updateTranslateTooltip(l,y),y)),cancel:g}},t,r,e),G(()=>o.displaying,()=>this._updateMoveManipulationPosition(),ft),o.on("changed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),G(()=>o.isDraped,l=>{this._updateMoveManipulationPosition();const p="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),p):i.remove(p)},ft)])}_createVisualElements(){const{graphic:t,view:e}=this,i=He({view:e,graphic:t,forEachManipulator:n=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n);for(const a of this._manipulatorInfos)n(a.manipulator,A.TRANSLATE_XY)}},onManipulatorsChanged:n=>this.on("manipulators-changed",n)});c(i)&&(this._outlineVisualElement=i.visualElement instanceof Ct?i.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=V(this.graphic)){var M,f;const i=m.reshapeManipulators.edgeOffset,n=i.size/2,a=n+i.collisionPadding,o=n/a,s=o*Math.sqrt(3)/2;v(this._edgeOffsetManipulatorGeometryInside)&&(this._edgeOffsetManipulatorGeometryInside=be(this._edgeOffsetManipulatorMaterial,s,o/2,o/2,i.height,i.offset)),v(this._edgeOffsetManipulatorGeometryOutside)&&(this._edgeOffsetManipulatorGeometryOutside=be(this._edgeOffsetManipulatorMaterial,-s,o/2,o/2,i.height,-i.offset));const r=[new w(this._edgeOffsetManipulatorGeometryInside.instantiate(),E.Unfocused),new w(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),E.Focused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate(),E.Unfocused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),E.Focused)],l=new J({view:this.view,renderObjects:r,elevationInfo:e.mode!=="on-the-ground"||Di(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:a,available:!(!this.graphic.visible||!((M=this.graphic.layer)!=null&&M.visible)),collisionType:{type:"disc",direction:Y(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),p=new J({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!((f=this.graphic.layer)!=null&&f.visible)),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),u={manipulator:l,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:p,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const g=[];for(const y of[u.handle.leftVertex,u.handle.rightVertex]){const b=this._getManipulatorInfoFromHandle(y);c(b)&&g.push(b.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(u)))}u.locationUpdateHandle=Z(g),this._manipulatorHandles.add(u.locationUpdateHandle,l),this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!0),this._watchAndUpdateGrabState(p,!0)],l),this._manipulatorHandles.add(at(l,this._createEdgeOffsetPipeline(u,e)),l),this._manipulatorHandles.add(at(p,(y,b,x,I)=>{if(I==="touch")this._createEdgeOffsetPipeline(u,e)(y,b,x);else if(this.enableMoveGraphic){const C=this.graphic,$t=c(C.geometry)?C.geometry.spatialReference:null;b.next(k=>this._trackNumDragging(k)).next(ae(this.view,y.elevationAlignedLocation)).next(ci(this.view,y.elevationAlignedLocation,e,$t,C)).next(Wt()).next(Yt()).next(k=>this._perGraphicManipulatorDragAction(kt.ALL,k)).next(k=>(this._updateTranslateGraphicTooltip(S.XY,k),k)).next(k=>{k.action==="end"&&this._tooltip.clear()}),x.next(()=>this._onDragCancel(!y.metadata.deleting))}}),l);const _=y=>{this._manipulatorInfos.some(b=>b.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...y,graphic:this.graphic}),y.stopPropagation()};return this._manipulatorHandles.add([l.events.on("immediate-click",_),p.events.on("immediate-click",_),l.events.on("focus-changed",({action:y})=>{const b=this._tooltipOptions;if(y==="focus"&&b.enabled){const x=this._tooltip.info=new Ot({tooltipOptions:b});this._updateTooltipAreaOrTotalLength(x)}else this._tooltip.clear()})],l),this._manipulatorInfos.push(u),this.manipulators.add(l),this.manipulators.add(p),this.emit("manipulators-changed"),u}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,n=t.edgeManipulator,a=()=>{t.visibilityHandle=xt(t.visibilityHandle);const o=this._getManipulatorInfoFromHandle(t.handle.leftVertex),s=this._getManipulatorInfoFromHandle(t.handle.rightVertex),r=c(o)&&c(s)&&hs(o.manipulator.renderLocation,s.manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!n.focused||r)&&(i.grabbable=!r,n.grabbable=!r,t.visibilityHandle=Z([i.disableDisplay(),{remove:()=>{i.grabbable=!0,n.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",a),n.events.on("focus-changed",a),{remove:()=>{xt(t.visibilityHandle),n.metadata.deleting=!0,this.manipulators.remove(n)}}],i),a()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=D(this._editGeometryOperations).data,i=Qi(this.view,t.manipulator.elevationAlignedLocation,Ki(e,t.handle,D(t.manipulator.elevationInfo))),n=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(v(n)||v(a))return;const o=n.manipulator.renderLocation,s=a.manipulator.renderLocation,r=c(i)?ps(i,o,s):Sn;t.manipulator.modelTransform=r,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=r;const l=Ee(nt(ve,o,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,n,a)=>{this._clearSelection();const{step:o,cleanup:s}=this._initializeEdgeOffset(t,e);n.next(r=>this._trackNumDragging(r)).next(ae(this.view,i.elevationAlignedLocation)).next(o).next(xn(this.view)).next(wn(this.view,D(this._editGeometryOperations).data.spatialReference)).next(Yt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&s()}),a.next(()=>{i.metadata.deleting||(s(),this._onDragCancel())})}}_initializeEdgeOffset(t,e){const i=D(this._editGeometryOperations),n=Ki(i.data.coordinateHelper,t.handle,e),a=i.createUndoGroup(),o=Qi(this.view,t.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const g=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);c(g)&&this._splitEdgeManipulator(g,1)}if(n.requiresSplitEdgeRight){const g=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);c(g)&&this._splitEdgeManipulator(g,0)}const s=()=>new Dn({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:i.data.spatialReference}),r=new Ct({view:this.view,isDraped:this._graphicState.isDraped,geometry:s(),elevationInfo:t.elevationInfo,width:m.visualElements.lineGraphics.outline.width,color:m.colorToVec4(vi.main),attached:!0});let l;const p=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=xt(l)},u=this.on("undo",p);return l=Z([Tt(r),G(()=>this._graphicState.isDraped,g=>r.isDraped=g),this._graphicState.on("changed",()=>r.geometry=s()),a,u]),{step:g=>v(n)||v(o)?(p(),null):{...g,operation:n,plane:o},cleanup:p}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||v(e.operation))return e;this._updateEventState($.RESHAPING);const{mapDeltaX:i,mapDeltaY:n,mapDeltaZ:a}=e;return(i||n||a)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;return v(e)||v(i)?t:(t.action==="start"&&e.selectArrowFromStartPoint(i),{...t,signedDistance:e.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:n}=t,a=this._tooltip,o=this._tooltipOptions;if(!o.enabled||v(i))return a.clear(),t;let s=a.info;(v(s)||s.type!=="reshape-edge-offset")&&(s=a.info=new Ot({tooltipOptions:o}));const{coordinateHelper:r}=D(this._editGeometryOperations).data;return s.distance=t.action==="end"?se:cs(this._graphicState.isDraped,i*n.selectedArrow,e,n.plane,r),this._updateTooltipAreaOrTotalLength(s),t}}_cleanEdgeOffsetCollapsedEdges(t){var r,l;const e=(r=t.handle.leftVertex.leftEdge)==null?void 0:r.leftVertex,i=t.handle.leftVertex,n=(l=t.handle.rightVertex.rightEdge)==null?void 0:l.rightVertex,a=t.handle.rightVertex,o=D(this._editGeometryOperations).data.coordinateHelper,s=[];if(e&&o.distance(e.pos,i.pos)<Fe){const p=this._getManipulatorInfoFromHandle(i);c(p)&&s.push(p)}if(o.distance(i.pos,a.pos)<Fe||n&&o.distance(n.pos,a.pos)<Fe){const p=this._getManipulatorInfoFromHandle(a);c(p)&&s.push(p)}s.length&&this._removeVertices(s)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=V(this.graphic),i=!1){var r;if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(v(this._vertexManipulatorGeometry)||v(this._vertexManipulatorOutlineGeometry)){const{size:l,outlineSize:p}=this._computeVertexManipulatorSizeAndOutline(m.reshapeManipulators.vertex);this._vertexManipulatorGeometry=ue(this._vertexManipulatorMaterial,l,16,16),this._vertexManipulatorOutlineGeometry=ue(this._vertexManipulatorOutlineMaterial,p,16,16)}if(v(this._edgeManipulatorGeometry)||v(this._edgeManipulatorOutlineGeometry)){const{size:l,outlineSize:p}=this._computeVertexManipulatorSizeAndOutline(m.reshapeManipulators.edge);this._edgeManipulatorGeometry=ue(this._edgeManipulatorMaterial,l,16,16),this._edgeManipulatorOutlineGeometry=ue(this._edgeManipulatorOutlineMaterial,p,16,16)}const n=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[new w(this._vertexManipulatorGeometry.instantiate(),Q.Vertex|E.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate(),Q.Vertex|E.Unfocused|E.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Q.Vertex|E.Focused|E.Unselected),new w(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),E.Selected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),E.Selected|E.Unfocused),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),E.Selected|E.Focused)];this.enableMidpoints&&n.push(new w(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),Q.Edge|E.Focused|E.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Q.Edge|E.Focused|E.Unselected),new w(this._edgeManipulatorGeometry.instantiate(),Q.Edge|E.Unfocused|E.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate(),Q.Edge|E.Unfocused|E.Unselected));const a=new J({view:this.view,renderObjects:n,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!((r=this.graphic.layer)!=null&&r.visible)),metadata:{deleting:!1}});a.selected=i,this._setTypeSpecificManipulatorSettings(a,t,e);const o=t.type==="edge"?{manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(o),this.manipulators.add(a),this._updateManipulatorPosition(o),o.type==="edge"){const l=[];for(const p of[o.handle.leftVertex,o.handle.rightVertex]){const u=this._getManipulatorInfoFromHandle(p);c(u)&&l.push(u.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(o)))}o.locationUpdateHandle=Z(l),this._manipulatorHandles.add(o.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const s=at(a,(l,p,u,g)=>{let _=null;const{snappingStep:M,cancelSnapping:f}=we({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new xe({editGeometryOperations:D(this._editGeometryOperations),elevationInfo:e,pointer:g,excludeFeature:this.graphic,visualizer:new ne}),updatingHandles:this.updatingHandles,useZ:!1});u=u.next(y=>(this._onDragCancel(!l.metadata.deleting,()=>_=xt(_)),y)).next(f),p.next(y=>this._trackNumDragging(y)).next(y=>{if(y.action==="start"&&(_=D(this._editGeometryOperations).createUndoGroup()),o.type==="edge"){const b=this._splitEdgeManipulator(o);return{...y,info:b,snapOrigin:b.handle.pos}}return{...y,info:o,snapOrigin:o.handle.pos}}).next(ae(this.view,l.elevationAlignedLocation)).next(Gn(this.view,this.graphic,l.elevationAlignedLocation,l.location.spatialReference,this.graphic)).next(Ai(this.view,e,this.graphic)).next(...M).next(Yt()).next(y=>{this._perVertexManipulatorDragAction(y),y.action==="end"&&(_=xt(_)),this._updateTranslateVertexTooltip(l,S.XY,y)})});return this._manipulatorHandles.add([s,a.events.on("immediate-click",l=>this._manipulatorClickCallback(l,o)),a.events.on("select-changed",()=>{o.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:l})=>{l==="focus"&&o.type!=="edge"?this._updateTranslateVertexTooltip(a,S.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),o}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null),c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case $.NONE:break;case $.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case $.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState($.NONE)}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=Q.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=m.reshapeManipulators.vertex.size/2+m.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=Q.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=m.reshapeManipulators.edge.size/2+m.reshapeManipulators.edge.collisionPadding,t.elevationInfo=i.mode!=="on-the-ground"||Di(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>this._onGrabStateChanged(t,e,i.action,i.pointerType))}_onGrabStateChanged(t,e,i,n="mouse"){if(!this._recreatingManipulators){if(i==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState($.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(n!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(a=>{a.manipulator.interactive=a.manipulator.grabbing||!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in a&&(a.edgeManipulator.interactive=a.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(a=>{a.interactive=a.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){v(t)||(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),En(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(v(t))return;const e=D(this._editGeometryOperations);if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,ee),t.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex),n=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(v(i)||v(n))return;const a=i.manipulator,o=n.manipulator;if(c(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const s=a.location,r=o.location,l=.5,p=s.x+l*(r.x-s.x),u=s.y+l*(r.y-s.y),g=s.hasZ&&r.hasZ?0:void 0;t.manipulator.location=Pe(p,u,g,e.data.spatialReference)}else On(ve,a.renderLocation,o.renderLocation,.5),t.manipulator.renderLocation=ve}}_splitEdgeManipulator(t,e=.5){const i=D(this._editGeometryOperations),n=D(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle=xt(t.locationUpdateHandle);const a=V(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(t),o=this._createVertexOrEdgeManipulator(n)):(o=t,o.handle=n,o.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,a)),n.leftEdge&&this._createVertexOrEdgeManipulator(n.leftEdge),n.rightEdge&&this._createVertexOrEdgeManipulator(n.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(o),this.enableEdgeOffset||this._updateTranslateVertexTooltip(o.manipulator,S.XY),this._updateSelection(t.manipulator);const s=this._updateEventState($.RESHAPING),r=i.data.coordinateHelper.vectorToArray(o.handle.pos),l=i.data.components.indexOf(n.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:D(n.index)}],added:r}),s&&this._updateEventState($.NONE),o}_updateMoveManipulationPosition(){const t=lt(ve,0,0,0);let e=0,i=!1,n=null,a=null;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.selected?(e++,pi(t,t,o.manipulator.renderLocation),v(n)||o.selectedIndex>n.selectedIndex?(a=n,n=o):(v(a)||o.selectedIndex>a.selectedIndex)&&(a=o)):i=!0);if(e===0){const o=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=o,this._moveManipulation.xyAxisManipulation.available=o,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=o,this._moveManipulation.zManipulation.available=o&&this.enableZShape&&Vt(this.graphic),this._moveManipulation.angle=Oa(D(this.graphic.geometry)),this._moveManipulation.radius=zt.radiusForSymbol(this.graphic.symbol)}else{const o=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=o,this._moveManipulation.xyAxisManipulation.available=o,this._moveManipulation.zManipulation.available=o&&this.enableZVertex&&Vt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=o&&e!==1;let s=0;if(c(n)){const r=n.handle.pos,l=c(a)?a.handle.pos:n.handle.leftEdge&&n.handle.leftEdge.leftVertex?n.handle.leftEdge.leftVertex.pos:null,p=v(a)&&n.handle.rightEdge&&n.handle.rightEdge.rightVertex?n.handle.rightEdge.rightVertex.pos:null;l&&p?this._moveManipulation.xyAxisManipulation.available=!1:l?s=ea(l,r):p&&(s=ea(r,p))}this._moveManipulation.angle=s,this._moveManipulation.radius=Ea}e!==0&&i?(hi(t,t,1/e),ee.spatialReference=D(this._editGeometryOperations).data.spatialReference,ee.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,ee),this._moveManipulation.elevationAlignedLocation=ee):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:va(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){var n;const e=new Array,i=D(this._editGeometryOperations);for(const a of t)if(a.type==="vertex"&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const o=i.removeVertices([a.handle]),s=D((n=o.removedVertices)==null?void 0:n[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(e.length>0){const a=e.map(s=>{const r=i.data.components.indexOf(s.component);return{coordinates:i.data.coordinateHelper.vectorToArray(s.pos),componentIndex:r,vertexIndex:D(s.index)}});this.outputGeometry=i.data.geometry;const o=this._updateEventState($.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(s=>s.coordinates),vertices:a}),this.destroyed)||o&&(this._updateEventState($.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=e.action==="start"?vt.NEW_STEP:vt.ACCUMULATE_STEPS){const n=D(this._editGeometryOperations);n.moveVertices(t.map(a=>a.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=n.data.geometry;for(const a of t)this._updateManipulatorPosition(a)}_offsetEdge(t,e){if(v(e.operation)||v(e.signedDistance))return;const i=D(this._editGeometryOperations),n=e.operation.clone();n.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],n),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Gi.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Gi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter(n=>n.type==="vertex"&&n.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const n=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:this._tooltip.info=new le({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,(a,o)=>Mt(a,o,n));break;case S.XY_AXIS:this._tooltip.info=new yi({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,(a,o)=>{const s=Mt(a,o,n);return Te(s,Ge(e))});break;case S.Z:this._tooltip.info=new Ce({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,Ae)}}_updateTranslateVertexTooltip(t,e,i){const n=this._tooltipOptions;if(!n.enabled)return;let a;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case S.XY:a=new lo({tooltipOptions:n}),this._updateTranslateTooltipDistance(a,i,(r,l)=>Mt(r,l,o)),this._updateTooltipAreaOrTotalLength(a);break;case S.XY_AXIS:a=new ro({tooltipOptions:n}),this._updateTranslateTooltipDistance(a,i,(r,l)=>{const p=Mt(r,l,o);return Te(p,Ge(i))}),this._updateTooltipAreaOrTotalLength(a);break;case S.Z:a=new so({tooltipOptions:n}),this._updateTranslateTooltipDistance(a,i,Ae)}const s=po(t.elevationAlignedLocation);c(s)&&(a.elevation={mode:"absolute-height",...s}),this._tooltip.info=a}_updateTranslateTooltipDistance(t,e,i){if(c(e)&&e.action!=="end"){const{mapStart:n,mapEnd:a}=e,o=i(n,a);t.distance=c(o)?o:se}}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(v(e))return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";t.area=e.type==="polygon"?co(e,i):null,t.totalLength=e.type==="polyline"?to(e,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function ea(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function cs(t,e,i,n,a){if(t){const o=a.toXYZ(a.pointToVector(i)),s=Tn(n,o,R.get()),r=eo(s,o,a.spatialReference);if(c(r))return re(r.value*Math.sign(e),r.unit)}return re(e*ei(i.spatialReference),"meters")}h([d()],P.prototype,"_editGeometryOperations",void 0),h([d()],P.prototype,"_segmentLabels",void 0),h([d({constructOnly:!0})],P.prototype,"tool",void 0),h([d()],P.prototype,"_tooltip",void 0),h([d()],P.prototype,"inputGeometry",null),h([d()],P.prototype,"outputGeometry",void 0),h([d({readOnly:!0})],P.prototype,"updating",null),h([d()],P.prototype,"manipulators",null),h([d()],P.prototype,"view",null),h([d()],P.prototype,"graphic",null),h([d()],P.prototype,"enableZShape",null),h([d()],P.prototype,"enableZVertex",null),h([d()],P.prototype,"enableMoveGraphic",null),h([d()],P.prototype,"enableMidpoints",null),h([d()],P.prototype,"enableEdgeOffset",null),h([d()],P.prototype,"_labelOptions",null),h([d()],P.prototype,"_tooltipOptions",null),P=h([X("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],P);const ee=Pe(0,0,void 0,An.WGS84),ve=z(),Fe=1e-6;var Q,$,kt;(function(t){t.Vertex=mt.Custom1,t.Edge=mt.Custom2})(Q||(Q={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}($||($={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(kt||(kt={}));let N=class extends Dt.EventedMixin(Le){constructor(t){super(t),this._handles=new qt,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new ya,this.tooltipOptions=new Gt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new P({tool:this});this.addHandles([t.on("reshape",e=>{e.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",e)}),t.on("move",e=>{e.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",e)}),t.on("vertex-add",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)}),t.on("vertex-remove",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)}),t.on("immediate-click",e=>this.emit("immediate-click",e)),this.view.on("pointer-down",["Shift"],e=>e.stopPropagation()),G(()=>this.graphic,()=>this._updateGraphic(),gi)]),this.finishToolCreation()}destroy(){this._handles=L(this._handles),this._reshapeOperation=L(this._reshapeOperation)}get updating(){var t,e;return(e=(t=this._reshapeOperation)==null?void 0:t.updating)!=null?e:!1}_updateGeometry(){const t=$n(this.graphic);this._reshapeOperation.inputGeometry=c(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),Rn(this.graphic)!==ga.SUPPORTED)return;const t=G(()=>{var e;return(e=this.graphic)==null?void 0:e.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},Oe);this._handles.add(t,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:t}=this._reshapeOperation;!v(this.graphic)&&t&&this._updateGeometryInternally(t.clone())}get canUndo(){var t;return(t=this._reshapeOperation.canUndo)!=null?t:!1}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.undo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}get canRedo(){var t;return(t=this._reshapeOperation.canRedo)!=null?t:!1}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.redo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([d()],N.prototype,"_reshapeOperation",void 0),h([d({constructOnly:!0,nonNullable:!0})],N.prototype,"view",void 0),h([d({constructOnly:!0})],N.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZShape",void 0),h([d({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZVertex",void 0),h([d({constructOnly:!0,nonNullable:!0})],N.prototype,"enableMoveGraphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],N.prototype,"enableMidpoints",void 0),h([d({constructOnly:!0,nonNullable:!0})],N.prototype,"enableEdgeOffset",void 0),h([d()],N.prototype,"type",void 0),h([d({constructOnly:!0,type:ya})],N.prototype,"labelOptions",void 0),h([d({constructOnly:!0,type:Gt})],N.prototype,"tooltipOptions",void 0),h([d({constructOnly:!0})],N.prototype,"snappingManager",void 0),h([d()],N.prototype,"updating",null),h([d()],N.prototype,"automaticManipulatorSelection",void 0),N=h([X("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],N);let dt=class extends ze{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};h([d()],dt.prototype,"type",void 0),h([d()],dt.prototype,"rotation",void 0),h([d()],dt.prototype,"rotationPrecision",void 0),h([d()],dt.prototype,"orientation",void 0),h([d()],dt.prototype,"orientationPrecision",void 0),h([d()],dt.prototype,"rotationType",void 0),dt=h([X("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],dt);let wt=class extends ze{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};h([d()],wt.prototype,"type",void 0),h([d()],wt.prototype,"scale",void 0),h([d()],wt.prototype,"size",void 0),h([d()],wt.prototype,"sizeUnit",void 0),h([d()],wt.prototype,"sizePrecision",void 0),wt=h([X("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],wt);let W=class extends ze{constructor(t){super(t),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};h([d()],W.prototype,"type",void 0),h([d()],W.prototype,"orientation",void 0),h([d()],W.prototype,"orientationEnabled",void 0),h([d()],W.prototype,"orientationPrecision",void 0),h([d()],W.prototype,"rotationType",void 0),h([d()],W.prototype,"size",void 0),h([d()],W.prototype,"sizeUnit",void 0),h([d()],W.prototype,"sizeEnabled",void 0),h([d()],W.prototype,"sizePrecision",void 0),W=h([X("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],W);var O,jt;(function(t){t.ScaleIn=mt.Custom2,t.ScaleOut=mt.Custom3,t.RotateLeft=mt.Custom4,t.RotateRight=mt.Custom5,t.Unlocked=mt.Custom7,t.DelayedFocused=mt.Custom8,t.TouchInput=mt.Custom12})(O||(O={}));class ds{get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(e){this._ringManipulator.location=e}set elevationAlignedLocation(e){this._ringManipulator.elevationAlignedLocation=e}get grabbing(){return this._ringManipulator.grabbing}set interactive(e){this._ringManipulator.interactive=e}constructor({adapter:e,tooltipOptions:i,mode:n,tool:a}){this._mode=null,this._handles=new qt,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=Ko,this.events=new Dt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this._adapter.scale:1,this.tool=a,this._mode=n,this._adapter=e,this._tooltipOptions=i,this._tooltip=new he({view:a.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(Bt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),ft))}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=L(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=L(this._tooltip)}startAnimation(e){this.cancelActiveAnimation(),e.start();const i=In({update:({deltaTime:n})=>{e.update(n)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:i}}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=L(this._activeAnimation))}forEachManipulator(e){e(this._ringManipulator,A.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const i=this.tool.graphicState.graphic,n=at(e,(a,o,s)=>{this._scaleRotateDragData=null;const r=this._adapter.startInteraction(),l={mode:"none",origin:fa(a.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const p=R.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,p),o.next(ii(this.tool.view,_a(a.renderLocation,p,_i()))).next(u=>{const g=pe(u.plane),_=Ma(u.renderStart,u.renderEnd,l.origin,g),M=Pn.shortestSignedDiff(l.angle,_);l.angleDir=Qe(l.angleDir+M,-ji,ji),l.angle=_;const f=us(l,u),y=f-this._adapter.scale;if(l.scaleDir=Qe(l.scaleDir+y,-Bi,Bi),this._onScaleChanged(),l.mode==="none"){const b=this._mode||gs(u,u.plane,l.origin,this.tool.view.state.camera);if(c(b)){switch(b){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=b}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+_;break;case"scale":r.state.scale=f,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),u.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:oe(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:f,yScale:f})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:oe(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:f,yScale:f})}}return u.action==="end"&&(this.startAnimation(ia(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),r.done()),u}).next(this._updateTooltipPipelineStep(l)),s.next(()=>{if(r.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(ia(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([n,e.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(_s(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),e.events.on("immediate-click",a=>{a.stopPropagation()}),G(()=>{var a;return(a=this.tool.graphicState)==null?void 0:a.displaying},a=>this._ringManipulator.available=a,ft)])}_updateTooltipPipelineStep(e){return i=>{const n=this._tooltipOptions;if(!n.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const a=this._tooltip,o=this._tooltipOptions.visualVariables,s=c(o)?o.size:null,r=c(o)?o.rotation:null;switch(e.mode){case"scale":a.info=new wt({tooltipOptions:n,scale:{value:this._adapter.scale},size:re(et(this._adapter.size,-1),"meters"),sizeUnit:c(s)?s.unit:null,sizePrecision:c(s)?fe(s.valueType):null});break;case"rotate":{const l=c(r)?fe(r.valueType):null,p=c(r)?r.rotationType:"geographic";a.info=new dt({tooltipOptions:n,rotation:Ze(et(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:Ze(-this._adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:p})}}return i}}_updateFocusTooltip(){if(!!this._tooltipOptions.enabled)if(this.getFocused()){const e=this._tooltipOptions.visualVariables,i=c(e)?e.rotation:null,n=c(e)?e.size:null;this._tooltip.info=new W({tooltipOptions:this._tooltipOptions,orientation:Ze(-this._adapter.angle,"radians","geographic"),orientationEnabled:this._mode==null||this._mode==="rotate",orientationPrecision:c(i)?fe(i.valueType):null,rotationType:c(i)?i.rotationType:"geographic",size:re(et(this._adapter.size,-1),"meters"),sizeUnit:c(n)?n.unit:null,sizeEnabled:this._mode==null||this._mode==="scale",sizePrecision:c(n)?fe(n.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(O.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(O.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut,!1),this._ringManipulator.updateStateEnabled(O.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(O.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(O.RotateLeft|O.RotateRight,!1),this._ringManipulator.updateStateEnabled(O.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(O.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut|O.RotateLeft|O.RotateRight,!1)}_updateManipulatorTransform(){const e=la(q.get(),this._adapter.angle,Y(0,0,1));if(v(e))return;const i=this.getScale(),n=Se(q.get(),lt(R.get(),i,i,i));this._ringManipulator.modelTransform=Me(q.get(),n,e)}_createRingManipulator(){const e=(T,ot,st)=>{const bt=[],St=Math.ceil(xa*(ot-T)/(2*Math.PI));for(let H=0;H<St+1;H++){const Jt=T+H*(ot-T)/St;bt.push(Y(st*Math.cos(Jt),st*Math.sin(Jt),0))}return bt},i=T=>e(0,2*Math.PI,T),n=T=>[[-T/2,0],[T/2,0],[T/2,Ye/2],[-T/2,Ye/2]],a=this._createMaterial(1),o=(T,ot,st=a)=>Vn(st,n(ot),T,[],[],!1),s=i(Lt),r=o(s,ke),l={left:new Array,right:new Array},p=[];for(let T=0;T<2;T++){const ot=T*Math.PI-Math.PI/4,st=Math.PI/2-Wo,bt=ot+st,St=ot+Math.PI/2-st,H=e(bt,St,Bo),Jt=o(H,Xt);p.push(H),p.push(e(bt,St,Xi-ke/2)),l.left.push(Jt),l.right.push(Jt.instantiate());for(let Ue=0;Ue<2;Ue++){const bi=Ue===0,F=Ie();if(bi){da(F,F,[1,-1,1]),$i(F,F,-bt,[0,0,1]);const Rt=Math.round(Yi*(H.length-1));F[12]=H[Rt][0],F[13]=H[Rt][1],F[14]=H[Rt][2]}else{$i(F,F,St,[0,0,1]);const Rt=Math.round((1-Yi)*(H.length-1));F[12]=H[Rt][0],F[13]=H[Rt][1],F[14]=H[Rt][2]}const Si=be(a,jo,0,qo,Ye);ra(Si,F),(bi?l.left:l.right).push(Si)}}const u=[];for(let T=0;T<2;T++){const ot=T*Math.PI-Math.PI/4,st=Math.PI/2-Jo,bt=ot+st,St=ot+Math.PI/2-st,H=e(bt,St,Xi);u.push(o(H,Xt))}const g=this._createMaterial(.66),_=this._createMaterial(.5),M=this._createMaterial(.33),f=i(Lt+ki),y=i(Lt+Fi),b=o(f,Xt,g),x=o(y,Xt,M),I=i(Lt-ki),C=i(Lt-Fi),$t=o(I,Xt,g),k=o(C,Xt,M);let ht=[new w(r,O.DelayedFocused),new w(r.instantiate({material:_}),E.None)];this._mode&&this._mode!=="scale"||(ht=ht.concat([...u.map(T=>new w(T,O.DelayedFocused|O.Unlocked)),new w(b,O.DelayedFocused|O.ScaleIn),new w(x,O.DelayedFocused|O.ScaleIn),new w($t,O.DelayedFocused|O.ScaleOut),new w(k,O.DelayedFocused|O.ScaleOut)])),this._mode&&this._mode!=="rotate"||(ht=ht.concat([...l.right.map(T=>new w(T.instantiate(),O.DelayedFocused|O.Unlocked)),...l.left.map(T=>new w(T,O.DelayedFocused|O.RotateLeft)),...l.right.map(T=>new w(T,O.DelayedFocused|O.RotateRight))]));const de=[s,...p];return new J({view:this.tool.view,renderObjects:ht,autoScaleRenderObjects:!1,worldOriented:!0,radius:ke,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:V(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:de,direction:Y(0,0,1)}})}_createMaterial(e){const i=Ln([...Zo,e]);return new di({color:i,transparent:e!==1,cullFace:ui.Back,renderOccluded:At.Transparent})}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:e=>this._ringIndicatorDelayMs=e,tooltip:this._tooltip}}}function us(t,e){const i=nt(R.get(),e.renderStart,t.origin),n=nt(R.get(),e.renderEnd,t.origin),a=Ee(i),o=Ee(n);return a===0?0:o/a}function gs(t,e,i,n){const{renderStart:a,renderEnd:o}=t,s=ye(a,n,R.get()),r=ye(o,n,R.get());if(zn(s,r)<Zi*Zi)return null;const l=nt(R.get(),a,i),p=Ft(R.get(),l,pe(e)),u=a,g=pi(R.get(),u,p),_=ye(i,n,R.get()),M=s,f=ye(g,n,R.get()),y=nt(R.get(),f,M),b=nt(R.get(),s,_),x=Ri(M,y),I=Ri(_,b);return Ii(x,r)<Ii(I,r)?"rotate":"scale"}function ye(t,e,i){return e.projectToScreen(t,Be),lt(i,Be[0],Be[1],0)}function ia(t,e){let i=null,n=1;const a=()=>n;return{start:()=>{n=t.getScale(),i=t.getScale,t.getScale=a,e()},update:o=>(n+=((n+1)/2-n)*Math.min(o*Qo,1),e(),Math.abs(n-1)<.01?jt.STOP:jt.CONTINUE),destroy:()=>{i&&(t.getScale=i),e()}}}function _s(t,e,i){let n=0,a=null;const o=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=o,n=0,e()},update:s=>(n+=s,!(a!=null&&a())||n>=i.delayMs?jt.STOP:jt.CONTINUE),destroy:()=>{a&&(t.getFocused=a),e()}}}function fe(t){switch(t){case"integer":case"long":return 0;default:return null}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(jt||(jt={}));const Be=$e();function Ta(t){return c(t.geometry)&&t.geometry.type==="mesh"?ms(t.geometry):vs(t)}function ms(t){return c(t.transform)?ys(t,t.transform):fs(t)}function vs(t){let e=t.geometry,i=Cn;return{undo(n){i=n.geometry,n.geometry=e},redo(n){e=n.geometry,n.geometry=i}}}function ys(t,e){let i=e.clone(),n=null;return{undo:a=>{n=c(t.transform)?t.transform.clone():null,t.transform=i,a.notifyGeometryChanged()},redo:a=>{i=c(t.transform)?t.transform.clone():null,t.transform=n,a.notifyGeometryChanged()}}}function fs(t){let e,i=t.vertexAttributes.clonePositional();return{undo:n=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,n.notifyGeometryChanged()},redo:n=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,n.notifyGeometryChanged()}}}let ut=class extends mi{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([Bt(()=>c(this._interactionState)&&this._interactionState.angle!==this._interactionState.previousAngle?{interactionState:this._interactionState,angle:this._interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},Oe),Bt(()=>c(this._interactionState)&&this._interactionState.scale!==this._interactionState.previousScale?{interactionState:this._interactionState,scale:this._interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},Oe)])}get angle(){const t=this.geometry.transform;if(v(t))return 0;const e=Hn(t.rotation)[2];return Math.abs(e)>.999999?Re(Nn(t.rotation))*Math.sign(e):0}get scale(){return c(this._interactionState)?this._interactionState.scale:1}startInteraction(){const t=new gt({angle:this.angle});this._interactionState=t;const e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return Ta(this.graphic)}_updateMeshRotation(t){const e=this.geometry.anchor,i=this.viewingMode===ai.Global,{angle:n,previousAngle:a}=t;this.geometry.rotate(0,0,oe(n-a),{origin:e,geographic:i}),t.previousAngle=n,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const e=this.geometry.anchor,i=this.viewingMode===ai.Global,{scale:n,previousScale:a}=t;this.geometry.scale(n/a,{origin:e,geographic:i}),t.previousScale=n,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};h([d({constructOnly:!0})],ut.prototype,"graphic",void 0),h([d({constructOnly:!0})],ut.prototype,"geometry",void 0),h([d({constructOnly:!0})],ut.prototype,"viewingMode",void 0),h([d()],ut.prototype,"angle",null),h([d()],ut.prototype,"scale",null),h([d()],ut.prototype,"_interactionState",void 0),ut=h([X("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],ut);let gt=class extends oi{get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};h([d()],gt.prototype,"angle",void 0),h([d()],gt.prototype,"initialAngle",void 0),h([d()],gt.prototype,"previousAngle",void 0),h([d()],gt.prototype,"previousScale",void 0),h([d()],gt.prototype,"scale",void 0),h([d()],gt.prototype,"state",null),gt=h([X("InteractionState")],gt);let U=class extends mi{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Bt(()=>c(this._interactionState)?this._interactionState.state:null,t=>{this._updateSymbol(t)},Oe))}get angle(){var t;return c(this._interactionState)?this._interactionState.angle:c(this._orientationReferenceSymbolLayer)?Ms((t=this._orientationReferenceSymbolLayer.heading)!=null?t:0):0}get scale(){return c(this._interactionState)?this._interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return c(this._interactionState)?this._interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(v(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(v(e)||v(i)||i.type!=="point-3d")return null;const n=e.getSymbolLayerSize(i,t);if("size"in n&&c(n.size))return n.size;const a=this.sizeAxis;return"width"in n&&c(n.width)&&(v(a)||a==="width"||a==="all"||a==="width-and-depth")?n.width:"depth"in n&&c(t.depth)&&(v(a)||a==="depth"||a==="all"||a==="width-and-depth")?n.depth:"height"in n&&c(t.height)&&(v(a)||a==="height"||a==="all")?n.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return v(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return v(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&c(e.heading))}get _graphicSymbol(){return c(this.graphic)&&c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(c(this._interactionState)||v(t)||v(e))return bs;const i=t.symbolLayers.map(r=>r.type==="object"?e.getSymbolLayerSize(t,r):null).toArray(),n=t.clone(),a=this.angle,o=new _t({originalSymbol:n,angle:a,initialSizes:i});this._interactionState=o;const s=()=>{this._interactionState=null};return{state:o,done:s,cancel:()=>{this._graphicSymbol=n,s()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:n}){const a=this._graphicSymbol;if(v(a)||a.type!=="point-3d")return;const o=a.clone(),s=-oe(e-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,o,(l,p,u)=>{const g=et(l.heading,0)+s;p.heading!==g&&(p.heading=g,r=!0);const _=n[u];if(c(_)&&"width"in _){_.width=this.sizeFilter(_.width),_.height=this.sizeFilter(_.height),_.depth=this.sizeFilter(_.depth);const M=_.width*t;p.width!==M&&(p.width=M,r=!0);const f=_.depth*t;p.depth!==f&&(p.depth=f,r=!0);const y=_.height*t;p.height!==y&&(p.height=y,r=!0)}}),r&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((n,a)=>{const o=e.symbolLayers.getItemAt(a);n.type==="object"&&o.type==="object"&&i(n,o,a)})}};function Ms(t){return-Re(t)}h([d()],U.prototype,"angle",null),h([d()],U.prototype,"scale",null),h([d()],U.prototype,"relativeAngle",null),h([d()],U.prototype,"initialAngle",null),h([d()],U.prototype,"size",null),h([d()],U.prototype,"sizeAxis",void 0),h([d({constructOnly:!0})],U.prototype,"graphic",void 0),h([d()],U.prototype,"_interactionState",void 0),h([d({constructOnly:!0})],U.prototype,"findLayerView",void 0),h([d({constructOnly:!0})],U.prototype,"sizeFilter",void 0),h([d()],U.prototype,"_sizeReferenceSymbolLayer",null),h([d()],U.prototype,"_orientationReferenceSymbolLayer",null),h([d()],U.prototype,"_graphicSymbol",null),U=h([X("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],U);const bs={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let _t=class extends oi{get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:n,initialSizes:a}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:n,initialSizes:a}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}};h([d()],_t.prototype,"originalSymbol",void 0),h([d()],_t.prototype,"angle",void 0),h([d()],_t.prototype,"initialAngle",void 0),h([d()],_t.prototype,"initialSizes",void 0),h([d()],_t.prototype,"scale",void 0),h([d()],_t.prototype,"state",null),_t=h([X("InteractionState")],_t);let B=class extends ua(Dt.EventedMixin(Le)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Gt,this.type="transform-3d",this._scaleRotate=null,this._tooltip=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new Ht({graphic:t}),this.addHandles(G(()=>this.tooltipOptions.enabled,o=>{this._tooltip=o?new he({view:e}):L(this._tooltip)},gi)),this._moveManipulation=new zt({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Vt(t),radius:zt.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(o=>this.handles.add(o.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:t}),s.stopPropagation()})));const i=o=>s=>{this.handles.add(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;v(l)||(r==="focus"?this._updateMoveTooltip(o):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.Z));const n=V(t);this._moveManipulation.elevationInfo=n;const a=t.geometry;if(this._moveManipulation.createGraphicDragPipeline((o,s,r,l,p)=>{if(c(a)&&o===S.XY){const{snappingStep:u,cancelSnapping:g}=we({snappingContext:new xe({elevationInfo:n,pointer:p,editGeometryOperations:Ve.fromGeometry(new Un({spatialReference:a.spatialReference}),e.state.viewingMode),visualizer:new ne,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,useZ:!1});l=l.next(g),r=r.next(Xn(this.view,n)).next(...u)}return{steps:r=r.next(u=>(this._updateMoveTooltip(o,u),u)),cancel:l}},this.graphicState,o=>{const{action:s,graphic:r,dxScreen:l,dyScreen:p}=o,u={graphic:r,dxScreen:l,dyScreen:p};switch(s){case"start":this.emit("graphic-translate-start",u),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",u);break;case"end":this.emit("graphic-translate-stop",u)}}),this._moveManipulation.angle=c(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(G(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const o=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new ds({tool:this,mode:o,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([He({view:this.view,graphic:this.graphic,forEachManipulator:o=>this._forEachManipulator(o),onManipulatorsChanged:()=>Pt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),G(()=>e.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(o=>{o instanceof J&&this.handles.add(o.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=L(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=L(this._scaleRotate),this._scaleRotateAdapter=L(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){v(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new ut({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new U({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer),sizeAxis:c(this.tooltipOptions.visualVariables)&&c(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),c(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return G(()=>this.graphicState.displaying,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&Vt(this.graphic)})}_createGeometryUndoRecord(){return Ta(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,c(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,c(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){c(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(v(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===ai.Local||this.view.scale<ts?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){va(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,e){const{tooltipOptions:i,_tooltip:n}=this;if(v(n))return;n.clear();const a=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:n.info=new le({tooltipOptions:i}),this._updateMoveTooltipDistance(n.info,e,(o,s)=>Mt(o,s,a));break;case S.XY_AXIS:n.info=new yi({tooltipOptions:i}),this._updateMoveTooltipDistance(n.info,e,(o,s)=>{const r=Mt(o,s,a);return Te(r,Ge(e))});break;case S.Z:n.info=new Ce({tooltipOptions:i}),this._updateMoveTooltipDistance(n.info,e,Ae)}}_updateMoveTooltipDistance(t,e,i){if(c(e)&&e.action!=="end"){const{mapStart:n,mapEnd:a}=e,o=i(n,a);t.distance=c(o)?o:se}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>c(this._scaleRotate)?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"enableZ",void 0),h([d()],B.prototype,"enableRotation",void 0),h([d()],B.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:Gt})],B.prototype,"tooltipOptions",void 0),h([d()],B.prototype,"graphicState",void 0),h([d({value:!1})],B.prototype,"snapToScene",null),h([d({constructOnly:!0})],B.prototype,"snappingManager",void 0),h([d({readOnly:!0})],B.prototype,"type",void 0),h([d({readOnly:!0})],B.prototype,"updating",null),B=h([X("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],B);class Ss{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this._lastDragEvent)&&c(this._next)){const i={...this._lastDragEvent,action:"update"};e&&this._adjustScaleFactors(i),this._next.execute(i)}this._enabled=e}createDragEventPipelineStep(){this._lastDragEvent=null;const e=new ha;return this._next=e,[i=>(this._lastDragEvent=i.action!=="end"?{...i}:null,this._enabled&&this._adjustScaleFactors(i),i),e]}_adjustScaleFactors(e){const i=ba(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-i:i,e.factor2=e.factor2<0?-i:i}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}let j=class extends Dt.EventedMixin(Le){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Gt,this._preserveAspectRatio=new Ss,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this._handles=new qt,this._attachmentOrigin=null,this._outlineVisualElement=null,this._mapBounds=ge(),this._mapBoundsStart=ge(),this._zmax=0,this._sizeStart=null,this._displayBounds=ge(),this._displayBoundsStart=ge(),this._displayBoundsMarginStart=0,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=ie(),this._endScale=ie()}initialize(){const{view:t,graphic:e,manipulators:i,_handles:n}=this,a=this._graphicState=new Ht({graphic:e}),o=e.geometry;this._editGeometryOperations=Ve.fromGeometry(o,t.state.viewingMode),this._graphicMoveManipulation=new Mi({tool:this,view:t,graphicState:a}),this._moveZManipulator=uo(t,go.CENTER_ON_CALLOUT),this._moveZManipulator.state|=_o,n.add([this._createMoveXYGraphicDragPipeline(),G(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._moveZManipulator,A.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this._moveZManipulator),this._resizeManipulators=this._resizeHandles.map(u=>{const g=mo(t,u);return n.add([G(()=>this.enableScaling,()=>this._updateManipulatorAvailability(g,A.SCALE)),g.events.on("grab-changed",_=>this._onResizeGrab(_)),this._createResizeDragPipeline(g,u)]),g}),i.addMany(this._resizeManipulators),this._rotateManipulatorTexture=wo(t.toolViewManager.textures),this._rotateManipulator=Zn(t,{texture:this._rotateManipulatorTexture.texture}),n.add([G(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._rotateManipulator,A.ROTATE)),this._rotateManipulator.events.on("grab-changed",u=>{this._onRotateGrab(u)}),this._createRotateDragPipeline(this._rotateManipulator)]),i.add(this._rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const s=He({view:t,graphic:e,forEachManipulator:u=>this._forEachManipulator(u),onManipulatorsChanged:()=>Pt()});c(s)&&(this._outlineVisualElement=s.visualElement instanceof Ct?s.visualElement:null),c(this._outlineVisualElement)&&n.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),n.add(s),n.add([a.on("changed",()=>this._onGeometryChanged()),G(()=>a.displaying,()=>this._updateAllManipulatorAvailability()),G(()=>a.isDraped,()=>this._graphicDrapedChanged(),ft),t.trackGraphicState(a)]);const r=t.pointsOfInterest;n.add(G(()=>r==null?void 0:r.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=u=>{n.add(u.events.on("grab-changed",()=>{this.grabbing=u.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const p=(u,g)=>{n.add(u.events.on("immediate-click",_=>{g===A.TRANSLATE_XY&&this.emit("immediate-click",{..._,graphic:e}),_.stopPropagation()}))};this._forEachManipulator(p),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._mapBounds=null,this._displayBounds=null,this._rotateManipulatorTexture.release(),this._handles.destroy(),this._graphicMoveManipulation.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{_handles:t,view:e}=this,i=this._tooltip=new he({view:e}),n=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",n),this.on("graphic-translate",n),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",a=>{this._startAngle=a.angle,n()}),this.on("graphic-rotate",a=>{this._endAngle=a.angle,n()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,n()}),this.on("graphic-scale-start",a=>{Et(this._startScale,a.xScale,a.yScale),Et(this._endScale,a.xScale,a.yScale),n()}),this.on("graphic-scale",a=>{Et(this._endScale,a.xScale,a.yScale),n()}),this.on("graphic-scale-stop",()=>{Et(this._startScale,0,0),Et(this._endScale,0,0),n()})]),this._forEachManipulator(a=>{t.add([a.events.on("focus-changed",n),a.events.on("grab-changed",n),a.events.on("drag",o=>{o.action==="cancel"?this._tooltip.clear():n()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._graphicMoveManipulation.grabbing||this._graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this._moveZManipulator.focused?this._computeMoveZTooltipInfo():this._rotateManipulator.focused?this._computeRotateTooltipInfo():this._resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=et(this._moveXYTooltipInfo,()=>new le({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo=et(this._moveZTooltipInfo,()=>new Ce({tooltipOptions:this.tooltipOptions})),e=this._moveUnit;if(this._moveZManipulator.dragging){const i=this._mapBoundsStart.origin,n=this._mapBounds.origin,a=ho(i,n,this.view.spatialReference);if(v(a))return null;t.distance=a}else t.distance=re(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo=et(this._rotateTooltipInfo,()=>new Eo({tooltipOptions:this.tooltipOptions}));return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(v(t))return null;const e=this._scaleTooltipInfo=et(this._scaleTooltipInfo,()=>new Oo({tooltipOptions:this.tooltipOptions})),i=zi(this._mapBounds,this._zmax,t.spatialReference,this._graphicState.isDraped);return v(i)?null:(e.xSize=i[0],e.ySize=i[1],c(this._sizeStart)&&this._resizeManipulators.some(n=>n.dragging)?(e.xScale=i[0].value/this._sizeStart[0].value,e.yScale=i[1].value/this._sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this._handles.remove(aa),this._updateDisplayBounds(),this._graphicState.isDraped&&this._handles.add(this.view.elevationProvider.on("elevation-change",t=>{c(this._attachmentOrigin)&&sa(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._updateDisplayBounds()}),aa)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof J){const n=this._graphicState.displaying,a=this.enableZ&&Vt(this.graphic);switch(e){case A.ROTATE:t.available=n&&this.enableRotation;break;case A.SCALE:t.available=n&&(this.enableScaling||this.enableRotation||a),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?vo:yo;break;case A.TRANSLATE_Z:t.available=n&&a;break;default:t.available=n}}}_forEachManipulator(t){this._graphicMoveManipulation.forEachManipulator(t),this._resizeManipulators.forEach(e=>t(e,A.SCALE)),t(this._rotateManipulator,A.ROTATE),t(this._moveZManipulator,A.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return et(Yn(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this._editGeometryOperations.data,i=e.components[0].edges[0],n=kn(Fn.get(),i.leftVertex.pos,i.rightVertex.pos);je(n,n);const a=et(ti(this.view,this.graphic),()=>{var l;return(l=t.extent)==null?void 0:l.center});let o=a?ws*this.view.pixelSizeAt(a):0;const s=this.view.spatialReference,r=t.spatialReference;s.equals(r)||(o*=ei(s)/ei(r)),no(n,e,o,this._mapBounds),this._updateZMax()}_updateZMax(){var n;const t=this._editGeometryOperations.data;if(!t.geometry.hasZ)return void(this._zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const o of a.vertices){const s=(n=e.getZ(o.pos))!=null?n:0;i=Math.max(s,i)}this._zmax=i}_updateDisplayBounds(){const{geometry:t}=this.graphic;if(v(t))return;const{extent:e}=t;if(!e)return;const i=c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._outlineVisualElement.attachmentOrigin:ti(this.view,this.graphic);this._attachmentOrigin=et(i,e.center);const n=c(i)?i.z:ri(this._mapBounds.origin,this.view.elevationProvider,li.fromElevationInfo(V(this.graphic)),this.view.renderCoordsHelper),a=Qt(this._mapBounds);a.origin[2]=n!=null?n:0,oo(a,this.view.renderCoordsHelper,t.spatialReference,this._displayBoundsMargin,this._displayBounds),this._updateManipulators()}get _displayBoundsMargin(){var i;const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:(i=this._editGeometryOperations.data.geometry.extent)==null?void 0:i.center;return e?xs*this.view.pixelSizeAt(e):0}_createMoveXYGraphicDragPipeline(){return this._graphicMoveManipulation.createDragPipeline((t,e,i)=>this._applyGraphicMoveSteps(e,i,S.XY))}_createMoveZDragPipeline(){const t=this.view,e=this._editGeometryOperations.data.spatialReference;return at(this._moveZManipulator,(i,n,a)=>{const o=fa(i.renderLocation),s=n.next(ca(t,o,e)).next(Wt());this._applyGraphicMoveSteps(s,a,S.Z)})}_applyGraphicMoveSteps(t,e,i){const n=t.next(a=>(a.action==="start"&&(this.inputState={type:"move"},this._updateOperationStartProperties(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY})),a)).next(Yt()).next(this._moveDragUpdateGeometry()).next(a=>{var s,r;const o={graphic:this.graphic,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY};switch(a.action){case"start":case"update":(a.mapEnd.x-a.mapStart.x||a.mapEnd.y-a.mapStart.y||((s=a.mapEnd.z)!=null?s:0)-((r=a.mapStart.z)!=null?r:0))&&this.emit("graphic-translate",o);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",o)}return a}).next(a=>this._updateMoveTooltip(a,i));return e.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),n}_updateOperationStartProperties(){Qt(this._displayBounds,this._displayBoundsStart),Qt(this._mapBounds,this._mapBoundsStart),v(this.graphic.geometry)?this._sizeStart=null:this._sizeStart=zi(this._mapBoundsStart,this._zmax,this.graphic.geometry.spatialReference,this._graphicState.isDraped)}_moveDragUpdateGeometry(){return t=>{if(v(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const a of this._editGeometryOperations.data.components)e.push(...a.vertices);const i=t.action==="start"?vt.NEW_STEP:vt.ACCUMULATE_STEPS,n=this._editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return me(n,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===S.XY||e===S.XY_AXIS){const i=Mt(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");c(i)&&c(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return t}_onResizeGrab({action:t,screenPoint:e}){if(t!=="start"||!e)return;const i=this._calculatePickRay(e);Li(this._displayBounds.plane,i,R.get())&&(this._updateOperationStartProperties(),this._displayBoundsMarginStart=this._displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return at(t,(i,n,a)=>{v(this.inputState)||(n.next(o=>(o.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),o)).next(ii(this.view,this._displayBoundsStart.plane)).next(o=>({...o,handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatio.createDragEventPipelineStep()).next(this._resizeDragUpdateGeometry()).next(o=>{const s={graphic:this.graphic,xScale:o.factor1,yScale:o.factor2};switch(o.action){case"start":case"update":this.emit("graphic-scale",s);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",s)}return o}),a.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this._displayBoundsStart,i=t.handle.direction,n=this._displayBoundsMargin,a=this._displayBoundsMarginStart,o=Xe(R.get(),e.origin);_e(o,o,e.basis1,-i[0]),_e(o,o,e.basis2,-i[1]);const s=nt(R.get(),t.renderEnd,o),r=nt(R.get(),t.renderStart,o),l=ba(t.handle),p=Hi(e),u=Hi(this._displayBounds)/p,g=(_,M)=>{if(_===0)return 1;let f=Ee(M),y=.5*_*Ke(M,s)/f;const b=y<0?-1:1;l&&(y+=(f-.5*_*Ke(M,r)/f)*b*u);const x=f<1.5*a?1:na;return f=Math.max(f-a,na),b>0&&(y-=n),b*Math.max(b*(y/f),x)};return{...t,factor1:g(i[0],e.basis1),factor2:g(i[1],e.basis2)}}}_resizeDragUpdateGeometry(){return t=>{const e=Xe(z(),this._mapBoundsStart.origin);_e(e,e,this._mapBoundsStart.basis1,-t.handle.direction[0]),_e(e,e,this._mapBoundsStart.basis2,-t.handle.direction[1]);const i=Et(ie(),this._mapBoundsStart.basis1[0],this._mapBoundsStart.basis1[1]);je(i,i);const n=[];for(const s of this._editGeometryOperations.data.components)n.push(...s.vertices);const a=t.action==="start"?vt.NEW_STEP:vt.ACCUMULATE_STEPS,o=this._editGeometryOperations.scaleVertices(n,e,i,t.factor1,t.factor2,a,Pi.REPLACE);return Qt(this._mapBoundsStart,this._mapBounds),me(o,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_onRotateGrab({action:t,screenPoint:e}){if(t!=="start"||!e)return;const i=fo(this._displayBounds,this.view.renderCoordsHelper,Mo.HEADING,_i()),n=this._calculatePickRay(e);Li(i,n,R.get())&&(this._updateOperationStartProperties(),this.inputState={type:"rotate",rotatePlane:i})}_createRotateDragPipeline(t){return at(t,(e,i,n)=>{const a=this.inputState;v(a)||(i.next(o=>(o.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),o)).next(ii(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next(o=>{const s={graphic:this.graphic,angle:oe(o.rotateAngle)};switch(o.action){case"start":case"update":this.emit("graphic-rotate",s);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",s)}return o}),n.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const i=pe(t.rotatePlane),n=Ma(e.renderStart,e.renderEnd,this._displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:n}}}_rotateDragUpdateGeometry(){return t=>{const e=Xe(z(),this._mapBoundsStart.origin),i=[];for(const o of this._editGeometryOperations.data.components)i.push(...o.vertices);const n=t.action==="start"?vt.NEW_STEP:vt.ACCUMULATE_STEPS,a=this._editGeometryOperations.rotateVertices(i,e,t.rotateAngle,n,Pi.REPLACE);return Qt(this._mapBoundsStart,this._mapBounds),me(a,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=Bn(),i=jn(t);return qn(this.view.state.camera,i,e),Je(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=bo(this._displayBounds,q.get());So(this._rotateManipulator,t,this._displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this._moveZManipulator,t),this._resizeManipulators.forEach((e,i)=>{xo(e,this._resizeHandles[i],t,this._displayBounds)})}_updateZMoveHandle(t,e){const i=this._displayBounds,n={basis:i.basis1,direction:-1,position:nt(R.get(),i.origin,i.basis1),edge:2},a=q.get();Wn(a,e,n.edge*Math.PI/2),a[12]=0,a[13]=0,a[14]=0,t.modelTransform=a,t.renderLocation=n.position}_cancel(){const t=this._editGeometryOperations.lastOperation;v(t)||(this._editGeometryOperations.undo(),this.graphic.geometry=this._editGeometryOperations.data.geometry,Ci(t,this._mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this._editGeometryOperations.undo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Ci(D(t),this._mapBounds),this._updateDisplayBounds()}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this._editGeometryOperations.redo();this.graphic.geometry=this._editGeometryOperations.data.geometry,me(D(t),this._mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this._resizeManipulators,rotateManipulator:this._rotateManipulator,moveZManipulator:this._moveZManipulator,tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"enableZ",void 0),h([d()],j.prototype,"enableRotation",void 0),h([d()],j.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:Gt})],j.prototype,"tooltipOptions",void 0),h([d()],j.prototype,"preserveAspectRatio",null),h([d()],j.prototype,"grabbing",void 0),h([d()],j.prototype,"inputState",void 0),h([d({readOnly:!0})],j.prototype,"type",void 0),h([d()],j.prototype,"_moveUnit",null),j=h([X("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],j);const aa="draped-elevation-changes",xs=10,ws=80,na=1e-6;export{Nt as DrawGraphicTool3D,j as ExtentTransformTool,ct as GraphicMoveTool,N as GraphicReshapeTool,B as GraphicTransformTool};
