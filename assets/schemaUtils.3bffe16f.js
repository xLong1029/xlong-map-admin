var Ve=Object.defineProperty,$e=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var Fe=Object.prototype.hasOwnProperty,Me=Object.prototype.propertyIsEnumerable;var ie=(e,t,i)=>t in e?Ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,f=(e,t)=>{for(var i in t||(t={}))Fe.call(t,i)&&ie(e,i,t[i]);if(te)for(var i of te(t))Me.call(t,i)&&ie(e,i,t[i]);return e},m=(e,t)=>$e(e,Ee(t));import{dW as Ie,cv as K,aW as Te,co as P,d0 as z,bE as J,eK as ne,aX as W,aY as Oe,eU as Re,aZ as ke,eV as se,eW as le,ej as re,bC as G,b5 as H,eX as N,c4 as b,b0 as X,eY as Ne,bI as Ce,eZ as Le}from"./vendor.c8f3cc8c.js";import{A as U,E,q as _e}from"./Utils.b2b84829.js";import{F as Ae,L as F}from"./MaterialKey.56ac52e4.js";import{o as Ke}from"./visualVariablesUtils.9dcd3ad7.js";import{n as Pe,A as Ue,r as je,b as qe,O as Be,t as De}from"./CIMSymbolHelper.05203bfb.js";import{b as Je,s as We,k as Ge}from"./definitions.21e97413.js";import{l as He}from"./cimSymbolUtils.441175f3.js";import{x as Y}from"./MD5.f9440c6b.js";import{e as Xe}from"./util.de314230.js";function Ye(e){if(!e)return U.NONE;let t=0;for(const i of e)if(i.type==="size"){const n=Ke(i);t|=n,i.target==="outline"&&(t|=n<<4)}else i.type==="color"?t|=U.COLOR:i.type==="opacity"?t|=U.OPACITY:i.type==="rotation"&&(t|=U.ROTATION);return t}const Wt=512,Gt=50;function Ht(e,t){if(!t.isWrappable)return null;const[i,n]=Ie(t);return e[2]>n?[K([e[0],e[1],n,e[3]]),K([i,e[1],i+e[2]-n,e[3]])]:e[0]<i?[K([i,e[1],e[2],e[3]]),K([n-(i-e[0]),e[1],n,e[3]])]:null}function Xt(e){return e==="text"||e==="esriTS"}function Yt(e){return e==="simple-marker"||e==="picture-marker"||e==="esriSMS"||e==="esriPMS"}function Zt(e){switch(P(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}function Ze(e,t,i){var n,s,l;if(!i||i.glyphMosaicItems.length===0)return e;const a=Pe(t.text)[1],r=i.glyphMosaicItems,o=Ue(r,a,{scale:z(t.font.size)/Je,angle:(n=t.angle)!=null?n:0,xOffset:(s=t.xoffset)!=null?s:0,yOffset:(l=t.yoffset)!=null?l:0,hAlign:je(t.horizontalAlignment||"center"),vAlign:qe(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:We*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;return e[0]=z(o.x-o.halfWidth),e[1]=z(o.y-o.halfHeight),e[2]=z(o.width),e[3]=z(o.height),e}function Qt(e){if(!e)return null;const{xmin:t,ymin:i,xmax:n,ymax:s,spatialReference:l}=e;return new Te({rings:[[[t,i],[t,s],[n,s],[n,i],[t,i]]],spatialReference:l})}const Qe={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1},et=.707;function ae(e){if(!("visualVariables"in e)||!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const i=t[0];if(i.target==="outline")return 0;if(i.transformationType==="stops")return i.stops.map(n=>n.size).reduce(j,0);if(i.transformationType==="clamped-linear"){let n=-1/0,s=-1/0;return n=typeof i.maxSize=="number"?i.maxSize:i.maxSize.stops.map(l=>l.size).reduce(j,0),s=typeof i.minSize=="number"?i.minSize:i.minSize.stops.map(l=>l.size).reduce(j,0),Math.max(n,s)}return i.transformationType==="real-world-size"?30:void 0}function tt(e){return e.type in Qe}async function ei(e,t,i,n,s,l){if(!e||l&&l.type==="cluster")return 0;if(e.type==="heatmap")return Math.round(3*e.blurRadius);if(e.type==="dot-density")return 0;if(e.type==="dictionary")return t==="esriGeometryPoint"||t==="esriGeometryMultipoint"?100:200;const a=e.getSymbols(),r=ae(e),o=[];for(const c of a)o.push(st(c,r,i,t,n,s));const u=await Promise.all(o);return z(u.reduce(j,0))}const C=[0,0,0,0];function V(e,t){return e==null?t:e}function it(e,t){return e.outline==null?t:V(e.outline.width,t)}const oe={sdf:!0,code:99,metrics:Ge.metrics,rect:new De(0,0,24,24),page:0,textureBinding:2};function nt(e){const t=e.text&&e.text.length;if(!t)return{glyphMosaicItems:[oe]};const i=[];for(let n=0;n<t;n++)i.push(m(f({},oe),{code:e.text.charCodeAt(n)}));return{glyphMosaicItems:i}}async function ue(e,t,i,n,s,l){if(e.type==="simple-marker"){const a=Math.max(V(e.size,12),t);return ce(e)+a*et}if(e.type==="picture-marker"){const a=Math.max(V(e.height,12),t),r=V(e.width,12)*(a/V(e.height,12))/2,o=a/2;return ce(e)+Math.sqrt(r*r+o*o)}if(e.type==="text"){const a=nt(e);Ze(C,e.toJSON(),a);const r=Math.abs(C[0]),o=Math.abs(C[1]),u=C[2],c=C[3];return Math.max(r,o)+Math.max(u,c)}if(e.type==="simple-line"){const a=e,r=Math.max(V(a.width,.75),t)/2;return a.marker?Math.max(6*a.width,2*t):r}if(e.type==="simple-fill"||e.type==="picture-fill")return Math.max(it(e,0),t)/2;if(e.type==="cim"){const a={geometryType:n,fields:s,spatialReference:l},r={type:"cim",rendererKey:0,data:e.data,maxVVSize:t};await He(r,a,i);const o=Be.getEnvelope(e.data,i);return o?Math.sqrt(o.width*o.width+o.height*o.height):0}return e.type==="web-style"?ue(await e.fetchCIMSymbol(),t,i,n,s,l):0}async function st(e,t,i,n,s,l){return tt(e)?Math.min(await ue(e,t,i,n,s,l),75):0}function ce(e){const t=V(e.xoffset,0),i=V(e.yoffset,0);return Math.sqrt(t*t+i*i)}function j(e,t){return Math.max(e,t)}const q=8,de=q-2,lt=J.getLogger("esri.renderers.visualVariables.support.utils"),ti=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),i=t.visualVariables.map(n=>fe(n)?pe(n):n);return t.visualVariables=i,t};function rt(e){return e.map(t=>fe(t)?pe(t.clone()):t)}function fe(e){return(e.type==="size"||e.type==="color"||e.type==="opacity")&&e.stops!=null}function pe(e){return e.stops=ut(e.type,e.stops),e}function O(e,t,i){return(1-i)*e+i*t}function at(e,t){const[i,...n]=t,s=n.pop(),l=n[0].value,a=n[n.length-1].value,r=(a-l)/de,o=[];for(let u=l;u<a;u+=r){let c=0;for(;u>=n[c].value;)c++;const y=n[c],d=t[c-1],g=u-d.value,v=y.value===d.value?1:g/(y.value-d.value);if(e==="color"){const x=n[c],h=t[c-1],p=x.color.clone();p.r=O(h.color.r,p.r,v),p.g=O(h.color.g,p.g,v),p.b=O(h.color.b,p.b,v),p.a=O(h.color.a,p.a,v),o.push({value:u,color:p,label:x.label})}else if(e==="size"){const x=n[c],h=t[c-1],p=ne(x.size),A=O(ne(h.size),p,v);o.push({value:u,size:A,label:x.label})}else{const x=n[c],h=O(t[c-1].opacity,x.opacity,v);o.push({value:u,opacity:h,label:x.label})}}return[i,...o,s]}function ot(e){const[t,...i]=e,n=i.pop();for(;i.length>de;){let s=0,l=0;for(let a=1;a<i.length;a++){const r=i[a-1],o=i[a],u=Math.abs(o.value-r.value);u>l&&(l=u,s=a)}i.splice(s,1)}return[t,...i,n]}function ut(e,t){return t.length<=q?t:(lt.warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${q}. Displayed stops will be simplified.`),t.length>2*q?at(e,t):ot(t))}var Z;let L=Z=class extends se{writeLevels(e,t,i){for(const n in e){const s=this.levels[n];return void(t.stops=s)}}clone(){return new Z({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:le(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:le(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(e=>e.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:re(this.levels)})}};W([Oe()],L.prototype,"levels",void 0),W([Re("levels")],L.prototype,"writeLevels",null),L=Z=W([ke("esri.views.2d.engine.LevelDependentSizeVariable")],L);const me=J.getLogger("esri.views.2d.layers.support.clusterUtils");G.add("esri-cluster-arcade-enabled",!0);const ct=G("esri-cluster-arcade-enabled"),dt=(e,t,i,n)=>{const s=t.clone();if(!yt(s))return s;if(i.fields)for(const l of i.fields)ht(e,l);if("visualVariables"in s){const l=(s.visualVariables||[]).filter(r=>r.valueExpression!=="$view.scale"),a=ft(l);l.forEach(r=>{r.type==="rotation"?r.field?r.field=R(e,r.field,"avg_angle"):r.valueExpression&&(r.field=B(e,r.valueExpression,"avg_angle"),r.valueExpression=null):r.normalizationField?(r.field=R(e,r.field,"norm",r.normalizationField),r.normalizationField=null):r.field?r.field=R(e,r.field,"avg"):(r.field=B(e,r.valueExpression,"avg"),r.valueExpression=null)}),H(a)&&!pt(l)&&(l.push(mt(i,n)),s.dynamicClusterSize=!0),s.visualVariables=l}switch(s.type){case"simple":break;case"unique-value":s.field?s.field=R(e,s.field,"mode"):s.valueExpression&&(s.field=B(e,s.valueExpression,"mode"),s.valueExpression=null);break;case"class-breaks":s.normalizationField?(s.field=R(e,s.field,"norm",s.normalizationField),s.normalizationField=null):s.field?s.field=R(e,s.field,"avg"):(s.field=B(e,s.valueExpression,"avg"),s.valueExpression=null)}return s},ft=e=>{for(const t of e)if(t.type==="size")return t;return null},pt=e=>{for(const t of e)if(t.field==="cluster_count")return!0;return!1},mt=(e,t)=>{const i=[new N({value:0,size:0}),new N({value:1})];if(H(t))return new se({field:"cluster_count",stops:[...i,new N({value:2,size:0})]});const n=Object.keys(t).reduce((s,l)=>m(f({},s),{[l]:[...i,new N({value:Math.max(2,t[l].minValue),size:e.clusterMinSize}),new N({value:Math.max(3,t[l].maxValue),size:e.clusterMaxSize})]}),{});return new L({field:"cluster_count",levels:n})},yt=e=>{const t=i=>me.error(new b("Unsupported-renderer",i,{renderer:e}));if(e.type==="unique-value"){if(e.field2||e.field3)return t("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if(e.type==="class-breaks"){if(e.normalizationField){const i=e.normalizationType;if(i!=="field")return t(`FeatureReductionCluster does not support a normalizationType of ${i}`),!1}}else if(e.type!=="simple")return t(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1;if(!ct){if("valueExpression"in e&&e.valueExpression)return t("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some(i=>!(!("valueExpression"in i)||!i.valueExpression)))return t("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function gt(e,t,i){switch(e){case"avg":case"avg_angle":return`cluster_avg_${t}`;case"mode":return`cluster_type_${t}`;case"norm":{const n=i,s="field",l=t.toLowerCase()+",norm:"+s+","+n.toLowerCase();return"cluster_avg_"+Y(l)}}}function ht(e,t){const{name:i,outStatistic:n}=t,{onStatisticField:s,onStatisticValueExpression:l,statisticType:a}=n;if(l){const r=Y(l.toLowerCase());e.push({name:i,outStatistic:{onStatisticField:r,onStatisticValueExpression:l,statisticType:a}})}else s?e.push({name:i,outStatistic:{onStatisticField:s,statisticType:a}}):me.error(new b("mapview-unsupported-field","Unable to handle field",{field:t}))}function B(e,t,i){const n=Y(t),s=i==="mode"?`cluster_type_${n}`:`cluster_avg_${n}`;return e.some(l=>l.name===s)||e.push({name:s,outStatistic:{onStatisticField:n,onStatisticValueExpression:t,statisticType:i}}),s}function R(e,t,i,n){if(t==="cluster_count"||e.some(l=>l.name===t))return t;const s=gt(i,t,n);return e.some(l=>l.name===s)||(i==="norm"?e.push({name:s,outStatistic:{onStatisticField:t,onStatisticNormalizationField:n,statisticType:i}}):e.push({name:s,outStatistic:{onStatisticField:t,statisticType:i}})),s}const k=J.getLogger("esri.views.2d.layers.features.schemaUtils"),S="ValidationError",bt={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function M(e){return Ae(e)}function ye(e){return e}function I(e){if(e.type==="line-marker"){var t;return{type:"line-marker",color:(t=e.color)==null?void 0:t.toJSON(),placement:e.placement,style:e.style}}return Le(e.toJSON()).toJSON()}function _(e){let t=0,i=0,n=!1,s=!0,l=!0;if(X(e)&&(i=ae(e),"visualVariables"in e&&(t=Ye(e.visualVariables||[]),n=e.type==="dot-density"),!n)){const a=e.getSymbols();"backgroundFillSymbol"in e&&e.backgroundFillSymbol&&a.push(e.backgroundFillSymbol);for(const r of a)if(r.type==="cim"&&(s=!1),r.type==="simple-fill"||r.type==="picture-fill"){const o=r.outline;o&&o.style!=="none"&&o.style!=="solid"&&(l=!1);const u=o&&o.style!=="none"&&o.style!=="solid",c=r.type==="simple-fill"&&r.style!=="none"&&r.style!=="solid";(r.type==="picture-fill"||c||u)&&(s=!1)}}return n&&(l=!1),{vvFlags:t,maxVVSize:i,supportsOutlineFills:l,stride:{fill:n?"dot-density":s?"simple":"default"}}}function Q(e,t,i){return T(e,_(t),i)}function T(e,t,i){if(!e)return null;switch(e.type){case"simple-fill":case"picture-fill":return xt(e,t,i);case"simple-marker":case"picture-marker":return St(e,t,i);case"simple-line":return vt(e,t,i);case"text":return wt(e,t,i);case"label":return Vt(e,t,i);case"cim":return{type:"cim",rendererKey:t.vvFlags,data:e.data,maxVVSize:t.maxVVSize};case"CIMSymbolReference":return{type:"cim",rendererKey:t.vvFlags,data:e,maxVVSize:t.maxVVSize};case"web-style":return m(f({},I(e)),{type:"web-style",hash:e.hash(),rendererKey:t.vvFlags,maxVVSize:t.maxVVSize});default:throw new Error(`symbol not supported ${e.type}`)}}function xt(e,t,i){const n=t.supportsOutlineFills,s=F(E.FILL,m(f({},t),{isOutlinedFill:n})),l=i?M(s):s,a=e.clone(),r=a.outline;t.supportsOutlineFills||(a.outline=null);const o=f({materialKey:l,hash:a.hash(),isOutlinedFill:!!t.supportsOutlineFills},I(a));if(t.supportsOutlineFills)return o;const u=[];if(u.push(o),r){const c=F(E.LINE,m(f({},t),{isOutline:!0})),y=f({materialKey:i?M(c):c,hash:r.hash()},I(r));u.push(y)}return{type:"composite-symbol",layers:u,hash:u.reduce((c,y)=>y.hash+c,"")}}function vt(e,t,i){const n=F(E.LINE,t),s=i?M(n):n,l=e.clone(),a=l.marker;l.marker=null;const r=[];if(r.push(f({materialKey:s,hash:l.hash()},I(l))),a){var o;const u=F(E.MARKER,t),c=i?M(u):u;a.color=(o=a.color)!=null?o:l.color,r.push(f({materialKey:c,hash:a.hash(),lineWidth:l.width},I(a)))}return{type:"composite-symbol",layers:r,hash:r.reduce((u,c)=>c.hash+u,"")}}function St(e,t,i){const n=F(E.MARKER,t),s=i?M(n):n,l=I(e);return m(f({materialKey:s,hash:e.hash()},l),{angle:e.angle,maxVVSize:t.maxVVSize})}function wt(e,t,i){const n=F(E.TEXT,t),s=i?M(n):n,l=I(e);return m(f({materialKey:s,hash:e.hash()},l),{angle:e.angle,maxVVSize:t.maxVVSize})}function zt(e,t){const i=e.labelPlacement,n=bt[t];if(!e.symbol)return k.warn("No ILabelClass symbol specified."),!0;if(!n)return k.error(new b("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${t} is not supported`)),!0;if(!n.some(s=>s===i)){const s=n[0];i&&k.warn(`Found invalid label placement type ${i} for ${t}. Defaulting to ${s}`),e.labelPlacement=s}return!1}function ge(e,t){const i=re(e);return i.some(n=>zt(n,t))?[]:i}function Vt(e,t,i){const n=e.toJSON(),s=F(E.LABEL,m(f({},t),{placement:n.labelPlacement}));return m(f({materialKey:i?M(s):s,hash:e.hash()},n),{labelPlacement:n.labelPlacement})}function $t(e){return G("esri-2d-update-debug")&&console.debug("Created new schema",he(e,!0)),he(e)}function he(e,t=!1){try{var i,n;const s=Mt(e,t),l={};return s.map(a=>Et(l,e,a)),{source:{definitionExpression:e.definitionExpression,fields:e.fields.map(a=>a.toJSON()),gdbVersion:e.gdbVersion,historicMoment:(i=e.historicMoment)==null?void 0:i.getTime(),outFields:e.availableFields,pixelBuffer:e.pixelBuffer,spatialReference:e.spatialReference.toJSON(),timeExtent:(n=e.timeExtent)==null?void 0:n.toJSON(),customParameters:e.customParameters},attributes:{fields:{},indexCount:0},processors:s,targets:l}}catch(s){if(s.fieldName===S)return k.error(s),null;throw s}}function Et(e,t,i){switch(i.target){case"feature":return void ve(e,xe(t),i);case"aggregate":{if(!("featureReduction"in t))return;const n=t.featureReduction;if(n.type==="selection")throw new b(S,"Mapview does not support `selection` reduction type",n);return ve(e,xe(t),i),void Ft(e,n,i)}}}function be(e,t){for(const i in t){const n=t[i];if(n.target!==e.name)continue;const s=e.attributes[i];s?(s.context.mesh=s.context.mesh||n.context.mesh,s.context.storage=s.context.storage||n.context.storage):e.attributes[i]=n}return e}function xe(e){var t,i,n,s,l;return[(t=(i=P(e.filter))==null?void 0:i.toJSON())!=null?t:null,(n=(s=P((l=P(e.featureEffect))==null?void 0:l.filter))==null?void 0:s.toJSON())!=null?n:null]}function ve(e,t,i){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),be(e.feature,i.attributes.fields),e}function Ft(e,t,i){return e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:z(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(z(t.clusterMaxSize)/64),fields:i.aggregateFields}}),be(e.aggregate,i.attributes.fields),e}function w(e,t){return t.field?$(e,m(f({},t),{type:"field",field:t.field})):t.valueExpression?$(e,m(f({},t),{type:"expression",valueExpression:t.valueExpression})):{field:null,fieldIndex:null}}function $(e,t){switch(t.type){case"expression":{const i=ye(t.valueExpression);if(!e.fields[i]){const n=e.indexCount++;e.fields[i]=m(f({},t),{name:i,fieldIndex:n})}return{fieldIndex:e.fields[i].fieldIndex}}case"label-expression":{const i=ye(JSON.stringify(t.label));if(!e.fields[i]){const n=e.indexCount++;e.fields[i]=m(f({},t),{name:i,fieldIndex:n})}return{fieldIndex:e.fields[i].fieldIndex}}case"field":{const i=t.field;return t.target==="aggregate"&&e.fields[i]||(e.fields[i]=m(f({},t),{name:i})),{field:i}}case"statistic":return e.fields[t.name]=f({},t),{field:t.name}}}function Mt(e,t=!1){const i=new Array;let n=0;return i.push(It(e,n++,t)),i}function ee(e,t,i,n,s,l=!1){const a=$(t,{type:"label-expression",target:n,context:{mesh:!0},resultType:"string",label:{labelExpression:i.labelExpression,labelExpressionInfo:i.labelExpressionInfo?{expression:i.labelExpressionInfo.expression}:null,symbol:!!i.symbol,where:i.where}}),{fieldIndex:r}=a;return m(f({},Q(i,e,l)),{fieldIndex:r,target:n,index:s})}function It(e,t,i=!1){const n={indexCount:0,fields:{}},s="featureReduction"in e&&e.featureReduction,l=s?"aggregate":"feature";if("sublayers"in e){const a={type:"subtype",subtypeField:e.subtypeField,renderers:{},stride:{fill:"default"}},r={type:"subtype",mapping:{},target:"feature"},o={type:"subtype",classes:{}},u={type:"symbol",target:"feature",aggregateFields:[],attributes:n,storage:r,mesh:{matcher:a,aggregateMatcher:null,labels:o,sortKey:null}},c=new Set;let y=0;for(const{renderer:d,subtypeCode:g,labelingInfo:v,labelsVisible:x}of e.sublayers){const h=D(n,l,d,i),p=we(n,l,d),A=x&&v;if("visualVariables"in d&&d.visualVariables&&d.visualVariables.length)throw new b(S,"Visual variables are currently not supported for subtype layers");if(h.type==="dictionary")throw new b(S,"Dictionary renderer is not supported in subtype layers");if(h.type==="subtype")throw new b(S,"Nested subtype renderers is not supported");if(X(p)&&p.type==="subtype")throw new b(S,"Nested subtype storage is not supported");if(X(p)&&p.type==="dot-density")throw new b(S,"Dot density attributes are not supported in subtype layers");if(c.has(g))throw new b(S,"Subtype codes for sublayers must be unique");c.add(g),a.renderers[g]=h,r.mapping[g]=p,A&&(o.classes[g]=A.map(ze=>ee(d,n,ze,"feature",y++,i)))}return u}if(e.renderer.type==="heatmap"){const{blurRadius:a,fieldOffset:r,field:o}=e.renderer;return{type:"heatmap",aggregateFields:[],attributes:n,target:l,storage:null,mesh:{blurRadius:a,fieldOffset:r,field:w(n,{target:l,field:o,resultType:"numeric"}).field}}}{const a=[],r=l==="aggregate"?dt(a,e.renderer,s,null):e.renderer;Se(n,a);const o=D(n,l,r,i);let u=null;const c=we(n,l,r),y=Xe(e.geometryType);let d=e.labelsVisible&&e.labelingInfo||[],g=[];if(s){if(s.type==="selection")throw new b(S,"Mapview does not support `selection` reduction type",s);if(s.symbol){const p=new Ne({symbol:s.symbol,visualVariables:"visualVariables"in r?r.visualVariables:null});u=D(n,l,p,i)}g=s&&s.labelsVisible&&s.labelingInfo||[]}d=ge(d,y),g=ge(g,y);let v=0;const x=[...d.map(p=>ee(r,n,p,"feature",v++,i)),...g.map(p=>ee(r,n,p,"aggregate",v++,i))],h=Tt(n,e.orderBy);return{type:"symbol",target:l,attributes:n,aggregateFields:a,storage:c,mesh:{matcher:o,labels:{type:"simple",classes:x},aggregateMatcher:u,sortKey:h}}}}function Tt(e,t){if(H(t)||!t.length)return null;t.length>1&&k.warn(`Layer rendering currently only supports ordering by 1 orderByInfo, but found ${t.length}. All but the first will be discarded`);const i=t[0],n=i.order==="ascending"?"asc":"desc";return i.field?{field:i.field,order:n}:i.valueExpression?{fieldIndex:$(e,{type:"expression",target:"feature",valueExpression:i.valueExpression,resultType:"numeric"}).fieldIndex,order:n}:(k.error(new b(S,"Expected to find a field or valueExpression for OrderByInfo",i)),null)}function Se(e,t){const i={mesh:!0,storage:!0};for(const n of t){const{name:s,outStatistic:l}=n,{statisticType:a,onStatisticField:r}=l;let o=null,u=null,c=null;const y="numeric",d="feature";"onStatisticValueExpression"in l?u=$(e,{type:"expression",target:d,valueExpression:l.onStatisticValueExpression,resultType:y}).fieldIndex:"onStatisticNormalizationField"in l?(o=$(e,{type:"field",target:d,field:r,resultType:y}).field,c=l.onStatisticNormalizationField):o=$(e,{type:"field",target:d,field:r,resultType:y}).field,$(e,{type:"statistic",target:"aggregate",name:s,context:i,inField:o,inNormalizationField:c,inFieldIndex:u,statisticType:a})}}function we(e,t,i){switch(i.type){case"dot-density":return Ot(e,t,i.attributes);case"simple":case"class-breaks":case"unique-value":case"dictionary":return Rt(e,t,i.visualVariables);case"heatmap":return null}}function Ot(e,t,i){return!i||!i.length?{type:"dot-density",mapping:[],target:t}:{type:"dot-density",mapping:i.map((n,s)=>{const{field:l,fieldIndex:a}=w(e,{valueExpression:n.valueExpression,field:n.field,resultType:"numeric",target:t});return{binding:s,field:l,fieldIndex:a}}),target:t}}function Rt(e,t,i){if(!i||!i.length)return{type:"visual-variable",mapping:[],target:t};const n={storage:!0},s="numeric";return{type:"visual-variable",mapping:rt(i).map(l=>{var a;const r=_e(l.type),{field:o,fieldIndex:u}=w(e,{target:t,valueExpression:l.valueExpression,field:l.field,context:n,resultType:s});switch(l.type){case"size":return l.valueExpression==="$view.scale"?null:{type:"size",binding:r,field:o,fieldIndex:u,normalizationField:w(e,{target:t,field:l.normalizationField,context:n,resultType:s}).field,valueRepresentation:(a=l.valueRepresentation)!=null?a:null};case"color":return{type:"color",binding:r,field:o,fieldIndex:u,normalizationField:w(e,{target:t,field:l.normalizationField,context:n,resultType:s}).field};case"opacity":return{type:"opacity",binding:r,field:o,fieldIndex:u,normalizationField:w(e,{target:t,field:l.normalizationField,context:n,resultType:s}).field};case"rotation":return{type:"rotation",binding:r,field:o,fieldIndex:u}}}).filter(l=>l),target:t}}function D(e,t,i,n=!1){const s=Ce(e,{indexCount:0,fields:{}});switch(i.type){case"simple":case"dot-density":return kt(s,i,n);case"class-breaks":return Nt(s,t,i,n);case"unique-value":return Ct(s,t,i,n);case"dictionary":return Lt(s,i,n)}}function kt(e,t,i=!1){const n=t.getSymbols(),s=n.length?n[0]:null,{stride:l}=_(t);return{type:"simple",symbol:Q(s,t,i),stride:l}}function Nt(e,t,i,n=!1){const s={mesh:!0,use:"renderer.field"},l=i.backgroundFillSymbol,{field:a,fieldIndex:r}=w(e,{target:t,field:i.field,valueExpression:i.valueExpression,resultType:"numeric",context:s}),o=i.normalizationType,u=o==="log"?"esriNormalizeByLog":o==="percent-of-total"?"esriNormalizeByPercentOfTotal":o==="field"?"esriNormalizeByField":null,c=_(i),y=i.classBreakInfos.map(d=>({symbol:T(d.symbol,c,n),min:d.minValue,max:d.maxValue})).sort((d,g)=>d.min-g.min);return{type:"interval",attributes:e.fields,field:a,fieldIndex:r,backgroundFillSymbol:T(l,c,n),defaultSymbol:T(i.defaultSymbol,c,n),intervals:y,normalizationField:i.normalizationField,normalizationTotal:i.normalizationTotal,normalizationType:u,isMaxInclusive:i.isMaxInclusive,stride:c.stride}}function Ct(e,t,i,n=!1){const s=[],l=i.backgroundFillSymbol,a={target:t,context:{mesh:!0},resultType:"string"};if(i.field&&typeof i.field!="string")throw new b(S,"Expected renderer.field to be a string",i);const{field:r,fieldIndex:o}=w(e,m(f({},a),{field:i.field,valueExpression:i.valueExpression})),u=_(i);for(const c of i.uniqueValueInfos)s.push({value:""+c.value,symbol:T(c.symbol,u,n)});return{type:"map",attributes:e.fields,field:r,fieldIndex:o,field2:w(e,m(f({},a),{field:i.field2})).field,field3:w(e,m(f({},a),{field:i.field3})).field,fieldDelimiter:i.fieldDelimiter,backgroundFillSymbol:T(l,u),defaultSymbol:T(i.defaultSymbol,u),map:s,stride:u.stride}}function Lt(e,t,i=!1){return{type:"dictionary",renderer:t.toJSON(),stride:{fill:"default"}}}var ii=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",addAggregateFields:Se,createMatcherSchema:D,createSchema:$t,createSymbolSchema:Q,createSymbolSchemaOptions:_});export{$t as B,D as _,ei as a,ft as b,Wt as c,Qt as d,dt as e,mt as f,Ht as g,Yt as h,ii as i,yt as m,Xt as p,ti as s,Gt as u,Zt as y,Q as z};
