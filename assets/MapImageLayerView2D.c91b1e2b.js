import{pc as n,u as g,ae as d,fW as l,w as u,e as o,y as s,b as c}from"./index.a33ecea7.js";import{a as f}from"./BitmapContainer.78a1e7fc.js";import{f as y}from"./LayerView2D.d9ef92c2.js";import{a as w}from"./GraphicsView2D.8c9440ff.js";import{n as H}from"./HighlightGraphicContainer.3fd97f5c.js";import{v as _}from"./ExportStrategy.9d5a6ffc.js";import{u as v}from"./LayerView.88bcfa48.js";import{p as x}from"./MapImageLayerView.4fdcabdc.js";import{i as U}from"./RefreshableLayerView.e0df9b3f.js";import{S as C}from"./MapServiceLayerViewHelper.5c9468d6.js";import"./WGLContainer.5bbfc124.js";import"./definitions.618cbc79.js";import"./WGLBrushVTLSymbol.4ddaefec.js";import"./enums.a12f2baf.js";import"./number.e821bc3e.js";import"./StyleDefinition.630dd2fa.js";import"./GeometryUtils.b69b6363.js";import"./color.d55e9401.js";import"./ShaderCompiler.915a06d7.js";import"./ProgramTemplate.6d98fd14.js";import"./MaterialKey.23a3bc73.js";import"./alignmentUtils.cba6cd73.js";import"./utils.28eb7bc1.js";import"./heatmapTextureUtils.e4986b56.js";import"./Container.5f323bc4.js";import"./EffectView.f5ec831b.js";import"./cimAnalyzer.32b2260b.js";import"./fontUtils.401be2b9.js";import"./BidiEngine.8d79ab2c.js";import"./GeometryUtils.b33f0569.js";import"./Rect.85ff00e1.js";import"./normalizeUtilsSync.a99dd2fa.js";import"./AttributeStoreView.6e83daf7.js";import"./visualVariablesUtils.300ac9ef.js";import"./visualVariablesUtils.88d0eb69.js";import"./Matcher.91da54bc.js";import"./tileUtils.b5739863.js";import"./TurboLine.9c04f89e.js";import"./ExpandedCIM.1794ca2e.js";import"./schemaUtils.bac079cd.js";import"./createSymbolSchema.0ace72f9.js";import"./util.ca7e0ea2.js";import"./ComputedAttributeStorage.fd12c291.js";import"./arcadeTimeUtils.fe70ea3d.js";import"./centroid.5ec46060.js";import"./GraphicsView.69d359aa.js";import"./BaseGraphicContainer.cb1cac6c.js";import"./FeatureContainer.12b5d67c.js";import"./TileContainer.432071cb.js";import"./Bitmap.0ee5b9a3.js";import"./ExportImageParameters.8ce29ef2.js";import"./floorFilterUtils.095bd939.js";import"./popupUtils.5d07a4ea.js";let a=class extends x(U(y(v))){constructor(){super(...arguments),this._highlightGraphics=new n,this._updateHash=""}fetchPopupFeatures(t,i){return this._popupHighlightHelper.fetchPopupFeatures(t,i)}update(t){const i=`${this.exportImageVersion}/${t.state.id}/${t.pixelRatio}/${t.stationary}`;this._updateHash!==i&&(this._updateHash=i,this.strategy.update(t).catch(e=>{g(e)||d.getLogger(this.declaredClass).error(e)}),t.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(t.state.resolution)),this._highlightView.processUpdate(t)}attach(){const{imageMaxWidth:t,imageMaxHeight:i,version:e}=this.layer,r=e>=10.3,m=e>=10;this._bitmapContainer=new f,this.container.addChild(this._bitmapContainer),this._highlightView=new w({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new H(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new C({createFetchPopupFeaturesQueryGeometry:(p,h)=>l(p,h,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(p,h)=>{this._highlightView.graphicUpdateHandler({graphic:p,property:h})},layerView:this,updatingHandles:this.updatingHandles}),this.strategy=new _({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:t,imageMaxHeight:i,imageRotationSupported:r,imageNormalizationSupported:m,hidpi:!0}),this.addAttachHandles(u(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return this.layer.serviceSupportsSpatialReference(t)}async doRefresh(){this._updateHash="",this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(t,i,e,r){return this.layer.fetchImage(t,i,e,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(t,i,e,r){return this.layer.fetchImageBitmap(t,i,e,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(t){return this._popupHighlightHelper.highlight(t)}};o([s()],a.prototype,"strategy",void 0),o([s()],a.prototype,"updating",void 0),a=o([c("esri.views.2d.layers.MapImageLayerView2D")],a);const Ct=a;export{Ct as default};
