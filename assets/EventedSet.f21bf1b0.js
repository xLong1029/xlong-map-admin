var he=Object.defineProperty;var N=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var $=(e,t,i)=>t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,_=(e,t)=>{for(var i in t||(t={}))oe.call(t,i)&&$(e,i,t[i]);if(N)for(var i of N(t))le.call(t,i)&&$(e,i,t[i]);return e};import{iC as z,cw as D,bJ as ue,iD as ce,iE as q,iF as G,d$ as de,b1 as u,g9 as pe,cC as Q,iG as fe,bu as T,iH as me,b6 as g,bF as k,aY as h,aZ as o,a_ as O,a$ as j,aW as H,bT as ge,cz as ye,c3 as B,ba as E,cp as X,b9 as b,c7 as Y,g2 as Fe,c8 as xe,iI as ve,e0 as Te,cE as be,bd as V,iJ as Ee,iK as _e,iL as Ce,cv as we,iM as Se,bm as C,bp as w,aX as Re,as as I,b3 as De,b4 as Oe,gc as Ve,aV as Ie,be as W,c5 as M,c4 as Me,cd as Ue,bh as S,g4 as Pe,iN as Ae,iO as Le,ek as J,gb as Ne,bA as K,iP as $e,iQ as ze,bc as qe,cb as R,iR as Ge,bt as Qe,iS as ke}from"./vendor.47ccae81.js";import{v as je,p as He}from"./Graphics3DFeatureLikeLayerView.5dad492f.js";import{l as Be}from"./projectExtentUtils.066a3971.js";class Xe{constructor(t,i){this.highestResolutionVersion=null,this.versions=[],this.ref(t,i)}get isReferenced(){return this.versions.length!==0}get isSingle(){return this.versions.length===1&&this.versions[0].refCount===1}ref(t,i){const s=this.feature;y.oldVersion=s,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0});for(const r of this.versions)if(r.resolution===i){r.refCount++;const n=this.highestResolutionVersion===r&&!z(t,r.feature);return(n||this.highestResolutionVersion!==r)&&(r.feature=t),y.newVersion=n?t:s,y}const a={feature:t,resolution:i,refCount:1};return this.versions.push(a),!this.highestResolutionVersion||i<this.highestResolutionVersion.resolution?(y.newVersion=t,this.highestResolutionVersion=a):y.newVersion=s,y}unref(t){for(let i=0;i<this.versions.length;i++){const s=this.versions[i];if(s.resolution===t)return s.refCount--,y.oldVersion=this.feature,s.refCount===0&&(this.versions[i]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===s&&(this.recalculateHighestResolutionVersion(),y.oldVersion=s.feature)),y.newVersion=this.feature,y}return null}get feature(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}recalculateHighestResolutionVersion(){if(this.versions.length===0)return void(this.highestResolutionVersion=null);let t=this.versions[0];for(let i=1;i<this.versions.length;i++){const s=this.versions[i];s.resolution<t.resolution&&(t=s)}this.highestResolutionVersion=t}}class Ye{constructor(t){this._feature=t,this.refCount=1}get isReferenced(){return this.refCount!==0}get isSingle(){return this.refCount===1}ref(t){return++this.refCount,y.oldVersion=this._feature,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0}),z(this._feature,t)||(this._feature=t),y.newVersion=this._feature,y}unref(){return y.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(y.newVersion=null,y):(y.newVersion=this._feature,y)}get feature(){return this._feature}}const y={oldVersion:null,newVersion:null},We=16438,Z=new Set;class Je{constructor(t){this.descriptor=t,this.fetchStatus=0,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=U,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=Z,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(t,i,s){this._availableFields=ue(s,Z),this._features=t,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,t&&t.length>0?(this._emptyFeatureRatio=i/(t.length+i),this._numVertices=t.reduce((a,r)=>a+ce(r.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(t){this._numFeatures=t}get hasPreciseFeatureCount(){return this._numFeatures>U}get needsFeatureCount(){return this._numFeatures===U}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const i=q(this._features[t]);this._estimatedSize+=i,t>=this.featureLimit&&(this._estimatedUnusedSize+=i)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=q(this._features[t]);return!0}return!1}get isFetching(){return this.fetchStatus===2||this.fetchStatus===3}get isRefetching(){return this.fetchStatus===3}get needsFetching(){return this.fetchStatus===0||this.fetchStatus===1}get needsRefetching(){return this.fetchStatus===1}get isFetched(){return this.fetchStatus===4||this.fetchStatus===5}resetFetching(){this.fetchStatus=this.fetchStatus===3?1:0}get needsDisplayUpdate(){return!!this._features&&!Ze(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return!t||!this.descriptor.extent||(G(t,ee),de(this.descriptor.extent,ee))}intersectionIncludingBorrowed(t,i){const s=u(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||s?(t?(G(t,i),pe(i,s,i)):Q(i,s),i):(Q(i,fe),i)}_shuffle(t){this._features.sort((i,s)=>T(i,t)-T(s,t)),me(this._features,We),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(t,i,s){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let a=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===4&&this._features.length>0&&(this.fetchStatus=1,a=!0)),!this._shuffled&&t<1&&this._shuffle(s);const r=Math.max(this.featureLimit,Math.ceil(i*this.numFeatures));return this._features.length>r&&(this._features.length=r,this.featuresMissing=!0,this.fetchStatus===5&&(this.fetchStatus=4)),a}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const U=-1,Ke=-2;function Ze(e,t,i){if(g(t)||g(e)||i!==t.length||i>e.length)return!1;for(let s=0;s<i;++s)if(e[s]!==t[s])return!1;return!0}const ee=D(),P=k.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");let m=class extends j{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new H,this._frameTask=ge,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this.maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this.setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&u(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this.featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.numFeatures),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void P.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this.reclip(i,t)}initialize(){this.handles.add(ye(this,"tileDescriptors","change",()=>this.setDirty(),()=>this.setDirty())),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?Xe:Ye;const e=this.context.scheduler;u(e)&&(this._frameTask=e.registerTask(B.FEATURE_TILE_FETCHER,this)),this.setDirty()}destroy(){this._frameTask.remove(),this.handles=E(this.handles),this.featureTiles.forEach(e=>{this.cancelFetchTile(e),this.removeTile(e)}),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach(e=>{this.cancelFetchTile(e),this.clearTile(e),this.resetFetchTile(e)}),u(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}refetch(){this.featureTiles.forEach(e=>{this.cancelFetchTile(e),this.resetFetchTile(e)}),u(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}suspend(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())}resume(){this.suspended&&(this.suspended=!1,this.unpause())}pause(){this.paused&&(this.featureTiles.forEach(e=>this.cancelFetchTile(e)),this.updated())}unpause(){this.paused||(this.setDirty(),this.updated())}get availableFields(){let e=null;return this.featureTiles.forEach(t=>{g(t.displayingFeatures)||t.displayingFeatures.length===0||(g(e)?e=new Set(t.availableFields):e.forEach(i=>{t.availableFields.has(i)||X(e).delete(i)}))}),u(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this.pause());const t=this.pendingEdits;t.count++;const i=t.edits.then(()=>e.result.catch(s=>{if(b(s))throw s;return null}).then(s=>s&&(this.applyEditsDeleteFeatures(s.deletedFeatures),this.applyEditsAddUpdateFeatures(s.addedFeatures,s.updatedFeatures,t.controller.signal).then(()=>s))).then(s=>(--t.count==0&&(this.pendingEdits===t&&(this.pendingEdits=null),u(this.context.memoryCache)&&this.context.memoryCache.clear(),this.unpause(),this.updated()),s)));return t.edits=i,this.updated(),i}applyEditsDeleteFeatures(e){if(e.length===0)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),s=new Set,a=this.objectIdField;e.forEach(({objectId:r,globalId:n})=>{if((!r||r<0)&&t){i||P.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const c=this.features.find(d=>d.attributes&&d.attributes[t]===n);c&&s.add(T(c,a))}else s.add(r)}),this.featureTiles.forEach(r=>{if(!r.features)return;const n=r.features.filter(c=>!s.has(T(c,this.objectIdField)));n.length!==r.features.length&&(r.setFeatures(n,0,r.availableFields),this.invalidateCounts())})}async applyEditsAddUpdateFeatures(e,t,i){const s=[],a=new Set;if(e.forEach(n=>s.push(n.objectId)),t.forEach(n=>{s.push(n.objectId),a.add(n.objectId)}),s.length===0)return;const r=[];this.featureTiles.forEach(n=>{const c=this.applyEditsAddUpdateTile(n,s,a,i);c&&r.push(c)}),await Y(r)}async applyEditsAddUpdateTile(e,t,i,s){if(!e.features)return;const a=this.createQuery(e);a.resultType=void 0,a.cacheHint=!1,a.objectIds=t;const r=await this.queryFeatures(a,s);let n=null;if(i.size>0){const c=e.features.filter(d=>!i.has(T(d,this.objectIdField)));c.length!==e.features.length&&(n=c)}if(r.features.length>0){n||(n=e.features.slice());for(const c of r.features)n.push(c)}n&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,n.length)),e.setFeatures(n,0,ie(e.availableFields,r.fields)),this.invalidateCounts())}queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:rt})}setDirty(){this._dirty=!0,this.updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this.getListOfTiles();if(this.markTilesNotAlive(t),!e.run(()=>this.addTiles(t,e))||!e.run(()=>this.filterExtentTiles(t,e))||!e.run(()=>this.removeTiles(t,e))||e.done)return void this.setDirty();const i=this.sortTiles(t);e.run(()=>this.displayTiles(i,e))&&e.run(()=>this.fetchTiles(i,e))&&e.run(()=>this.updateMemoryEstimates(i,e))||this.setDirty(),this.updated(),this.updating||this.updateMaximumNumberOfFeaturesExceeded()}markTilesNotAlive(e){for(const t of e)t.alive=!1}addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach(i=>{const s=this.featureTiles.get(i.id);s?s.alive=!0:t.done||(e.push(this.addTile(i)),t.madeProgress())}),t.hasProgressed)}filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this.clearTile(i),t.madeProgress()))}return t.hasProgressed}removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const s=e[i];s.alive||(this.removeTile(s),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}sortTiles(e){return e.sort((t,i)=>t.descriptor.loadPriority-i.descriptor.loadPriority),e}displayTiles(e,t){const i=this.updateRatio(e),s=a=>{const r=this._fullRatio<1?i(a)*this._farRatio:1;return a.reduceFeatures(r,this.memoryFactor,this.objectIdField)&&this.setDirty(),this.showTile(a)};for(const a of e)if(!t.run(()=>s(a))){this.setDirty();break}return t.hasProgressed}fetchTiles(e,t){if(this.paused)return!1;let i=!1;for(const s of e){if(!s.needsFetching)continue;const a=u(this.context.memoryCache)?this.context.memoryCache.pop(s.id):null;if(u(a))s.cache=a,this.setDirty(),this.scheduleUpdated(),t.madeProgress();else{if(this.needsNumFeatures(s)){const r=new AbortController,n=this.fetchTileCount(s,r.signal);this._handleRequest(s,n,r,()=>s.numFeatures=Ke),i=!0,t.madeProgress()}if(t.done)return!0}}if(i)return t.hasProgressed;for(const s of e)if(s.needsFetching){const a=new AbortController,r=this.fetchTile(s,a.signal);if(this._handleRequest(s,r,a,n=>{s.setFeatures([],0,null),this.invalidateCounts(),s.featuresMissing=!1,this.context.logFetchError(P,n)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}updateMemoryEstimates(e,t){return e.some(i=>!t.run(()=>i.updateMemoryEstimates())&&(this.setDirty(),!0)),t.hasProgressed}reclip(e,t){if(!this.constructed)return;const i=new Array;this.featureTiles.forEach(s=>{g(s.displayingFeatures)||s.displayingFeatures.length===0||(s.intersectionIncludingBorrowed(t,se),s.intersectionIncludingBorrowed(e,re),Fe(se,re)||i.push(s))}),this.refreshDisplayingFeatures(i),this.updated()}refreshDisplayingFeatures(e){const t=new Set,i=this.changes.updates;for(const s of e)if(!g(s.displayingFeatures))for(const a of s.displayingFeatures){const r=T(a,this.objectIdField);if(t.has(r))continue;t.add(r);const{feature:n}=this.displayingFeatureReferences.get(r);i.removes.push(n),i.adds.push(n)}this.applyChanges()}updated(){let e=0;this.paused||this.featureTiles.forEach(i=>i.isFetching?++e:0);const t=this._dirty||e>0||!!this.pendingEdits;if(this._set("updating",t),t){let i=0,s=0,a=0,r=0,n=0;const c=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach(l=>{if(++s,l.isFetching&&l.hasPreciseFeatureCount){const F=this.maximumFeaturesForTile(l)*(1-l.emptyFeatureRatio),v=u(l.displayingFeatures)?l.displayingFeatures.length*c:0;n+=F-v}l.needsFetching?++r:l.numFeatures>0&&(++a,i+=l.numFeatures)}),r+=e;let d=0,f=0;i?(f=i,d=Math.min(r*i/a,i)):(f=s,d=r),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",f),this._set("updatingRemaining",d),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}updateMaximumNumberOfFeaturesExceeded(){const e=xe(this.featureTiles,t=>t.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",e)}updateRatio(e){const t=et(e),i=r=>1/(1<<Math.max(0,t-r.descriptor.lij[0]));let s=0,a=0;for(const r of e){const n=r.numFeatures;s+=n,a+=n*i(r)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/s),this._farRatio=this.maximumNumberOfFeatures/a,this.scheduleUpdated(),i}maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach(i=>{if(!i.featuresMissing)return;const s=this.maximumFeaturesForTile(i);i.features&&(i.features.length>=s||i.fetchStatus===5)||(this.cancelFetchTile(i),this.resetFetchTile(i))}),this.setDirty())}addTile(e){const t=new Je(e);return this.featureTiles.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t}referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach(i=>{if(!(g(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!ve(e.descriptor.lij,i.descriptor.lij))){g(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&(g(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=Te(e.descriptor.extent)),be(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const s of i.displayingFeatures){e.displayingFeatures.push(s);const a=this.displayingFeatureReferences.get(T(s,this.objectIdField));a.ref(a.feature,t),this.numDisplayingFeatureReferences++}}}),e.featureLimit=u(e.displayingFeatures)?e.displayingFeatures.length:0}removeTile(e){this.clearTile(e),this.featureTiles.delete(e.id)}resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=4):e.fetchStatus=0}cancelFetchTile(e){const t=e.requestController;u(t)&&(e.requestController=null,e.resetFetching(),t.abort())}async fetchTileCount(e,t){return e.numFeatures=await this.fetchCount(e,t),this.updateRatio(this.getListOfTiles()),e.fetchStatus===3?1:0}async fetchTile(e,t){const i=this.maximumFeaturesForTile(e);if(i<=0)return it(e);const s=this.getMaxRecordCount(e),a=Math.ceil(i/s);if(A(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&a>V.MAX_MAX_RECORD_COUNT_FACTOR)return this.fetchPagedTile(e,t);const r=this.createQuery(e);if(r.maxRecordCountFactor=Math.ceil(i/s),e.isRefetching&&e.features&&e.features.length>0){const l=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/s);r.maxRecordCountFactor=Math.max(l+1,r.maxRecordCountFactor)}const{features:n,exceededTransferLimit:c,fields:d}=await this.queryFeatures(r,t),f=c?r.maxRecordCountFactor>=V.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5;return await this._frameTask.schedule(()=>{e.featuresMissing=n.length<e.numFeatures||c;const l=this._removeEmptyFeatures(n);e.setFeatures(n,l,te(d))},t),this.invalidateCounts(),f}async fetchCount(e,t){return this.context.query.queryFeatureCount(this.createFeatureCountQuery(e),{signal:t})}async fetchPagedTile(e,t){let i,s=0,a=0,r=0,n=this.maximumFeaturesForTile(e)-r;const c=this.getMaxRecordCount(e);let d=null;for(;;){const f=this.createQuery(e),l=this.setPagingParameters(f,s,n,c),{features:F,exceededTransferLimit:v,fields:ne}=await this.queryFeatures(f,t);if(await this._frameTask.schedule(()=>{l&&(s+=X(f.num)),r+=F.length,a+=this._removeEmptyFeatures(F),e.featuresMissing=s<e.numFeatures||v,i=i?i.concat(F):F,d=ie(d,ne),e.setFeatures(i,a,d)},t),this.invalidateCounts(),this.setDirty(),n=this.maximumFeaturesForTile(e)-r,!l||!v||n<=0)return v?4:5}}createFeatureCountQuery(e){const t=this.createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;if(i){const s=this.context.tilingScheme.spatialReference;t.geometry=Ee(i,s)}return this.setResolutionParams(t,e),this.useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}setPagingParameters(e,t,i,s){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/s),e.num=Math.min(e.maxRecordCountFactor*s,i)):e.num=Math.min(s),!0)}getEffectiveTileResolution(e){if(e.descriptor.resolution==null)return null;const t=this.context.viewingMode===1?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&this.context.geometryType!=="point"}setResolutionParams(e,t){if(!this.supportsResolution)return;const i=this.getEffectiveTileResolution(t);i!=null&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new _e({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):this.context.geometryType==="polyline"&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let i=0;i<e.length;){const s=e[i];Ce(s.geometry)?++i:(e[i]=e[e.length-1],--e.length)}return t-e.length}needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!A(e)}getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this.useTileQuery(e)&&u(t)&&t>0&&this.context.capabilities.supportsResultType?t:u(i)&&i>0?i:st}useTileQuery(e){return(!A(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,s){e.fetchStatus=e.needsRefetching?3:2,e.requestController=i;let a=!1;t.then(r=>{e.requestController=null,e.fetchStatus=r}).catch(r=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=4),b(r)?a=!0:s(r)}).then(()=>{a||this.setDirty(),this.scheduleUpdated()})}scheduleUpdated(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(we(()=>{this.handles.remove("scheduleUpdated"),this.updated()}),"scheduleUpdated")}showTile(e){if(u(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(e.featureLimit===0||!t){const n=u(e.displayingFeatures)&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],n}const i=e.descriptor.resolution,s=this.changes.updates,a=this.changes.adds,r=Math.min(e.featureLimit,t.length);e.featureLimit=r;for(let n=0;n<r;++n){const c=t[n],d=T(c,this.objectIdField),f=this.displayingFeatureReferences.get(d);if(f){const l=f.ref(c,i);l.oldVersion!==l.newVersion&&(s.removes.push(l.oldVersion),s.adds.push(l.newVersion))}else this.displayingFeatureReferences.set(d,new this.FeatureReferenceClass(c,i)),a.push(c);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=t.slice(0,r),!0}hideTile(e){this.cancelFetchTile(e),this.hideTileFeatures(e)}hideTileFeatures(e){if(g(e.displayingFeatures))return;const t=this.changes.updates,i=this.changes.removes;for(const s of e.displayingFeatures){const a=T(s,this.objectIdField),r=this.displayingFeatureReferences.get(a);if(!r)continue;const n=r.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,n?n.oldVersion!==n.newVersion&&(n.newVersion==null?(this.displayingFeatureReferences.delete(a),i.push(n.oldVersion)):(t.adds.push(n.newVersion),t.removes.push(n.oldVersion))):console.error("Hiding unreferenced feature")}this.applyChanges(),e.displayingFeatures=null}applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,i=this.changes.removes,s=Math.min(t.length,i.length);let a=0;for(;a<s;){const r=Math.min(a+at,s);this.features.addMany(t.slice(a,r)),this.features.removeMany(i.slice(a,r)),a=r}t.length>s&&this.features.addMany(a===0?t:t.slice(a)),i.length>s&&this.features.removeMany(a===0?i:i.slice(a)),t.length=0,i.length=0}clearTile(e){if(this.hideTile(e),e.features&&u(this.context.memoryCache)){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this.invalidateCounts()}invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this.getListOfTiles().reduce((e,t)=>e+(t.features?t.features.length:0),0)}maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,s=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*s/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function A(e){return e.id==="dummy-tile-full-extent"}function et(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}function gt(e){const t=e.capabilities.query;return{supportsMultipleResolutions:tt(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function tt(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function it(e){return e.setFeatures([],0,null),e.featuresMissing=!1,4}function te(e){return g(e)?new Set:new Set(e.map(t=>t.name))}function ie(e,t){if(g(e)||g(t))return te(t);const i=new Set;for(const{name:s}of t)e.has(s)&&i.add(s);return i}h([o({constructOnly:!0})],m.prototype,"features",void 0),h([o()],m.prototype,"tileDescriptors",void 0),h([o({value:1/0})],m.prototype,"maximumNumberOfFeatures",null),h([o({value:1})],m.prototype,"memoryFactor",null),h([o({value:1})],m.prototype,"lodFactor",null),h([o()],m.prototype,"useTileCount",null),h([o({readOnly:!0})],m.prototype,"updating",void 0),h([o({readOnly:!0})],m.prototype,"updatingTotal",void 0),h([o({readOnly:!0})],m.prototype,"updatingRemaining",void 0),h([o({readOnly:!0})],m.prototype,"expectedFeatureDiff",void 0),h([o({readOnly:!0})],m.prototype,"memoryForUnusedFeatures",null),h([o({readOnly:!0})],m.prototype,"maximumNumberOfFeaturesExceeded",void 0),h([o({constructOnly:!0})],m.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),h([o({readOnly:!0})],m.prototype,"totalVertices",null),h([o({readOnly:!0})],m.prototype,"totalFeatures",null),h([o()],m.prototype,"filterExtent",null),h([o({constructOnly:!0})],m.prototype,"context",void 0),m=h([O("esri.views.3d.layers.support.FeatureTileFetcher3D")],m);const st=2e3,se=D(),re=D(),rt=6e5,at=200,nt=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class ht{constructor(t,i,s){this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=t,this.view=s,this.tilingScheme=new Se(i),this.loadedSymbols=nt.map(a=>new C(new w({material:{color:[a[0],a[1],a[2],.6]},outline:{color:"black",size:1}}))),this.loadingSymbols=[new C(new w({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new C(new w({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new C(new w({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.update()}update(){this._enabled?(this.synchronizeMaps(this.loadingGraphics,{filter:t=>t.isFetching,symbols:this.loadingSymbols}),this.synchronizeMaps(this.loadedGraphics,{filter:t=>!t.isFetching,symbols:this.loadedSymbols}),this.synchronizeMaps(this.pendingGraphics,{filter:t=>!t.isFetching,symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.loadingGraphics.clear(),this.loadedGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.loadedGraphics.clear(),this.pendingGraphics.forEach(t=>{this.view.graphics.removeMany(t)}),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}showDataExtent(t){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),!t)return;const i=Re.fromExtent(t);this.dataExtentGraphic=new I({geometry:i,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}synchronizeMaps(t,i){const s=[];t.forEach((a,r)=>{const n=this.tileFetcher.test.getFeatureTileById(r);n&&i.filter(n)||(this.view.graphics.removeMany(a),s.push(r))}),s.forEach(a=>t.delete(a)),this.tileFetcher.test.forEachFeatureTile(a=>{if(i.filter(a)&&!t.has(a.id)){const[r,n,c]=a.descriptor.lij;this.tilingScheme.ensureMaxLod(r);const d=this.tilingScheme.getExtentGeometry(r,n,c),f=[new I({geometry:d,symbol:i.symbols[r%i.symbols.length]}),new I({geometry:d.center,symbol:new De({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new Oe({text:`${r}/${n}/${c}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];t.set(a.id,f),this.view.graphics.addMany(f)}})}}const L=k.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");let p=class extends Ve(j){constructor(e){super(e),this.type="feature-tile-3d",this.watchUpdatingTracking=new Ie,this.serviceDataExtent=null,this.serviceDataCount=x.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this.suspended=!1,this.tileFetcher=null,this.handles=new H,this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null,this.lifeCycleAbortController=new AbortController}set extent(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void L.error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("extent",i)}get updating(){return!!(u(this.tileFetcher)&&this.tileFetcher.updating||this.fetchDataInfoPromise!=null||this.mode==="tiles"&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&u(this.tileFetcher)?this.tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&u(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&u(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return u(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!u(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return u(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&(e==null?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){var e,t;const i=this.layerView.layer;if(i.type==="feature"&&u(i.infoFor3D))return"snapshot";if(((e=this.layerView.view.qualitySettings)==null||(t=e.graphics3D)==null?void 0:t.snapshotAvailable)===!1||this.serviceDataCount===x.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const s=this.layerView.view,a=s&&s.featureTiles,r=a&&a.tilingScheme;if(i&&i.minScale&&this.serviceDataExtent&&r){const n=this.approximateExtentSizeAtScale(i.minScale,r);if((this.serviceDataExtent.width/n+this.serviceDataExtent.height/n)/2>x.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t=this.mode==="snapshot"&&u(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}approximateExtentSizeAtScale(e,t){const i=this.layerView.view,s=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),a=t.levels[0];return s*((a.tileSize[0]/(a.scale/e)+a.tileSize[1]/(a.scale/e))/2)}get tileDescriptors(){return this.mode==="snapshot"?new W([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new W}get test(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}initialize(){this.watchUpdatingTracking.add(this,"vertexLimitInfo",()=>this.watchUpdatingTracking.addPromise(this.updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))),this.watchUpdatingTracking.add(this,"mode",()=>this.modeChanged(),2),this.addResolvingPromise(Promise.resolve().then(()=>this.verifyCapabilities()).then(()=>this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo())).then(()=>this.initializeTileFetcher()))}verifyCapabilities(){const e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&e.type!=="ogc-feature")throw new M("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this.cancelFetchServiceDataInfo(),this.tileFetcher=E(this.tileFetcher),this.handles=E(this.handles),this.tilesHandle=Me(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this.suspended||(this.suspended=!0,u(this.tileFetcher)&&this.tileFetcher.suspend())}resume(){this.suspended&&(this.suspended=!1,u(this.tileFetcher)&&this.tileFetcher.resume())}restart(){const e=()=>{u(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(e,e))}refetch(){const e=()=>{u(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(e,e))}initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=Ue(e.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(t),t.then(()=>{const{layerView:i,tileDescriptors:s}=this,a=i.layer,r=new m({context:this.context,filterExtent:this.extent,tileDescriptors:s,features:this.graphics});this.tileFetcher=r,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const n=this.layerView.view.resourceController;n&&(this.handles.add(n.memoryController.events.on("quality-changed",l=>{r.memoryFactor=l})),this.tileFetcher.memoryFactor=n.memoryController.memoryFactor);const c=this.context.geometryType==="polygon"?"polygonLodFactor":this.context.geometryType==="polyline"?"polylineLodFactor":null;c&&this.handles.add(S(this.layerView.view,"qualitySettings.graphics3D."+c,l=>{r.lodFactor=l||1}));const d=l=>{r.maximumNumberOfFeatures=l,r.useTileCount=this.serviceDataCount>l},f=l=>r.useTileCount=l>this.maximumNumberOfFeatures;this.watchUpdatingTracking.add(a,"createQueryVersion",()=>this.dataFilterChanged()),this.watchUpdatingTracking.add(i,"availableFields",(l,F)=>this.availableFieldsChanged(F,l)),this.watchUpdatingTracking.add(i,"requiredFields",(l,F)=>this.requiredFieldsChanged(F,l)),this.handles.add([a.on("apply-edits",l=>this.applyEdits(l)),this.watch("extent",l=>r.filterExtent=l,!0),this.watch("tileDescriptors",l=>r.tileDescriptors=l,!0),S(this,"maximumNumberOfFeatures",d,!0),S(this,"serviceDataCount",f,!0),S(Pe,"FEATURE_TILE_FETCH_SHOW_TILES",l=>{l&&r&&!r.debugger?(r.debugger=new ht(r,e.featureTiles.tilingScheme.toTileInfo(),e),r.debugger.update()):!l&&this.tileFetcher&&r.debugger&&(r.debugger.destroy(),r.debugger=null)})]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add(this,"maxTotalSnapshotVertices",()=>this.watchUpdatingTracking.addPromise(this.updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))}).catch(()=>{})}modeChanged(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:L.warn("Unhandled feature layer mode "+this.mode);case"snapshot":u(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}applyEdits(e){g(this.tileFetcher)||this.tileFetcher.applyEdits(e).then(t=>{t&&(t.deletedFeatures.length||t.updatedFeatures.length||t.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this.updateServiceDataExtent(this.lifeCycleAbortController.signal))}).catch(t=>{if(!b(t))throw t})}availableFieldsChanged(e,t){u(this.tileFetcher)&&ae(this.tileFetcher.availableFields,t)&&this.refetch()}requiredFieldsChanged(e,t){u(this.tileFetcher)&&ae(this.tileFetcher.availableFields,t)&&this.restart()}createVertexLimitExceededQuery(e){const t=this.layerView.layer,i=t.createQuery();return i.outStatistics=[new Ae({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(i.cacheHint=!0),i}createDataInfoQuery(){const e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}fullExtentIsAccurate(){const e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return Le(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async updateServiceDataExtent(e){try{await this.tryUpdateServiceDataExtent(e)}catch(t){b(t)||this._set("serviceDataExtent",J(this.layerView.fullExtentInLocalViewSpatialReference))}}async tryUpdateServiceDataExtent(e){const t=this.layerView,i=t.layer,s=i.capabilities.query.supportsExtent,a=J(t.fullExtentInLocalViewSpatialReference),r=i.fullExtent,n=this.fullExtentIsAccurate(),c=this.serviceDataCount;if(s&&c<=x.MAX_FEATURE_COUNT_FOR_EXTENT&&(!a||!n)&&"queryExtent"in i){const d=this.createDataInfoQuery(),f=await i.queryExtent(d,{timeout:x.QUERY_EXTENT_TIMEOUT,signal:e});this._set("serviceDataExtent",f.extent)}else if(a)this._set("serviceDataExtent",a);else if(u(r)){const d="portalItem"in i?i.portalItem:null,f=await Ne(r,t.view.spatialReference,d,e);this._set("serviceDataExtent",f)}else this._set("serviceDataExtent",null)}async updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t))return void this._set("serviceDataCount",x.NO_SERVICE_DATA_COUNT);const i=await K(t.queryFeatureCount(this.createDataInfoQuery(),{timeout:x.QUERY_STATISTICS_TIMEOUT,signal:e}));if(i.ok===!0)this._set("serviceDataCount",i.value);else{if(b(i.error))throw i.error;this._set("serviceDataCount",x.NO_SERVICE_DATA_COUNT)}}get vertexLimitInfo(){if(g(this.displayFeatureLimit)||g(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:e,maximumTotalNumberOfPrimitives:t}=this.displayFeatureLimit,{primitivesPerCoordinate:i,primitivesPerFeature:s}=e,a=this._get("vertexLimitInfo");return g(a)||a.maximumTotalNumberOfPrimitives!==t||a.primitivesPerCoordinate!==i||a.primitivesPerFeature!==s?{primitivesPerCoordinate:i,primitivesPerFeature:s,maximumTotalNumberOfPrimitives:t}:a}get supportsExceedsLimitQuery(){const e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async updateVertexLimitExceeded(e,t){const i=this.vertexLimitInfo;if(g(i))return void this._set("vertexLimitExceeded",!1);const s=i.primitivesPerFeature<=0,a=this.minimumNumberOfVerticesForGeometry>1;if(!s&&!a)return void this._set("vertexLimitExceeded",!1);const{primitivesPerFeature:r,primitivesPerCoordinate:n,maximumTotalNumberOfPrimitives:c}=i;let d;r!==0&&u(e)&&await e;const f=this.serviceDataCount,l=f!==x.NO_SERVICE_DATA_COUNT;if(d=Math.ceil(l?(c-f*r)/(n||1):c/(n||1)),a&&(d=Math.min(d,ct)),l&&this.minimumNumberOfVerticesForGeometry*f>d)return void this._set("vertexLimitExceeded",!0);if(!this.supportsExceedsLimitQuery)return void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>d);const F=await K(this.layerView.layer.queryFeatures(this.createVertexLimitExceededQuery(d),{timeout:x.QUERY_STATISTICS_TIMEOUT,signal:t}));if(F.ok===!1){if(b(F.error))throw F.error;return void this._set("vertexLimitExceeded",!1)}const v=F.value.features[0];v&&v.attributes?this._set("vertexLimitExceeded",!!v.attributes.exceedslimit):this._set("vertexLimitExceeded",!1)}async fetchServiceDataInfo(){this.cancelFetchServiceDataInfo();let e=new AbortController;const t=e.signal,i=this.updateServiceDataCount(t),s=Y([i,this.updateVertexLimitExceeded(i,t)]),a=s.then(()=>this.updateServiceDataExtent(t)).catch(r=>{b(r)||L.error("#fetchServiceDataInfo()",r)}).then(()=>{a===this.fetchDataInfoPromise&&(this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null),e=null});return e&&(this.fetchDataInfoPromise=a),this.fetchDataInfoAbortController=e,s.then(()=>{},()=>{})}cancelFetchServiceDataInfo(){const e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())}get debug(){return{storedFeatures:u(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:u(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:u(this.tileFetcher)?this.tileFetcher.totalVertices:0}}};h([o({readOnly:!0})],p.prototype,"type",void 0),h([o({constructOnly:!0})],p.prototype,"graphics",void 0),h([o({constructOnly:!0})],p.prototype,"layerView",void 0),h([o({constructOnly:!0})],p.prototype,"context",void 0),h([o()],p.prototype,"extent",null),h([o()],p.prototype,"updating",null),h([o({readOnly:!0})],p.prototype,"watchUpdatingTracking",void 0),h([o()],p.prototype,"updatingTotal",null),h([o()],p.prototype,"updatingRemaining",null),h([o()],p.prototype,"expectedFeatureDiff",null),h([o()],p.prototype,"memoryForUnusedFeatures",null),h([o()],p.prototype,"maximumNumberOfFeaturesExceeded",null),h([o({readOnly:!0})],p.prototype,"serviceDataExtent",void 0),h([o({readOnly:!0})],p.prototype,"serviceDataCount",void 0),h([o({readOnly:!0})],p.prototype,"vertexLimitExceeded",void 0),h([o()],p.prototype,"displayFeatureLimit",void 0),h([o({type:Number})],p.prototype,"maximumNumberOfFeatures",null),h([o({readOnly:!0})],p.prototype,"mode",null),h([o({readOnly:!0})],p.prototype,"maxTotalSnapshotVertices",null),h([o({readOnly:!0,dependsOn:["mode"]})],p.prototype,"tileDescriptors",null),h([o()],p.prototype,"tileFetcher",void 0),h([o()],p.prototype,"fetchDataInfoPromise",void 0),h([o({readOnly:!0})],p.prototype,"vertexLimitInfo",null),p=h([O("esri.layers.graphics.controllers.FeatureTileController3D")],p);const ot=1e4,lt=12e3,ut=1e4,ct=5e6;function ae(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}var x;(function(e){function t(){e.MAX_FEATURE_COUNT_FOR_EXTENT=ot,e.QUERY_STATISTICS_TIMEOUT=lt,e.QUERY_EXTENT_TIMEOUT=ut}e.NO_SERVICE_DATA_COUNT=1/0,e.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,e.reset=t})(x||(x={})),x.reset();const yt=e=>{let t=class extends e{constructor(){super(...arguments),this.controller=null,this.updatePolicy=1,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.drapeSourceType=1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){const i=this.layer;"isTable"in i&&i.isTable?this.addResolvingPromise(Promise.reject(new M("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:i}))):(this._set("graphics3d",new je({owner:this,layer:i,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,suspendResumeExtentMode:this.suspendResumeExtentMode,updateClippingExtent:s=>this.updateClippingExtent(s)})),this.updatingHandles.add(this,"updatePolicy",s=>this.graphics3d.graphicsCore.preferredUpdatePolicy=s),this.updatingHandles.add(this,"suspendResumeExtentMode",s=>{this.graphics3d.suspendResumeExtentMode=s}),this.addResolvingPromise(this.graphics3d.setup().then(()=>this.validateGeometryType()).then(()=>this.queryEngine=new He({layerView:this,priority:B.FEATURE_QUERY_ENGINE})).then(()=>Be(this)).then(s=>this.fullExtentInLocalViewSpatialReference=s).then(()=>this.initializeController())),this.notifyChange("updating"))}destroy(){this.destroyPendingController(),this.controller=E(this.controller),this._set("graphics3d",E(this.graphics3d)),this.queryEngine=E(this.queryEngine),this.loadedGraphics=null}destroyPendingController(){this.pendingController&&(this.pendingController.destroy(),this.pendingController=null)}get legendEnabled(){var i,s;return this.canResume()&&!((i=this.graphics3d)!=null&&(s=i.frustumVisibility)!=null&&s.suspended)}notifyGraphicGeometryChanged(i){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(i)}notifyGraphicVisibilityChanged(i){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(i)}getRenderingInfo(i,s,a){const r=$e(i,{renderer:s,arcade:a});if(u(r)&&r.color){const n=r.color;n[0]=n[0]/255,n[1]=n[1]/255,n[2]=n[2]/255}return r}async getRenderingInfoAsync(i,s,a,r){return ze(i,_({renderer:s,arcade:a},r))}getGraphicFromGraphicUid(i){var s;let a=null;return(s=this.loadedGraphics)==null||s.forEach(r=>{r.uid===i&&(a=qe(r,this.layer))}),a}get graphics3DGraphics(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphics:null}get graphics3DGraphicsByObjectID(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}get symbolUpdateType(){return this.graphics3d?this.graphics3d.graphicsCore.symbolUpdateType:null}whenGraphicBounds(i,s){return this.graphics3d?this.graphics3d.graphicsCore.whenGraphicBounds(i,s):null}computeAttachmentOrigin(i,s){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(i,s):null}getSymbolLayerSize(i,s){return this.graphics3d?this.graphics3d.graphicsCore.getSymbolLayerSize(i,s):null}queryFeatures(i,s){return this.queryEngine.executeQuery(this._ensureQuery(i),R(s,"signal"))}queryObjectIds(i,s){return this.queryEngine.executeQueryForIds(this._ensureQuery(i),R(s,"signal"))}queryFeatureCount(i,s){return this.queryEngine.executeQueryForCount(this._ensureQuery(i),R(s,"signal"))}queryExtent(i,s){return this.queryEngine.executeQueryForExtent(this._ensureQuery(i),R(s,"signal"))}_ensureQuery(i){return g(i)?this.createQuery():V.from(i)}highlight(i){return this.graphics3d.highlight(i,this.layer.objectIdField)}maskOccludee(i){return this.graphics3d.maskOccludee(i)}canResume(){return super.canResume()&&(!this.graphics3d||!this.graphics3d.suspended)}getSuspendInfo(){const i=super.getSuspendInfo();return this.graphics3d?_(_({},i),this.graphics3d.suspendInfo):i}isUpdating(){var i,s;return!(!this.graphics3d||this.graphics3d.destroyed)&&!(this._controllerCreated&&((i=this.controller)==null||!i.updating)&&(s=this.view.basemapTerrain)!=null&&s.ready&&!this.graphics3d.updating)}async initializeController(){const i=this.createController();this.pendingController=i,await i.when(),this.setControllerWhenInitialized(i)}async setControllerWhenInitialized(i){try{await this.when()}catch{}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await Ge(this.view,"basemapTerrain.ready"),this.beforeSetController(i),this.pendingController=null,this.controller=i,this.loadedGraphics=i.graphics,this.notifyChange("updating")):this.destroyPendingController()}updateClippingExtent(i){if(this.clippingExtent=i,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=i,!0}}validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return Promise.reject(new M("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}}_getResourceInfo(){const i=this.controller&&this.controller instanceof p?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:i?i.maximumNumberOfFeatures:-1,totalNumberOfFeatures:i?i.serviceDataCount:-1,nodes:0,core:this.graphics3d.graphicsCore.performanceInfo,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.graphics3d.frustumVisibility.suspended,visibilityScale:!this.graphics3d.scaleVisibility.suspended}}get performanceInfo(){return this._getResourceInfo()}};return h([o()],t.prototype,"loadedGraphics",void 0),h([o()],t.prototype,"suspended",void 0),h([o({readOnly:!0})],t.prototype,"legendEnabled",null),h([o()],t.prototype,"updating",void 0),h([o()],t.prototype,"controller",void 0),h([o()],t.prototype,"graphics3d",void 0),h([o({readOnly:!0})],t.prototype,"updatePolicy",void 0),h([o({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),h([o({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),h([o({readOnly:!0})],t.prototype,"suspendInfo",void 0),t=h([O("esri.views.3d.layers.FeatureLikeLayerView3D")],t),t};class Ft extends Qe{constructor(){super(...arguments),this._set=new Set}clear(){if(this._set.size>0){const t=this.toArray();this._set.clear(),this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:t})}}get length(){return this._set.size}addMany(t){if(t.length!==0){for(const i of t)this._set.add(i);this.emit("after-changes",{type:1}),this.emit("change",{added:t,removed:[]})}}remove(t){this._set.delete(t)&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:[t]}))}removeMany(t){const i=[];for(const s of t)this._set.delete(s)&&i.push(s);i.length>0&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:i}))}toArray(){return[...this._set]}find(t){let i;return ke(this._set,s=>!!t(s)&&(i=s,!0)),i}forEach(t){this._set.forEach(i=>t(i))}}export{yt as E,p as S,gt as U,Ft as s};
