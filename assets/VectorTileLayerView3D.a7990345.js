import{lq as z,lr as B,eM as N,r as _,a4 as A,b7 as G,ls as U,lt as F,lu as j,aX as x,bv as W,bR as f,i as K,aD as Q,lv as X,lw as Y,aM as J,f3 as Z,cm as ee,a as M,e as C,y as w,b as te}from"./index.a33ecea7.js";import{r as ie,i as se,l as re,n as le,t as ae}from"./TileInfoViewPOT.cfab7f4b.js";import{i as k,a as p}from"./StyleDefinition.630dd2fa.js";import{d as ne,m as oe,c as he,a as ce,M as de}from"./WGLBrushVTLSymbol.4ddaefec.js";import{o as ue}from"./VTLMaterialManager.ad382f06.js";import{l as P}from"./StyleRepository.16f5582f.js";import{n as ge}from"./LayerView3D.f81b9bae.js";import{c as me}from"./TiledLayerView3D.7ebbd153.js";import{u as pe}from"./LayerView.88bcfa48.js";import"./Rect.85ff00e1.js";import"./rasterizingUtils.a4b9dda6.js";import"./definitions.618cbc79.js";import"./enums.a12f2baf.js";import"./number.e821bc3e.js";import"./GeometryUtils.b69b6363.js";import"./resolver.110e6527.js";import"./ShaderCompiler.915a06d7.js";import"./programUtils.00364c53.js";import"./GeometryUtils.b33f0569.js";class _e{constructor(e,t){this._lockedSchemaPixelSize=e,this._isGCS=t}getLevelRowColumn(e){return this._isGCS?[e[0],e[1]>>1,e[2]>>1]:this._lockedSchemaPixelSize===256&&e[0]>0?[e[0]-1,e[1]>>1,e[2]>>1]:e}adjustLevel(e){return this._isGCS?e:this._lockedSchemaPixelSize===256?e>0?e-1:0:e}getShift(e,t){let s=0,l=0;return(this._lockedSchemaPixelSize===256||this._isGCS)&&(e[2]%2&&(s=t),e[1]%2&&(l=t)),[s,l]}getScale(e){if(this._isGCS){if(this._lockedSchemaPixelSize===512)return 4}else if(this._lockedSchemaPixelSize===256&&e===0)return 1;return 2}}function ye(a,e){const t=[],s=new ie(4096,t,()=>{const r=new z;return r.show=!1,r.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),r.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),r}),l=new se(t,s,(r,i,o)=>new re(r,i,o,a.styleRepository,a.key.level,0),(r,i)=>{B(r,i,!1)},()=>0,r=>{const i=e.getStyleLayerByUID(r).getLayoutProperty("visibility");return!i||i.getValue()!==k.NONE});t.push(a),s.add(a),l.setScreenSize(512,512),l.continue(1/0)}class H extends le{constructor(e,t,s,l,r){super(e,t,s),this._memCache=l,this._loader=r,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new ae(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,s,l){const r=new N(e,t,s,0);let i=this._memCache.get(r.id);if(_(i))return i.retain(),i;const o=await this._getVectorTileData(r);if(A(l),!this._layer)return null;if(i=this._memCache.get(r.id),_(i))return i.retain(),i;const h=this._layer.tileInfo.getTileBounds(G(),r),y=this._tileInfoView.getTileResolution(e);return i=new U(r,y,h[0],h[3],512,512,this._styleRepository,this._memCache),_(o)?(i.setData(o),i.retain(),this._memCache.put(r.id,i,i.memoryUsage*i.referenced,F)):i.setData(null),i.neededForCoverage=!0,i.transforms.tileUnitsToPixels=j(1/8,0,0,0,1/8,0,0,0,1),ye(i,this._styleRepository),i}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,l={signal:s.signal},r=this._getParsedVectorTileData(e,l).then(i=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),i)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,r),this._ongoingRequestToController.set(t,s),r}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(s=>this.parseTileData({key:e,data:s},t))}request(e,t){return this._loader.request(e,"binary",t)}}const fe={vtlBackground:ne,vtlFill:oe,vtlLine:he,vtlCircle:ce,vtlSymbol:de},$=1e-6;class E{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new ue}dispose(){this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache=null),this._vtlMaterialManager=x(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,s){const{context:l}=e,r=s.layers;s.backgroundBucketIds.length>0&&(e.renderPass="background",s.backgroundBucketIds.forEach(i=>this._renderStyleLayer(s.getLayerById(i),e,t,!0))),l.setBlendingEnabled(!1),l.setDepthTestEnabled(!0),l.setDepthWriteEnabled(!0),l.setDepthFunction(W.LEQUAL),e.renderPass="opaque";for(let i=r.length-1;i>=0;i--)this._renderStyleLayer(r[i],e,t,!1);l.setDepthWriteEnabled(!1),l.setBlendingEnabled(!0),l.setBlendFunctionSeparate(f.ONE,f.ONE_MINUS_SRC_ALPHA,f.ONE,f.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let i=0;i<r.length;i++)this._renderStyleLayer(r[i],e,t,!1);l.setDepthTestEnabled(!1),l.bindVAO()}_renderStyleLayer(e,t,s,l=!1){if(!(l||e&&s.layerData.has(e.uid)))return;const r=e.getLayoutProperty("visibility");if(r&&r.getValue()===k.NONE)return;const{renderPass:i}=t;let o;switch(e.type){case p.BACKGROUND:if(i!=="background")return;o="vtlBackground";break;case p.FILL:if(i!=="opaque"&&t.renderPass!=="translucent")return;o="vtlFill";break;case p.LINE:if(i!=="translucent")return;o="vtlLine";break;case p.CIRCLE:if(i!=="translucent")return;o="vtlCircle";break;case p.SYMBOL:if(i!=="translucent")return;o="vtlSymbol"}const h=t.displayLevel;e.minzoom!==void 0&&e.minzoom>h+$||e.maxzoom!==void 0&&e.maxzoom<=h-$||(t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,s,o))}_drawWithBrush(e,t,s){if(!this._brushCache.has(s)){const l=fe[s];this._brushCache.set(s,new l)}this._brushCache.get(s).drawMany(e,[t])}}let g=class extends me(ge(pe)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d"}initialize(){if(K(this.layer.fullExtent))return void this.addResolvingPromise(Promise.reject(new Q("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:a,spatialReference:e,state:t,viewingMode:s}=this.view,l=s==="local"&&!X(e)||Y.force512VTL,r=this.layer.tileInfo.spatialReference.isGeographic,i=l?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,r?1:2),o=this._getTileInfoSupportError(i,this.layer.fullExtent);if(_(o))return this.addResolvingPromise(Promise.reject(o));const h=J(()=>{var n,c;return(c=(n=this.view)==null?void 0:n.basemapTerrain)==null?void 0:c.tilingSchemeLocked}).then(()=>{var m;const n=a.tilingScheme,c=n.pixelSize;let u;if(this.schemaHelper=new _e(c,_(a.spatialReference)&&a.spatialReference.isGeographic),c===256){const v=this.layer.tileInfo.spatialReference.isGeographic;u=this.layer.tileInfo.getOrCreateCompatible(256,v?1:2)}else u=(m=this.view.spatialReference)!=null&&m.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const d=this._getTileInfoCompatibilityError(u,n);if(d)throw d;this.tileInfo=u});this._tileHandlerController=new AbortController;const y=this.view.resourceController;this._memCache=y.memoryController.newCache(this.layer.uid,n=>{n.release()});const q=new P(this.layer.currentStyleInfo.style),b=a.mapTileRequester;this._tileHandler=new H(this.layer,q,t.contentPixelRatio,this._memCache,b);const R=this._tileHandlerController.signal,S=n=>y.immediate.schedule(n),T=this._tileHandler.start({signal:R,schedule:S}),L=this._tileHandler.spriteMosaic;L.then(n=>{!Z(R)&&this._tileHandler&&(this.painter=new E(n,this._tileHandler.glyphMosaic))}),T.then(()=>this._tileHandlerController=null),this.updatingHandles.add(()=>{var n;return{style:this.layer.currentStyleInfo.style,pixelRatio:(n=this.view.state)==null?void 0:n.contentPixelRatio}},({style:n,pixelRatio:c})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const u=new P(n),d=new H(this.layer,u,c,this._memCache,b),m=d.start({signal:this._tileHandlerController.signal,schedule:S}),v=d.spriteMosaic;m.then(()=>this._tileHandlerController=null),this.updatingHandles.addPromise(Promise.all([m,v]).then(([,O])=>{const V=this._tileHandler,I=this.painter;this.painter=new E(O,d.glyphMosaic),this._tileHandler=d,this.emit("data-changed"),V.destroy(),I&&I.dispose()}))});const D=Promise.all([h,T,L]);this.addResolvingPromise(D)}destroy(){this.painter=x(this.painter),this._tileHandlerController=ee(this._tileHandlerController),M(this._tileHandler),this._memCache=M(this._memCache),this._tileHandler=null}get dataLevelRange(){const a=this.tileInfo.lods,e=a[0].scale,t=a[a.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return s.minLevel===1&&this.tileInfo.size[0]===256&&(s.minLevel=0),s}async fetchTile(a,e,t,s){return this._tileHandler.getVectorTile(a,e,t,s)}};C([w()],g.prototype,"layer",void 0),C([w()],g.prototype,"dataLevelRange",null),C([w()],g.prototype,"updatingProgressValue",void 0),g=C([te("esri.views.3d.layers.VectorTileLayerView3D")],g);const Ve=g;export{Ve as default};
