import{f4 as x,ab as m,r as g,i as b,ac as I,gg as v,a4 as z,dy as y,ew as _}from"./index.a33ecea7.js";function k(a=!1,t){if(a){const{elevationInfo:e,alignPointsInFeatures:n,spatialReference:s}=t;return new V(e,n,s)}return new w}class w{async alignCandidates(t,e){return t}notifyElevationSourceChange(){}}const j=1024;class V{constructor(t,e,n){this._elevationInfo=t,this._alignPointsInFeatures=e,this.spatialReference=n,this._alignmentsCache=new x(j),this._cacheVersion=0,this._metersPerVerticalUnit=m(n)}async alignCandidates(t,e){const n=this._elevationInfo;return g(n)&&n.mode==="absolute-height"&&!n.featureExpressionInfo?(this._alignAbsoluteElevationCandidates(t,n),t):this._alignComputedElevationCandidates(t,e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}_alignAbsoluteElevationCandidates(t,e){const{offset:n,unit:s}=e;if(b(n))return;const i=n*(I(s!=null?s:"meters")/this._metersPerVerticalUnit);for(const o of t)switch(o.type){case"edge":o.start.z+=i,o.end.z+=i;continue;case"vertex":o.target.z+=i;continue}}async _alignComputedElevationCandidates(t,e){const n=new Map;for(const r of t)v(n,r.objectId,S).push(r);const[s,i,o]=this._prepareQuery(n),c=await this._alignPointsInFeatures(s,e);if(z(e),o!==this._cacheVersion)return this._alignComputedElevationCandidates(t,e);this._applyCacheAndResponse(s,c,i);const{drapedObjectIds:h,failedObjectIds:d}=c,f=[];for(const r of t){const{objectId:u}=r;h.has(u)&&r.type==="edge"&&(r.draped=!0),d.has(u)||f.push(r)}return f}_prepareQuery(t){const e=[],n=[];for(const[s,i]of t){const o=[];for(const c of i)this._addToQueriesOrCachedResult(s,c.target,o,n),c.type==="edge"&&(this._addToQueriesOrCachedResult(s,c.start,o,n),this._addToQueriesOrCachedResult(s,c.end,o,n));o.length!==0&&e.push({objectId:s,points:o})}return[e,n,this._cacheVersion]}_addToQueriesOrCachedResult(t,e,n,s){const i=C(t,e),o=this._alignmentsCache.get(i);g(o)?s.push(new E(e,o)):n.push(e)}_applyCacheAndResponse(t,{elevations:e,drapedObjectIds:n,failedObjectIds:s},i){for(const h of i)h.apply();let o=0;const c=this._alignmentsCache;for(const{objectId:h,points:d}of t){if(s.has(h)){o+=d.length;continue}const f=!n.has(h);for(const r of d){const u=C(h,r),l=e[o++];r.z=l,f&&c.put(u,l,1)}}}}class E{constructor(t,e){this.point=t,this.z=e}apply(){this.point.z=this.z}}function C(a,{x:t,y:e,z:n}){return`${a}-${t}-${e}-${n!=null?n:0}}`}function S(){return[]}class O{filter(t,e){return e}notifyElevationSourceChange(){}}class R{filter(t,e){const{point:n,distance:s}=t,{z:i}=n;if(i==null||e.length===0)return e;const o=A(s),c=this._updateCandidatesTo3D(e,n,o).filter(Q);return c.sort(F),c}_updateCandidatesTo3D(t,e,n){for(const s of t)switch(s.type){case"edge":T(s,e,n);continue;case"vertex":P(s,e,n);continue}return t}}function Q(a){return a.distance<=1}function B(a=!1){return a?new R:new O}function T(a,t,{x:e,y:n,z:s}){const{start:i,end:o,target:c}=a;a.draped||M(c,t,i,o);const h=(t.x-c.x)/e,d=(t.y-c.y)/n,f=(t.z-c.z)/s;a.distance=Math.sqrt(h*h+d*d+f*f)}function M(a,t,e,n){const s=n.x-e.x,i=n.y-e.y,o=n.z-e.z,c=s*s+i*i+o*o,h=(t.x-e.x)*s+(t.y-e.y)*i+o*(t.z-e.z),d=Math.min(1,Math.max(0,h/c)),f=e.x+s*d,r=e.y+i*d,u=e.z+o*d;a.x=f,a.y=r,a.z=u}function P(a,t,{x:e,y:n,z:s}){const{target:i}=a,o=(t.x-i.x)/e,c=(t.y-i.y)/n,h=(t.z-i.z)/s,d=Math.sqrt(o*o+c*c+h*h);a.distance=d}function A(a){return typeof a=="number"?{x:a,y:a,z:a}:a}function F(a,t){return a.distance-t.distance}function G(a=!1,t){return a?new U(t):new q}class q{async fetch(){return[]}notifySymbologyChange(){}}const D=1024;class U{constructor(t){this._getSymbologyCandidates=t,this._candidatesCache=new x(D),this._cacheVersion=0}async fetch(t,e){if(t.length===0)return[];const n=[],s=[],i=this._candidatesCache;for(const r of t){const u=$(r),l=i.get(u);if(l)for(const p of l)s.push(y(p));else n.push(r),i.put(u,[],1)}if(n.length===0)return s;const o=this._cacheVersion,{candidates:c,sourceCandidateIndices:h}=await this._getSymbologyCandidates(n,e);if(z(e),o!==this._cacheVersion)return this.fetch(t,e);const d=[],{length:f}=c;for(let r=0;r<f;++r){const u=c[r],l=$(n[h[r]]),p=i.get(l);p.push(u),i.put(l,p,p.length),d.push(y(u))}return s.concat(d)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function $(a){var t,e,n;switch(a.type){case"vertex":{const{objectId:s,target:i}=a,o=`${s}-vertex-${i.x}-${i.y}-${(t=i.z)!=null?t:0}`;return _(o).toString()}case"edge":{const{objectId:s,start:i,end:o}=a,c=`${s}-edge-${i.x}-${i.y}-${(e=i.z)!=null?e:0}-to-${o.x}-${o.y}-${(n=o.z)!=null?n:0}`;return _(c).toString()}default:return""}}export{B as a,G as n,k as r};
