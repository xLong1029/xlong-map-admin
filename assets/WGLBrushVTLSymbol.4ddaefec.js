import{fq as oe,bX as le,r as V,c2 as W,cC as J,bv as C,bS as O,bJ as fe,bU as ce,bP as ue,i as $,c4 as z,cD as de,fI as K,dT as pe}from"./index.a33ecea7.js";import{_ as A,$ as ie,a0 as Z}from"./definitions.618cbc79.js";import{T as k}from"./enums.a12f2baf.js";import{M as j}from"./number.e821bc3e.js";import{r as B,l as N,n as ee}from"./StyleDefinition.630dd2fa.js";import{c as te}from"./GeometryUtils.b69b6363.js";class Q{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(n,e){}draw(n,e,t){}drawMany(n,e,t){for(const l of e)l.visible&&this.draw(n,l,t)}}class he extends Q{constructor(){super(...arguments),this._color=oe(1,0,0,1),this._patternMatrix=le(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(n,e){const{context:t,painter:l,styleLayerUID:o,requestRender:a,allowDelayedRender:E}=n;this._loadWGLResources(n);const y=n.displayLevel,f=n.styleLayer,P=f.backgroundMaterial,_=l.vectorTilesMaterialManager,v=f.getPaintValue("background-color",y),m=f.getPaintValue("background-opacity",y),D=f.getPaintValue("background-pattern",y),w=D!==void 0,U=v[3]*m,x=1|window.devicePixelRatio,h=n.spriteMosaic;let I,T;const c=x>ie?2:1,d=n.drawPhase===k.HITTEST,p=this._programOptions;p.id=d,p.pattern=w;const s=_.getMaterialProgram(t,P,p);if(E&&V(a)&&!s.compiled)a();else{if(t.bindVAO(this._vao),t.useProgram(s),w){const i=h.getMosaicItemPosition(D,!0);if(V(i)){const{tl:u,br:r,page:M}=i;I=r[0]-u[0],T=r[1]-u[1];const g=h.getPageSize(M);V(g)&&(h.bind(t,W.LINEAR,M,A),s.setUniform4f("u_tlbr",u[0],u[1],r[0],r[1]),s.setUniform2fv("u_mosaicSize",g),s.setUniform1i("u_texture",A))}s.setUniform1f("u_opacity",m)}else this._color[0]=U*v[0],this._color[1]=U*v[1],this._color[2]=U*v[2],this._color[3]=U,s.setUniform4fv("u_color",this._color);if(s.setUniform1f("u_depth",f.z||0),d){const i=j(o+1);s.setUniform4fv("u_id",i)}for(const i of e){if(s.setUniform1f("u_coord_range",i.rangeX),s.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),w){const u=Math.max(2**(Math.round(y)-i.key.level),1),r=c*i.width*u,M=r/J(I),g=r/J(T);this._patternMatrix[0]=M,this._patternMatrix[4]=g,s.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}t.setStencilFunction(C.EQUAL,0,255),t.drawArrays(O.TRIANGLE_STRIP,0,4)}}}_loadWGLResources(n){if(this._vao)return;const{context:e,styleLayer:t}=n,l=t.backgroundMaterial,o=new Int8Array([0,0,1,0,0,1,1,1]),a=fe.createVertex(e,ce.STATIC_DRAW,o),E=new ue(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:a});this._vao=E}}class Pe extends Q{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(n,e){const{context:t,displayLevel:l,requiredLevel:o,state:a,drawPhase:E,painter:y,spriteMosaic:f,styleLayerUID:P,requestRender:_,allowDelayedRender:v}=n;if(!e.some(p=>{var s,i;return(i=(s=p.layerData.get(P))==null?void 0:s.circleIndexCount)!=null?i:!1}))return;const m=n.styleLayer,D=m.circleMaterial,w=y.vectorTilesMaterialManager,U=1.2,x=m.getPaintValue("circle-translate",l),h=m.getPaintValue("circle-translate-anchor",l),I=E===k.HITTEST,T=this._programOptions;T.id=I;const c=w.getMaterialProgram(t,D,T);if(v&&V(_)&&!c.compiled)return void _();t.useProgram(c),c.setUniformMatrix3fv("u_displayMat3",h===B.VIEWPORT?a.displayMat3:a.displayViewMat3),c.setUniform2fv("u_circleTranslation",x),c.setUniform1f("u_depth",m.z),c.setUniform1f("u_antialiasingWidth",U);let d=-1;if(I){const p=j(P+1);c.setUniform4fv("u_id",p)}for(const p of e){if(!p.layerData.has(P))continue;p.key.level!==d&&(d=p.key.level,D.setDataUniforms(c,l,m,d,f));const s=p.layerData.get(P);if(!s.circleIndexCount)continue;s.prepareForRendering(t);const i=s.circleVertexArrayObject;$(i)||(t.bindVAO(i),c.setUniformMatrix3fv("u_dvsMat3",p.transforms.dvs),o!==p.key.level?t.setStencilFunction(C.EQUAL,p.stencilRef,255):t.setStencilFunction(C.GREATER,255,255),t.drawElements(O.TRIANGLES,s.circleIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.circleIndexStart),p.triangleCount+=s.circleIndexCount/3)}}}const ae=1/65536;class ve extends Q{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(n,e){const{displayLevel:t,drawPhase:l,renderPass:o,spriteMosaic:a,styleLayerUID:E}=n;let y=!1;for(const c of e)if(c.layerData.has(E)){const d=c.layerData.get(E);if(d.fillIndexCount>0||d.outlineIndexCount>0){y=!0;break}}if(!y)return;const f=n.styleLayer,P=f.getPaintProperty("fill-pattern"),_=P!==void 0,v=_&&P.isDataDriven;let m;if(_&&!v){const c=P.getValue(t);m=a.getMosaicItemPosition(c,!0)}const D=!_&&f.getPaintValue("fill-antialias",t);let w=!0,U=1;if(!_){const c=f.getPaintProperty("fill-color"),d=f.getPaintProperty("fill-opacity");if(!(c!=null&&c.isDataDriven)&&!(d!=null&&d.isDataDriven)){const p=f.getPaintValue("fill-color",t);U=f.getPaintValue("fill-opacity",t)*p[3],U>=1&&(w=!1)}}if(w&&o==="opaque")return;let x;l===k.HITTEST&&(x=j(E+1));const h=f.getPaintValue("fill-translate",t),I=f.getPaintValue("fill-translate-anchor",t);(w||o!=="translucent")&&this._drawFill(n,E,f,e,h,I,_,m,v,x);const T=!f.hasDataDrivenOutlineColor&&f.outlineUsesFillColor&&U<1;D&&o!=="opaque"&&!T&&this._drawOutline(n,E,f,e,h,I,x)}_drawFill(n,e,t,l,o,a,E,y,f,P){if(E&&!f&&$(y))return;const{context:_,displayLevel:v,state:m,drawPhase:D,painter:w,pixelRatio:U,spriteMosaic:x,requestRender:h,allowDelayedRender:I}=n,T=t.fillMaterial,c=w.vectorTilesMaterialManager,d=U>ie?2:1,p=D===k.HITTEST,s=this._fillProgramOptions;s.id=p,s.pattern=E;const i=c.getMaterialProgram(_,T,s);if(I&&V(h)&&!i.compiled)return void h();if(_.useProgram(i),V(y)){const{page:r}=y,M=x.getPageSize(r);V(M)&&(x.bind(_,W.LINEAR,r,A),i.setUniform2fv("u_mosaicSize",M),i.setUniform1i("u_texture",A))}i.setUniformMatrix3fv("u_displayMat3",a===B.VIEWPORT?m.displayMat3:m.displayViewMat3),i.setUniform2fv("u_fillTranslation",o),i.setUniform1f("u_depth",t.z+ae),p&&i.setUniform4fv("u_id",P);let u=-1;for(const r of l){if(!r.layerData.has(e))continue;r.key.level!==u&&(u=r.key.level,T.setDataUniforms(i,v,t,u,x));const M=r.layerData.get(e);if(!M.fillIndexCount)continue;M.prepareForRendering(_);const g=M.fillVertexArrayObject;if(!$(g)){if(_.bindVAO(g),i.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),_.setStencilFunction(C.EQUAL,r.stencilRef,255),E){const L=Math.max(2**(Math.round(v)-r.key.level),1),R=r.rangeX/(d*r.width*L);i.setUniform1f("u_patternFactor",R)}if(f){const L=M.patternMap;if(!L)continue;for(const[R,G]of L){const F=x.getPageSize(R);V(F)&&(x.bind(_,W.LINEAR,R,A),i.setUniform2fv("u_mosaicSize",F),i.setUniform1i("u_texture",A),_.drawElements(O.TRIANGLES,G[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*G[0]))}}else _.drawElements(O.TRIANGLES,M.fillIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*M.fillIndexStart);r.triangleCount+=M.fillIndexCount/3}}}_drawOutline(n,e,t,l,o,a,E){const{context:y,displayLevel:f,state:P,drawPhase:_,painter:v,pixelRatio:m,spriteMosaic:D,requestRender:w,allowDelayedRender:U}=n,x=t.outlineMaterial,h=v.vectorTilesMaterialManager,I=.75/m,T=_===k.HITTEST,c=this._outlineProgramOptions;c.id=T;const d=h.getMaterialProgram(y,x,c);if(U&&V(w)&&!d.compiled)return void w();y.useProgram(d),d.setUniformMatrix3fv("u_displayMat3",a===B.VIEWPORT?P.displayMat3:P.displayViewMat3),d.setUniform2fv("u_fillTranslation",o),d.setUniform1f("u_depth",t.z+ae),d.setUniform1f("u_outline_width",I),T&&d.setUniform4fv("u_id",E);let p=-1;for(const s of l){if(!s.layerData.has(e))continue;s.key.level!==p&&(p=s.key.level,x.setDataUniforms(d,f,t,p,D));const i=s.layerData.get(e);if(i.prepareForRendering(y),!i.outlineIndexCount)continue;const u=i.outlineVertexArrayObject;$(u)||(y.bindVAO(u),d.setUniformMatrix3fv("u_dvsMat3",s.transforms.dvs),y.setStencilFunction(C.EQUAL,s.stencilRef,255),y.drawElements(O.TRIANGLES,i.outlineIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i.outlineIndexStart),s.triangleCount+=i.outlineIndexCount/3)}}}class Te extends Q{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(n,e){const{context:t,displayLevel:l,state:o,drawPhase:a,painter:E,pixelRatio:y,spriteMosaic:f,styleLayerUID:P,requestRender:_,allowDelayedRender:v}=n;if(!e.some(g=>{var L,R;return(R=(L=g.layerData.get(P))==null?void 0:L.lineIndexCount)!=null?R:!1}))return;const m=n.styleLayer,D=m.lineMaterial,w=E.vectorTilesMaterialManager,U=m.getPaintValue("line-translate",l),x=m.getPaintValue("line-translate-anchor",l),h=m.getPaintProperty("line-pattern"),I=h!==void 0,T=I&&h.isDataDriven;let c,d;if(I&&!T){const g=h.getValue(l);c=f.getMosaicItemPosition(g)}let p=!1;if(!I){const g=m.getPaintProperty("line-dasharray");if(d=g!==void 0,p=d&&g.isDataDriven,d&&!p){const L=g.getValue(l),R=m.getDashKey(L,m.getLayoutValue("line-cap",l));c=f.getMosaicItemPosition(R)}}const s=1/y,i=a===k.HITTEST,u=this._programOptions;u.id=i,u.pattern=I,u.sdf=d;const r=w.getMaterialProgram(t,D,u);if(v&&V(_)&&!r.compiled)return void _();if(t.useProgram(r),r.setUniformMatrix3fv("u_displayViewMat3",o.displayViewMat3),r.setUniformMatrix3fv("u_displayMat3",x===B.VIEWPORT?o.displayMat3:o.displayViewMat3),r.setUniform2fv("u_lineTranslation",U),r.setUniform1f("u_depth",m.z),r.setUniform1f("u_antialiasing",s),i){const g=j(P+1);r.setUniform4fv("u_id",g)}if(c&&V(c)){const{page:g}=c,L=f.getPageSize(g);V(L)&&(f.bind(t,W.LINEAR,g,A),r.setUniform2fv("u_mosaicSize",L),r.setUniform1i("u_texture",A))}let M=-1;for(const g of e){if(!g.layerData.has(P))continue;g.key.level!==M&&(M=g.key.level,D.setDataUniforms(r,l,m,M,f));const L=2**(l-M)/y;r.setUniform1f("u_zoomFactor",L);const R=g.layerData.get(P);if(!R.lineIndexCount)continue;R.prepareForRendering(t);const G=R.lineVertexArrayObject;if(!$(G)){if(t.bindVAO(G),r.setUniformMatrix3fv("u_dvsMat3",g.transforms.dvs),t.setStencilFunction(C.EQUAL,g.stencilRef,255),T||p){const F=R.patternMap;if(!F)continue;for(const[Y,S]of F){const q=f.getPageSize(Y);V(q)&&(f.bind(t,W.LINEAR,Y,A),r.setUniform2fv("u_mosaicSize",q),r.setUniform1i("u_texture",A),t.drawElements(O.TRIANGLES,S[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*S[0]))}}else t.drawElements(O.TRIANGLES,R.lineIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*R.lineIndexStart);g.triangleCount+=R.lineIndexCount/3}}}}const me=1/65536;class xe extends Q{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=de()}dispose(){}drawMany(n,e){const{drawPhase:t,styleLayerUID:l}=n,o=n.styleLayer;let a;t===k.HITTEST&&(a=j(l+1)),this._drawIcons(n,o,e,a),this._drawText(n,o,e,a)}_drawIcons(n,e,t,l){const{context:o,displayLevel:a,drawPhase:E,painter:y,spriteMosaic:f,state:P,styleLayerUID:_,requestRender:v,allowDelayedRender:m}=n,D=e.iconMaterial,w=y.vectorTilesMaterialManager;let U,x=!1;for(const M of t)if(M.layerData.has(_)&&(U=M.layerData.get(_),U.iconPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const h=e.getPaintValue("icon-translate",a),I=e.getPaintValue("icon-translate-anchor",a);let T=e.getLayoutValue("icon-rotation-alignment",a);T===N.AUTO&&(T=e.getLayoutValue("symbol-placement",a)===ee.POINT?N.VIEWPORT:N.MAP);const c=T===N.MAP,d=e.getLayoutValue("icon-keep-upright",a)&&c,p=U.isIconSDF,s=E===k.HITTEST,i=this._iconProgramOptions;i.id=s,i.sdf=p;const u=w.getMaterialProgram(o,D,i);if(m&&V(v)&&!u.compiled)return void v();o.useProgram(u),u.setUniformMatrix3fv("u_displayViewMat3",T===N.MAP?P.displayViewMat3:P.displayMat3),u.setUniformMatrix3fv("u_displayMat3",I===B.VIEWPORT?P.displayMat3:P.displayViewMat3),u.setUniform2fv("u_iconTranslation",h),u.setUniform1f("u_depth",e.z),u.setUniform1f("u_mapRotation",te(P.rotation)),u.setUniform1f("u_keepUpright",d?1:0),u.setUniform1f("u_level",10*a),u.setUniform1i("u_texture",A),u.setUniform1f("u_fadeDuration",K/1e3),s&&u.setUniform4fv("u_id",l);let r=-1;for(const M of t){if(!M.layerData.has(_)||(M.key.level!==r&&(r=M.key.level,D.setDataUniforms(u,a,e,r,f)),U=M.layerData.get(_),U.iconPerPageElementsMap.size===0))continue;U.prepareForRendering(o),U.updateOpacityInfo();const g=U.iconVertexArrayObject;if(!$(g)){o.bindVAO(g),u.setUniformMatrix3fv("u_dvsMat3",M.transforms.dvs),u.setUniform1f("u_time",(performance.now()-U.lastOpacityUpdate)/1e3);for(const[L,R]of U.iconPerPageElementsMap)this._renderIconRange(n,u,R,L,M)}}}_renderIconRange(n,e,t,l,o){const{context:a,spriteMosaic:E}=n;this._spritesTextureSize[0]=E.getWidth(l)/4,this._spritesTextureSize[1]=E.getHeight(l)/4,e.setUniform2fv("u_mosaicSize",this._spritesTextureSize),E.bind(a,W.LINEAR,l,A),a.setStencilTestEnabled(!0),a.setStencilFunction(C.GREATER,255,255),a.setStencilWriteMask(0),a.drawElements(O.TRIANGLES,t[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3}_drawText(n,e,t,l){const{context:o,displayLevel:a,drawPhase:E,glyphMosaic:y,painter:f,pixelRatio:P,spriteMosaic:_,state:v,styleLayerUID:m,requestRender:D,allowDelayedRender:w}=n,U=e.textMaterial,x=f.vectorTilesMaterialManager;let h,I=!1;for(const b of t)if(b.layerData.has(m)&&(h=b.layerData.get(m),h.glyphPerPageElementsMap.size>0)){I=!0;break}if(!I)return;const T=e.getPaintProperty("text-opacity");if(T&&!T.isDataDriven&&T.getValue(a)===0)return;const c=e.getPaintProperty("text-color"),d=!c||c.isDataDriven||c.getValue(a)[3]>0,p=e.getPaintProperty("text-halo-width"),s=e.getPaintProperty("text-halo-color"),i=(!p||p.isDataDriven||p.getValue(a)>0)&&(!s||s.isDataDriven||s.getValue(a)[3]>0);if(!d&&!i)return;const u=24/8;let r=e.getLayoutValue("text-rotation-alignment",a);r===N.AUTO&&(r=e.getLayoutValue("symbol-placement",a)===ee.POINT?N.VIEWPORT:N.MAP);const M=r===N.MAP,g=e.getLayoutValue("text-keep-upright",a)&&M,L=E===k.HITTEST,R=.8*u/P;this._glyphTextureSize||(this._glyphTextureSize=pe(y.width/4,y.height/4));const G=e.getPaintValue("text-translate",a),F=e.getPaintValue("text-translate-anchor",a),Y=this._sdfProgramOptions;Y.id=L;const S=x.getMaterialProgram(o,U,Y);if(w&&V(D)&&!S.compiled)return void D();o.useProgram(S),S.setUniformMatrix3fv("u_displayViewMat3",r===N.MAP?v.displayViewMat3:v.displayMat3),S.setUniformMatrix3fv("u_displayMat3",F===B.VIEWPORT?v.displayMat3:v.displayViewMat3),S.setUniform2fv("u_textTranslation",G),S.setUniform1f("u_depth",e.z+me),S.setUniform2fv("u_mosaicSize",this._glyphTextureSize),S.setUniform1f("u_mapRotation",te(v.rotation)),S.setUniform1f("u_keepUpright",g?1:0),S.setUniform1f("u_level",10*a),S.setUniform1i("u_texture",Z),S.setUniform1f("u_antialiasingWidth",R),S.setUniform1f("u_fadeDuration",K/1e3),L&&S.setUniform4fv("u_id",l);let q=-1;for(const b of t){if(!b.layerData.has(m)||(b.key.level!==q&&(q=b.key.level,U.setDataUniforms(S,a,e,q,_)),h=b.layerData.get(m),h.glyphPerPageElementsMap.size===0))continue;h.prepareForRendering(o),h.updateOpacityInfo();const X=h.textVertexArrayObject;if($(X))continue;o.bindVAO(X),S.setUniformMatrix3fv("u_dvsMat3",b.transforms.dvs),o.setStencilTestEnabled(!0),o.setStencilFunction(C.GREATER,255,255),o.setStencilWriteMask(0);const re=(performance.now()-h.lastOpacityUpdate)/1e3;S.setUniform1f("u_time",re),h.glyphPerPageElementsMap.forEach((ne,se)=>{this._renderGlyphRange(o,ne,se,y,S,i,d,b)})}}_renderGlyphRange(n,e,t,l,o,a,E,y){l.bind(n,W.LINEAR,t,Z),a&&(o.setUniform1f("u_halo",1),n.drawElements(O.TRIANGLES,e[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),y.triangleCount+=e[1]/3),E&&(o.setUniform1f("u_halo",0),n.drawElements(O.TRIANGLES,e[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),y.triangleCount+=e[1]/3)}}export{xe as M,Pe as a,Te as c,he as d,ve as m,Q as t};
