import{i as g,nc as Tt,nd as xt,r as p,ak as b,ah as z,n2 as _,lM as Dt,ad as xe,ne as Ge,lY as Fe,h9 as Ue,h4 as k,l6 as j,iu as V,nf as et,mG as Q,l7 as At,gQ as De,n7 as de,ng as J,nh as Be,hr as zt,iv as ve,e as d,y as c,b as F,d as ae,t as Ae,a as ie,ni as Rt,w as S,G as R,ms as Ht,ae as tt,l as G,nj as kt,nk as Lt,nl as Se,aQ as oe,nm as it,nn as Z,no as ee,np as nt,nq as Vt,nr as Et,ns as re,nt as ze,nu as It,aR as W,nv as Me,nw as we,kQ as Pe,nx as st,ny as Gt,hX as at,nz as Ft,nA as je,nB as ot,nC as Ut,nD as Re,i6 as rt,nE as lt,aN as dt,cc as H,cP as ce,nF as Bt,nG as He,na as jt,nH as Nt,p as qt,nI as Wt,nJ as Qt,m4 as Yt,m5 as Kt,m6 as Xt,nK as Jt,nL as Zt,mn as ue,mj as D,nM as ei,gx as ti,U as Ce,h as be,eN as ii,nN as ni,nO as Ne,ay as ke,nP as $e,nQ as si,mF as K,nR as ai,a9 as oi,aa as ri,kp as li,H as Oe,nS as qe,nT as di,aC as ci,nU as ui,fq as pi,kD as mi,nV as hi,nW as ct,mH as gi,mI as fi,n as We,nX as _i,nY as yi,nZ as Y,mq as vi,mx as Si,F as ut,az as Qe,cm as Ye}from"./index.a33ecea7.js";import{n as Mi}from"./AnalysisView3D.90f8a454.js";import{t as y,r as wi,u as Pi}from"./LengthDimension.e0ead5d6.js";import{v as pt,g as Ci}from"./quantityFormatUtils.f35d4e58.js";import{f as N,g as bi}from"./Segment.05ff5003.js";import{j as $i,y as Oi}from"./euclideanLengthMeasurementUtils.a30cc4ff.js";import{o as Ti}from"./Factory.06c97619.js";import{g as U,n as xi,b as Di,a as Ai}from"./LineVisualElement.ea11337b.js";import{_ as zi}from"./VerticesVisualElement.07fc61c6.js";import{r as Ri}from"./RenderTexture.a9b14f2c.js";import{s as Hi,m as ki,c as Li}from"./analysisViewUtils.786ce4c2.js";import"./TextOverlayItem.90d2b48f.js";import"./measurementUtils.43da56cb.js";import"./settings.3514c0cd.js";function Vi(e,t,i){if(g(e))return null;const n=e.dimensionSegment.startRenderSpace,s=e.dimensionSegment.endRenderSpace,a=$i(n,s,e.spatialReference);if(g(a))return null;const o=t===y.Vertical?Tt(a.value,a.unit,i):xt(a.value,a.unit,i);return pt(a,o)}function pe(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:a}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:a}}function me({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:n,orientation:s},a,o=null){if(g(e)||g(t))return null;const l=ht(p(o)?o.directSegment:new N,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},a),r=p(o)?o.primaryOffsetAxis:b();ge(r,{measureType:n,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,orientation:s,renderCoordsHelper:a});const u=p(o)?o.dimensionSegment:new N;return Le({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&n===y.Vertical?(z(u.startRenderSpace,l.startRenderSpace),z(u.endRenderSpace,l.endRenderSpace)):gt(u,{offsetAxis:r,offset:i,relativeToSegment:l,renderCoordsHelper:a}),{directSegment:l,dimensionSegment:u,primaryOffsetAxis:r,spatialReference:a.spatialReference}}function Ke(e,t,i,n){return t===ne.Start?(z(e.startRenderSpace,i.startRenderSpace),z(e.endRenderSpace,n.startRenderSpace)):(z(e.startRenderSpace,i.endRenderSpace),z(e.endRenderSpace,n.endRenderSpace)),e}var ne;function Ei(e,t,i,n){de(e.startRenderSpace,t.startRenderSpace,i,n),de(e.endRenderSpace,t.endRenderSpace,i,n)}function mt(e,t,i,n){switch(t){case y.Direct:return ht(e,i,n);case y.Horizontal:case y.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,dimension:o,geometry:l}=i;let r;o.measureType===y.Direct?(r=Ii(l,n)===s.z>a.z,t===y.Horizontal&&(r=!r)):r=!Gi(l);const[u,m]=r?[s,a]:[a,s],h=J(m,Fi);return t===y.Horizontal?h.z=u.z:(h.x=u.x,h.y=u.y),n.toRenderCoords(u,e.startRenderSpace),n.toRenderCoords(h,e.endRenderSpace),e}}}function ht(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function Ii(e,t){const i=e.directSegment.eval(.5,_.get()),n=t.worldUpAtPosition(i,_.get()),s=e.dimensionSegment.eval(.5,_.get()),a=k(_.get(),s,i);return!et(a,Q)&&V(a,n)>0}function Gi(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=e.directSegment;return Be(n,t)<Be(s,i)}(function(e){e[e.Start=0]="Start",e[e.End=1]="End"})(ne||(ne={}));const Fi=zt(0,0,0,null);function Ui(e,t,i,n){const{directSegment:s}=i,a=ge(_.get(),{measureType:t,directSegment:s,renderCoordsHelper:n}),o=gt(Bi,{offsetAxis:a,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,_.get()),l=k(_.get(),e,o);return V(l,a)*n.unitInMeters}const Bi=new N;function ge(e,t){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:a,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=t,u=l.eval(.5,_.get()),m=r.worldUpAtPosition(u,_.get()),h=r.worldBasisAtPosition(u,Dt.Y,_.get());switch(i){case y.Horizontal:z(e,m);break;case y.Vertical:V(a,m)<V(o,m)?k(e,o,a):k(e,a,o),j(e,e,m),j(e,e,m);break;case y.Direct:{const f=xe(t.orientation,0);if(Le({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))Ge(le,-Fe(f),m),Ue(e,h,le);else{const w=k(_.get(),o,a),P=j(_.get(),w,m);j(P,P,w),Ge(le,Fe(f),w),Ue(e,P,le)}break}}return et(e,Q)?z(e,h):At(e,e)}const le=De();function Le({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return p(e)&&p(t)&&e.x===t.x&&e.y===t.y}function gt(e,t){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:a},relativeToSegment:o,renderCoordsHelper:l}=t,r=n/l.unitInMeters,[u,m]=ji(s,a,i,r);return de(e.startRenderSpace,o.startRenderSpace,i,u),de(e.endRenderSpace,o.endRenderSpace,i,m),e}function ji(e,t,i,n=0){const s=V(t,i),a=V(e,i),o=Math.abs(s-a)+n;return s>a?[o,n]:[n,o]}function fe(e,t,i){const n=t.directSegment.eval(.5,_.get());return i.worldUpAtPosition(n,e)}function Ve(e,t){const{startRenderSpace:i,endRenderSpace:n}=t.directSegment;return k(e,n,i)}function Ee(e,t,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=t.dimensionSegment;return i.invert?k(e,n,s):k(e,s,n)}function Te(e,t){const i=e.directSegment.eval(.5,_.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}function Ni(e,t){return ve(Ee(qi,e))/t**2}const qi=b();function ft(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(g(t)||g(i))return!1;const n=Oi(t,i);return p(n)&&pt(n,"meters").value>_t}const _t=1e5;function se(e){return p(e.geometry)}let B=class extends ae{constructor(e){super(e),this._handles=new Ae}initialize(){const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles(e.on("change",({added:t,removed:i})=>{for(const n of i)this._removeComputation(n);for(const n of t)this._addComputation(n)}))}destroy(){this._handles=ie(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Rt(this.view)}_addComputation(e){this._handles.has(e)||this._handles.add(S(()=>pe(e),t=>{const{measureType:i}=t;if(ft(t)&&i!==y.Direct){const s=Math.round(Ht(_t,"meters","kilometers"));return tt.getLogger(this.declaredClass).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const n=me(t,this.view.renderCoordsHelper,e.geometry);e.geometry=n,e.result.length=Vi(n,i,this._defaultUnit)},R),e)}_removeComputation(e){this._handles.remove(e)}};d([c({constructOnly:!0})],B.prototype,"analysisViewData",void 0),d([c({constructOnly:!0})],B.prototype,"view",void 0),d([c()],B.prototype,"analysis",null),d([c()],B.prototype,"_defaultUnit",null),B=d([F("esri.views.3d.analysis.Dimension.support.DimensionController")],B);const yt={main:new G([255,127,0])};class Wi{constructor(){this.color=yt.main,this.opacity=.5,this.radius=5}}class Qi{constructor(){this.color=new G([127,127,127]),this.opacity=.5,this.radius=5}}class Yi{constructor(){this.lineSizeFraction=.8}}class Ki{constructor(){this.color=yt.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}}class Xi{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}class Ji{constructor(){this.lineSizeFraction=.25}}class Zi{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}}class en{constructor(){this.color=new G([255,127,0,.5])}}class tn{constructor(){this.pointManipulators=new Wi,this.offsetManipulator=new Ki,this.orientationManipulator=new Xi,this.markers=new Yi,this.labels=new Zi,this.offsetLine=new Ji,this.constraint=new en,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Qi,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}}const v=new tn;class nn{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&t===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const i of wi)t(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(t){switch(t){case y.Direct:return this.direct;case y.Horizontal:return this.horizontal;case y.Vertical:return this.vertical}}}function sn(e,t){const i=Lt(e,G.toUnitRGB(v.pointManipulators.color),v.pointManipulators.opacity,L);return i.available=!1,i.grabCursor="crosshair",i.radius=v.pointManipulators.radius,i.metadata=t.metadata,i.collisionPriority=1,i}function an(e,t){const i=[ce(-.5,0,0),ce(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=Se(t.unfocusedMaterial,i.map(o=>oe(b(),o,n))),a=s.instantiate({material:t.focusedMaterial});return new it({view:e,renderObjects:[new Z(s,ee.Unfocused|ee.Selected|L),new Z(a,ee.Focused|L)],collisionType:{type:"line",paths:[i]},radius:Ie(t.lineSizePt)/2,metadata:t.metadata,available:!1,...nt})}function vt(e,{lineSizePt:t,material:i}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:a,discScale:o,focusMultiplier:l}=v.orientationManipulator;return{calloutLength:.25*Bt*v.markers.lineSizeFraction*H(t)+n,calloutOpacity:s,calloutWidth:a,customStateMask:L,discScale:o,focusMultiplier:l,material:i,metadata:e}}function Xe(e,t){return Vt(e,vt(t.metadata,t))}function Je(e,t){Et(e,vt(e.metadata,t))}function on(e,t){const i=[ce(-.5,0,0),ce(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=Se(t.thinOffsetManipulatorMaterial,i),a=Se(t.unfocusedMaterial,i.map(l=>oe(b(),l,n))),o=a.instantiate({material:t.focusedMaterial});return new it({view:e,renderObjects:[new Z(a,ee.Unfocused|L),new Z(o,ee.Focused|L),new Z(s,L)],collisionType:{type:"line",paths:[i]},radius:Ie(t.lineSizePt)/2,available:!1,metadata:t.metadata,...nt})}function rn(e,{isStart:t,createSnappingPipelineStep:i,dimension:n,onUpdate:s,view:a}){const o=t?"startPoint":"endPoint";return[re(e,(r,u,m,h)=>{const f=He(r),{snappingStep:w,cancelSnapping:P}=i(h);m=m.next(f).next(ze(n,[o,"measureType","orientation"])).next(P),u.next(f).next(It(a)).next(...w).next(O=>{const M=J(O.mapEnd,new W);s(o==="startPoint"?{startPoint:M}:{endPoint:M})})})]}function ln(e,{computation:t,view:i}){return[re(e,(n,s,a)=>{if(!se(t)||!n.selected)return;const{geometry:o,dimension:l}=t,r=He(n);s.next(r).next(Mt(i,l,o.dimensionSegment,o.primaryOffsetAxis)),a.next(r).next(ze(l,["offset"]))})]}function dn(e,{computation:t,view:i}){return[re(e,(n,s,a)=>{St({cancel:a,computation:t,settingHeading:!0,steps:s,view:i})})]}function cn(e,{computation:t,view:i}){return[re(e,(n,s,a)=>{St({cancel:a,computation:t,settingHeading:!1,steps:s,view:i})}),e.events.on("immediate-click",n=>{un(n,t,i)})]}function un(e,t,i){const{dimension:n,geometry:s}=t;if(n.orientation===90||n.orientation===270)return n.orientation=0,void e.stopPropagation();if(g(s))return;const{renderCoordsHelper:a}=i,o=me({...pe(t),orientation:90},a),l=me({...pe(t),orientation:270},a);if(g(o)||g(l))return;const r=Te(o,a),u=Te(l,a),m=wt(s,i),h=Me.shortestSignedDiff(m,r),f=Me.shortestSignedDiff(m,u);n.orientation=Math.abs(h)<Math.abs(f)?90:270,e.stopPropagation()}function St(e){const{cancel:t,computation:i,settingHeading:n,steps:s,view:a}=e;if(!se(i))return;const{renderCoordsHelper:o}=a,{dimension:l,geometry:r}=i,u=b(),m=Ct(b(),r,r.directSegment,o),h=bt(_.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),f=we(m,h,Pe()),w=xe(l.orientation,n?()=>Te(r,a.renderCoordsHelper):0);s.next(st(a,f)).next(P=>{P.action==="start"&&z(u,P.renderStart);const O=jt(f),M=Gt(u,P.renderEnd,m,O);let E=w-Nt(M);n||(E=pn(E)),l.orientation=E}),t.next(ze(l,["orientation"]))}function pn(e){const t=Me.normalize(e)%90;return t<v.orientationSnapThresholdDegrees?e-t:90-t<v.orientationSnapThresholdDegrees?e+(90-t):e}function mn(e,{computation:t,manipulatorMeasureType:i,view:n}){let s=y.Direct,a=0,o=0;return[e.events.on("grab-changed",l=>{if(l.action!=="start"||!se(t))return;const{dimension:r,geometry:u}=t;s=r.measureType,a=r.offset,o=r.orientation;const m=z(_.get(),e.renderLocation);r.measureType=i,r.offset=Ui(m,i,u,n.renderCoordsHelper),r.orientation=0}),re(e,(l,r,u)=>{if(!se(t))return;const{geometry:m,dimension:h}=t,{renderCoordsHelper:f}=n,w=mt($t,i,t,f),P=ge(_.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:f}),O=He(l);r.next(O).next(Mt(n,h,w,P)),u.next(O).next(M=>(h.measureType=s,h.offset=a,h.orientation=o,M))})]}function Mt(e,t,i,n){const s=at(_.get(),i.endRenderSpace,i.startRenderSpace);j(s,s,n);const a=we(i.startRenderSpace,s,Pe()),o=we(i.startRenderSpace,n,Pe()),l=t.offset;let r,u=0;const m=new Ft;return m.next(st(e,a)).next(h=>{h.action==="start"&&(u=je(o,h.renderStart));const f=(je(o,h.renderEnd)-u)*e.renderCoordsHelper.unitInMeters;t.offset=l+f,r=h}),h=>(m.execute(h),r)}function wt(e,t){const{directSegment:i}=e,{renderCoordsHelper:n}=t,s=fe(_.get(),e,n),a=Ve(_.get(),e),o=j(_.get(),a,s),{viewForward:l}=t.state.camera;V(o,l)>0&&oe(o,o,-1);const r=i.eval(.5,_.get());return n.headingAtPosition(r,o)}function hn(e,t,i){const{dimensionSegment:n,primaryOffsetAxis:s}=t,a=Ee(te,t),o=ot(a,Q)?Ut(he):Re(a,s,Q,he),l=Math.max(rt(a),v.offsetManipulator.minLengthMeters/i.unitInMeters);lt(o,o,dt(te,l,l,l)),e.modelTransform=o,e.renderLocation=n.eval(.5,te)}function gn(e,t,i){Pt(e,t,i,{forHeading:!0})}function fn(e,t,i){Pt(e,t,i,{forHeading:!1})}function Pt(e,t,i,{forHeading:n}){const{dimension:s,geometry:a}=t,{primaryOffsetAxis:o}=a,l=oe(_n,o,s.offset>=0?1:-1),r=bt(yn,{forHeading:n,geometry:a,renderCoordsHelper:i});j(r,r,l);const u=Re(l,r,Q,he);e.modelTransform=u,e.renderLocation=Ct(te,a,a.dimensionSegment,i)}const _n=b(),yn=b();function vn(e,t,i,n){const{geometry:s}=t,a=mt($t,i,t,n),o=ge(te,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),l=k(_e,a.endRenderSpace,a.startRenderSpace),r=Re(l,o,Q,he),u=rt(l);lt(r,r,dt(_e,u,u,u)),e.modelTransform=r,e.renderLocation=a.eval(.5,_e)}function Ct(e,t,i,n){const{startRenderSpace:s,endRenderSpace:a}=i,o=Sn(t,n)?s:a;return z(e,o)}function bt(e,{forHeading:t,geometry:i,renderCoordsHelper:n}){return t?fe(e,i,n):Ee(e,i,{invert:!0})}function Sn(e,t){const i=Ve(Mn,e),n=fe(wn,e,t);return V(i,n)>0}const Mn=b(),wn=b();function Pn(e){return H(e)+v.offsetManipulator.linePaddingPx}function Ie(e){return H(e)+v.offsetManipulator.focusedLinePaddingPx}const L=kt.Custom1,te=b(),_e=b(),he=De(),$t=new N;var A;function Cn(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function bn(e,t){if(ft(e))return A.Direct;if(!e.enabled)return null;const{geometry:i}=e;if(g(i)||ot(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=v,{camera:s}=t.state,a=fe(_.get(),i,t.renderCoordsHelper),o=Ve(_.get(),i),l=oe(_.get(),a,V(o,a)),r=at(_.get(),o,l),u=ve(r),m=ve(l),{startRenderSpace:h,endRenderSpace:f}=i.directSegment,w=Math.max(s.computeRenderPixelSizeAt(h)*n,s.computeRenderPixelSizeAt(f)*n)**2;return u<w?A.Vertical:m<w?A.Horizontal:null}function $n(e,t,{constraint:i,view:n}){const{unconstrainedGeometry:s}=e;if(g(s))return;const{renderCoordsHelper:a,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=s.directSegment,u=a.fromRenderCoords(l,new W,o),m=a.fromRenderCoords(r,new W,o);let h;h=t==="start"?{startPoint:u}:{endPoint:m},Ot(e,h,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function Ot(e,t,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:u,preConstraintProperties:m}=e;if(g(s)||g(a))return;const h=()=>{"startPoint"in t?r.startPoint=t.startPoint:"endPoint"in t&&(r.endPoint=t.endPoint)};if(g(n))h(),p(u)&&p(m)&&(r.measureType=m.measureType,r.orientation=m.orientation);else switch(r.measureType=y.Direct,n){case A.Horizontal:if(n!==u&&(r.orientation=0),"startPoint"in t){const f=t.startPoint;p(f)&&(f.z=a.z),r.startPoint=f}else if("endPoint"in t){const f=t.endPoint;p(f)&&(f.z=s.z),r.endPoint=f}break;case A.Vertical:if(n!==u&&(r.orientation=wt(o,l)),"startPoint"in t){const f=t.startPoint;p(f)&&(f.x=a.x,f.y=a.y),r.startPoint=f}else if("endPoint"in t){const f=t.endPoint;p(f)&&(f.x=s.x,f.y=s.y),r.endPoint=f}break;case A.Direct:n!==u&&p(m)&&(r.orientation=m.orientation),h()}e.previousConstraint=n,e.unconstrainedGeometry=o}(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"})(A||(A={}));let C=class extends qt{constructor(e){super(e),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new Ae,this._getSnappingContext=Wt(i=>new Qt({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new Yt(new Kt("point",Xt(!0,!1,this.view.spatialReference))),visualizer:new Jt})),this._snappingManagerResult=Zt(e.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=ye(),this._focusedOffsetManipulatorMaterial=ye(),this._thinOffsetManipulatorMaterial=ye(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:ue(2)}),this._constraintSnappingIndicator=new U({view:e.view,attached:!0,width:1,color:G.toUnitRGBA(v.constraint.color),renderOccluded:D.OccludeAndTransparent,stipplePattern:ue(5)});const t=G.toUnitRGBA(v.disabledPointIndicator.color);t[3]*=v.disabledPointIndicator.opacity,this._stagedStartIndicator=new zi({view:e.view,attached:!1,color:t,size:2*v.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:D.OccludeAndTransparent})}initialize(){this._snappingOperation=new ei({view:this.view}),this._orientationManipulatorTexture=Ti(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new ti({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:D.Opaque});const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles([e.on("after-add",t=>this._addComputation(t.item)),e.on("after-remove",t=>this._removeComputation(t.item))]),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:t,stagedComputation:i})=>{if(g(i)||g(t))return;const n=J(t,new W);this._applyPointUpdate(i,{endPoint:n})},Ce),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(t,i)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=t;if(n===(i==null?void 0:i.stagedDimension)&&a===(i==null?void 0:i.firstGrabbedManipulator)){for(const o of[s,i==null?void 0:i.selectedComputation])if(p(o)){const l=this._computationManipulators.get(o);this._updateManipulators(o,l,t)}}else for(const[o,l]of this._computationManipulators)this._updateManipulators(o,l,t)},R),S(()=>this.analysis.style.lineSize,t=>{this._updateManipulatorStyle(t)},be),S(()=>this.view.state.camera,()=>{p(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>ii(this._stagedComputation,t=>{const i=t.elevationAlignedStartPoint,n=b();return p(i)&&this.view.renderCoordsHelper.toRenderCoords(i,n)?n:null}),t=>{p(t)?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),ni(this,()=>{const t=this._activeComputation,i=this._stagedComputation;if(g(t)||p(i)){const n=xe(this.view.inputManager.latestPointerType,"mouse"),s=this._getSnappingContext(n);this.updatingHandles.addPromise(Ne(this._snappingOperation.resnap(this._snappingManager,s)))}if(p(t)){const{start:n,end:s}=this._computationManipulators.get(t);if(n.grabbing||s.grabbing){const a=n.grabbing?"start":"end",o=this._computeConstraint(t);$n(t,a,{constraint:o,view:this.view})}}})}destroy(){this._snappingOperation=ie(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(p(this._stagedComputation))return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&p(e)?e:null}get _stagedComputation(){const e=this._stagedDimension,t=this.analysisViewData.computations.at(-1);return g(e)||g(t)||t.dimension!==e?null:t}get _constraintHandles(){return[ke(()=>this.analysisViewData.selectedComputation,e=>{e.previousConstraint=this._computeConstraint(e)},{...R,equals:$e}),S(()=>{const e=this._activeComputation;if(g(e))return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}},(e,t)=>{if(p(e)&&g(t)){const{measureType:i,orientation:n,computation:s}=e;switch(s.previousConstraint){case A.Horizontal:s.preConstraintProperties={measureType:y.Horizontal,orientation:0};break;case A.Vertical:s.preConstraintProperties={measureType:y.Vertical,orientation:0};break;case A.Direct:s.preConstraintProperties={measureType:y.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}g(e)&&p(t)&&(t.computation.preConstraintProperties=null)},Ce)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:t,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(e),g(i))n.attached=!1;else if(i===t)n.attached=!0;else{const{start:s,end:a}=this._computationManipulators.get(i),o=()=>{n.attached=s.grabbing||a.grabbing};o(),this.addHandles([s.events.on("grab-changed",o),a.events.on("grab-changed",o)],e)}}),S(()=>{const t=this._activeComputation;return p(t)?{geometry:t.geometry,constraint:t.previousConstraint}:{}},({geometry:t,constraint:i})=>{const n=this._constraintSnappingIndicator;p(t)&&p(i)&&i!==A.Direct?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1})]}removeStaged(){return!!p(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(g(t)){const i=this._onUnstagedClick(e);return this.analysis.dimensions.add(i),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if(t==="touch")return;const i=this._getSnappingContext(t);this.updatingHandles.addPromise(Ne(this._snappingOperation.snap({point:e},this._snappingManager,i)))}onManipulatorSelectionChanged(){p(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if(t==="mouse"){const s=this._getSnappingContext(t);i=this._snappingManager.update({point:e,context:s})}const n=new Pi({startPoint:J(i,new W),endPoint:null,measureType:y.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(g(i))return;let n=e;if(t==="mouse"){const a=this._getSnappingContext(t);n=this._snappingManager.update({point:e,context:a})}const s=J(n,new W);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(e){if(this._computationManipulators.has(e))return;const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),n=this._setupOffsetManipulator(e),s=this._setupHeadingManipulator(e),a=this._setupRotationManipulator(e),o=this._setupMeasureTypeManipulator(e,y.Direct),l=this._setupMeasureTypeManipulator(e,y.Horizontal),r=this._setupMeasureTypeManipulator(e,y.Vertical),u=new nn({start:t,end:i,offset:n,heading:s,rotation:a,direct:o,horizontal:l,vertical:r});this._setupComputationToManipulatorsSync(e,u),this._computationManipulators.set(e,u),this.manipulators.addMany(u.values())}_removeComputation(e){const t=this._computationManipulators.get(e);if(!g(t)){this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const i of t.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([S(()=>e.geometry,()=>this._updateManipulators(e,t),{...R,equals:$e})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:n}=e,s=sn(i,{metadata:n}),a=rn(s,{isStart:t.isStart,createSnappingPipelineStep:o=>si({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(e,o),view:i});return this._computationHandles.add(a,e),s}_setupOffsetManipulator(e){const{view:t}=this,i=an(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),n=ln(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=Xe(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=dn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupRotationManipulator(e){const{view:t}=this,i=Xe(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=cn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,n=on(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),s=mn(n,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(s,e),n}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=i,{start:o,end:l,offset:r,heading:u,rotation:m}=t,h=s===e,f=se(e),{dimension:w}=e;for(const M of t.values()){const E=f&&g(n)&&(g(a)||M===a);M===r?(M.available=E,M.selected=h):M.available=E&&h}if(!f)return;p(this._computeConstraint(e))?t.forEachMeasureTypeManipulator(M=>M.available=!1):t.manipulatorForMeasureType(w.measureType).available=!1;for(const M of[u,m])w.measureType===y.Direct&&w.offset!==0||(M.available=!1);Le(e)?m.available=!1:u.available=!1;const{geometry:P}=e;o.renderLocation=P.directSegment.startRenderSpace,l.renderLocation=P.directSegment.endRenderSpace;const{renderCoordsHelper:O}=this.view;hn(r,P,O),u.available&&gn(u,e,O),m.available&&fn(m,e,O),t.forEachMeasureTypeManipulator((M,E)=>{M.available&&vn(M,e,E,O)})}_updateManipulatorStyle(e){const t=Pn(e),i=Ie(e),n={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:a,rotation:o}of this._computationManipulators.values())s.radius=i/2,Je(a,n),Je(o,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,n=pe(e);"startPoint"in t&&(n.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(n.elevationAlignedEndPoint=t.endPoint);const s=me(n,i.renderCoordsHelper);if(g(s))return;const a=this._computeConstraint({...n,geometry:s});Ot(e,t,{...n,constraint:a,unconstrainedGeometry:s,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(g(e.geometry))return;e.geometry.directSegment.eval(.5,Ze);const t=this.view.state.camera.computeRenderPixelSizeAt(Ze);e.dimension.offset=v.initialOffsetPx*t}_computeConstraint(e){return bn(Cn(e,this._snappingManager.options),this.view)}get testInfo(){const e=t=>this.analysisViewData.computations.find(i=>i.dimension===t);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=D.Occlude,this.manipulators.forEach(({manipulator:t})=>{for(const{geometry:i}of t.renderObjects)i.material.setParameters({renderOccluded:D.Occlude})})},getManipulatorsForDimension:t=>this._computationManipulators.get(e(t)),getComputationForDimension:t=>e(t),getConstraintForDimension:t=>{const i=e(t);return p(i)?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function ye(){const{color:e,opacity:t}=v.offsetManipulator;return new K({color:[...G.toUnitRGB(e),t],width:1,renderOccluded:D.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}d([c({constructOnly:!0})],C.prototype,"analysis",void 0),d([c({constructOnly:!0})],C.prototype,"analysisViewData",void 0),d([c({constructOnly:!0})],C.prototype,"manipulators",void 0),d([c({constructOnly:!0})],C.prototype,"parentTool",void 0),d([c({constructOnly:!0,nonNullable:!0})],C.prototype,"view",void 0),d([c({readOnly:!0})],C.prototype,"updating",null),d([c()],C.prototype,"firstGrabbedManipulator",null),d([c()],C.prototype,"hasGrabbedManipulators",null),d([c()],C.prototype,"snappingOptions",null),d([c()],C.prototype,"_stagedDimension",void 0),d([c()],C.prototype,"_activeComputation",null),d([c()],C.prototype,"_stagedComputation",null),C=d([F("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],C);const Ze=b();var q;(function(e){e.Ready="ready",e.Creating="creating",e.Created="created"})(q||(q={}));let T=class extends ai{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=v.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=oi(this.view.state.viewingMode),this._intersector.options.store=ri.MIN,this._lengthDimensionSubTool=new C({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([li(this._lengthDimensionSubTool),Oe(()=>this._clearPointerMoveTimeout()),S(()=>this.state,e=>{e===q.Created&&this.finishToolCreation()},R),ke(()=>this.firstGrabbedManipulator,e=>{this.selectedDimension=e.metadata},R),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),R)])}get state(){return this.analysis.dimensions.some(e=>e.type==="length")?p(this._activeSubTool)?q.Creating:q.Created:q.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(qe.cancel===e.key){if(p(this._activeSubTool)&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else qe.delete.includes(e.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){p(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(g(this._activeSubTool))return;const t=this._intersectScreen(e);g(t)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const t=this._intersectScreen(e);g(t)||this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_deleteKeyHandler(){p(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(e){const t=di(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=_.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){p(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=ci(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(e=>{e.manipulator.state|=L}),this._prevPointerMoveTimeout=ui.setTimeout(()=>{this.manipulators.forEach(e=>{e.manipulator.state&=~L})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:e=>{this._pointerMoveTimerMs=e,this._resetPointerMoveTimeout()}}}};d([c({constructOnly:!0})],T.prototype,"view",void 0),d([c({constructOnly:!0})],T.prototype,"analysis",void 0),d([c({readOnly:!0})],T.prototype,"state",null),d([c({readOnly:!0})],T.prototype,"updating",null),d([c({readOnly:!0})],T.prototype,"cursor",null),d([c({constructOnly:!0})],T.prototype,"analysisViewData",void 0),d([c()],T.prototype,"selectedDimension",null),d([c()],T.prototype,"automaticManipulatorSelection",void 0),d([c()],T.prototype,"_activeSubTool",void 0),d([c()],T.prototype,"_lengthDimensionSubTool",void 0),T=d([F("esri.views.3d.analysis.Dimension.DimensionTool")],T);class On extends xi{constructor(t,i){super(t),this._hasExternalMaterial=!1,this._renderOccluded=D.OccludeAndTransparent,this._width=1,this._color=pi(1,0,1,1),this._placement="end",this._textureId=null,this._material=i,this._hasExternalMaterial=p(i),this.applyProps(t)}setGeometryFromSegment(t,i){const n=t.endRenderSpace;this.transform=mi(Tn,n),this._normal=i;const{points:s}=t.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return p(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,p(this._material)&&this._material.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return p(this._material)?this._material.parameters.width:this._width}set width(t){this._width=t,p(this._material)&&this._material.setParameters({width:t})}get color(){return p(this._material)?this._material.parameters.color:this._color}set color(t){this._color=hi(t),p(this._material)&&this._material.setParameters({color:this._color})}get placement(){return p(this._material)?this._material.parameters.placement:this._placement}set placement(t){this._placement=t,p(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return p(this._material)?this._material.parameters.textureId:this._textureId}set textureId(t){this._textureId=t,p(this._material)&&this._material.setParameters({textureId:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new ct({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const i of gi(this.geometry,this.normal)){const n=fi(We(this._material),i);t.addGeometry(n)}}forEachExternalMaterial(t){this._hasExternalMaterial||t(We(this._material))}}const Tn=De();class xn{set visible(t){for(const i of this._visualElements.values())i.attached=t}constructor(t){this.destroyed=!1,this._handles=new Ae,this._messages=null,this._labelSegment=new N;const{analysis:i,computation:n,view:s,messages:a}=t;this.analysis=i,this.computation=n,this.view=s,this._messages=a;const o=t.visible,l={view:s,attached:o},{fontSize:r,textColor:u,textBackgroundColor:m}=i.style;this._visualElements=new Hn({marker:new On(l,t.markerMaterial),dimension:new U(l,t.dimensionLineMaterial),startOffset:new U(l,t.offsetLineMaterial),endOffset:new U(l,t.offsetLineMaterial),dimensionSmall:new U(l,t.smallDimensionLineMaterial),startOffsetSmall:new U(l,t.smallOffsetLineMaterial),endOffsetSmall:new U(l,t.smallOffsetLineMaterial),label:new bi({view:s,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:H(r),textColor:u.clone(),backgroundColor:m.clone()})}),this._handles.add([S(()=>n.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,i.style),p(n.geometry)&&this._updateLines(n.geometry)},{...be,equals:$e}),S(()=>n.length,h=>this._updateLabelContent(h),be)])}destroy(){this.destroyed=!0,this._handles=ie(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(t){const i=Ke(An,ne.Start,t.directSegment,t.dimensionSegment),n=Ke(zn,ne.End,t.directSegment,t.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),s.dimension.setGeometryFromSegment(t.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(t,i,n){const s=this._visualElements;if(g(i)){for(const O of s.values())O.visible=!1;return}const a=t.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Rn)),o=Ni(i,a),l=o<(H(n.lineSize)*v.smallScreenLengthLineSizeFactor)**2,r=!l;s.marker.visible=r,s.dimension.visible=r,s.startOffset.visible=r,s.endOffset.visible=r,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const u=H(n.fontSize)*v.labels.minScreenLengthFontSizeFactor,{label:m}=s;if(m.visible=o>=u**2,!m.visible)return;const{dimensionSegment:h,primaryOffsetAxis:f}=i,{offset:w}=this.computation.dimension,P=(Math.sign(w)>=0?1:-1)*Dn(n)*a;Ei(this._labelSegment,h,f,P),m.updateLabelPosition()}updateLabelStyle(t){const{label:i}=this._visualElements;i.fontSize=H(t.fontSize),i.textColor=t.textColor,i.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(t){const{label:i}=this._visualElements;g(t)||g(this._messages)?i.text="":i.text=Ci(this._messages,t,t.unit)}}function Dn(e){return 1.5*H(e.fontSize)+v.labels.marginPx+H(e.lineSize/2)}const An=new N,zn=new N,Rn=b();class Hn{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}class kn{constructor(t,i){this._textures=t,this._textureRepository=i,this._texturesByPrimitive=new Map}acquire(t){if(!this._texturesByPrimitive.has(t)){const i=_i(this._textures,t),n=new Ri(this._textureRepository,i.texture.id);return this._texturesByPrimitive.set(t,{result:i,reference:n}),i.texture}return this._texturesByPrimitive.get(t).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:t,reference:i})=>{i.dispose(),t.release()}),this._texturesByPrimitive.clear()}}let I=class extends ae{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new ct({width:1,anchor:yi.Tip,color:Y,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:D.OccludeAndTransparent}),this._dimensionLineMaterial=new K({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new K({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,stipplePattern:ue(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new K({width:1,color:Y,renderOccluded:D.OccludeAndTransparent}),this._smallOffsetLineMaterial=new K({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,stipplePattern:ue(5),stippleScaleWithLineWidth:!0})}initialize(){var i;const e=(i=this.view.sharedSymbolResources)==null?void 0:i.textures;if(p(e)){const{textureRepository:n}=this.view._stage.renderView,s=new kn(e,n),a=s.acquire("triangle");this.addHandles(Oe(()=>s.destroy())),this._markerMaterial.setParameters({textureId:a.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(Oe(()=>{this.view._stage.remove(n),n.dispose()}));const{computations:t}=this.analysisViewData;for(const n of t)this._addComputation(n);this.addHandles([t.on("change",({added:n,removed:s})=>{for(const a of s)this._removeComputation(a);for(const a of n)this._addComputation(a)}),S(()=>G.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},R),S(()=>this.analysis.style.lineSize,n=>{const s=H(n);this._markerMaterial.setParameters({width:s*v.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const a=Math.max(s*v.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:a})},R),S(()=>({camera:this.view.state.camera,style:Ln(this.analysis)}),({camera:n,style:s})=>{for(const[a,o]of this._dimensionVisualizations)o.updateCameraDependentElements(n,a.geometry,s),o.updateLabelStyle(s)}),S(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([vi(()=>this._updateMessageBundle()),ke(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},Ce)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(e=>{e.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const e of this._lineMaterials())e.setParameters({renderOccluded:D.Occlude})}}}_addComputation(e){this._dimensionVisualizations.has(e)||this._dimensionVisualizations.set(e,new xn({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(e){const t=this._dimensionVisualizations.get(e);g(t)||(t.destroy(),this._dimensionVisualizations.delete(e))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Si("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Ln(e){const{fontSize:t,lineSize:i,textColor:n,textBackgroundColor:s}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}d([c({constructOnly:!0})],I.prototype,"analysisViewData",void 0),d([c({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),d([c()],I.prototype,"analysis",null),d([c()],I.prototype,"visible",null),d([c()],I.prototype,"loadingMessages",void 0),I=d([F("esri.views.3d.analysis.Dimension.DimensionVisualization")],I);let X=class extends ae{constructor(e){super(e),this.dimension=null,this.length=null}};d([c({constructOnly:!0,nonNullable:!0})],X.prototype,"dimension",void 0),d([c()],X.prototype,"length",void 0),X=d([F("esri.views.3d.analysis.LengthDimensionResult")],X);const Vn=X;let x=class extends ae{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new Vn({dimension:t}),...i}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e),R),S(()=>this.dimension.endPoint,e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e),R)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([c({constructOnly:!0,nonNullable:!0})],x.prototype,"result",void 0),d([c({constructOnly:!0,nonNullable:!0})],x.prototype,"projectAndAlignPoint",void 0),d([c()],x.prototype,"dimension",null),d([c()],x.prototype,"length",null),d([c()],x.prototype,"geometry",void 0),d([c()],x.prototype,"unconstrainedGeometry",void 0),d([c()],x.prototype,"elevationAlignedStartPoint",void 0),d([c()],x.prototype,"elevationAlignedEndPoint",void 0),d([c()],x.prototype,"preConstraintProperties",void 0),d([c()],x.prototype,"previousConstraint",void 0),x=d([F("esri.views.3d.analysis.LengthDimensionComputation")],x);const En=e=>{let t=class extends e{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new ut}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([c({constructOnly:!0})],t.prototype,"view",void 0),d([c({constructOnly:!0,nonNullable:!0})],t.prototype,"analysis",void 0),d([c()],t.prototype,"tool",void 0),d([c({readOnly:!0})],t.prototype,"results",null),d([c()],t.prototype,"selectedDimension",void 0),d([c()],t.prototype,"interactive",void 0),d([c()],t.prototype,"visible",void 0),t=d([F("esri.views.analysis.DimensionAnalysisView")],t),t};let $=class extends En(Mi(ae)){constructor(e){super(e),this.type="dimension-view-3d",this.tool=null,this.computations=new ut,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(g(e))return null;const{spatialReference:t,elevationProvider:i}=this.view,n=Di(e,t,i);return g(n)&&Ai(this.analysis,e.spatialReference,tt.getLogger(this.declaredClass)),n},this.addHandles([Hi(this,T),Qe(()=>this.analysis.dimensions,"after-add",e=>this._onDimensionAdd(e.item),{onListenerAdd:e=>{for(const t of e)this._onDimensionAdd(t)},onListenerRemove:()=>{this._onDimensionsClear()}}),Qe(()=>this.analysis.dimensions,"after-remove",e=>this._onDimensionRemove(e.item))]),this._analysisVisualization=new I({analysisViewData:this,view:this.view}),this._analysisController=new B({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Ye(this._placementTask),this._analysisVisualization=ie(this._analysisVisualization),ki(this)}get updating(){var e,t;return(t=(e=this._analysisVisualization)==null?void 0:e.loadingMessages)!=null?t:!1}get results(){return this.analysis.dimensions.map(e=>this._dimensionsToComputations.get(e).result)}get selectedComputation(){const{selectedDimension:e}=this;return g(e)?null:this._dimensionsToComputations.get(e)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(e){return this.selectedDimension=null,this._placementTask=Ye(this._placementTask),this._placementTask=Li(this,e),this._placementTask.promise}_onDimensionAdd(e){const{computations:t,_dimensionsToComputations:i}=this;if(i.has(e))return;const n=new x({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});t.add(n),i.set(e,n)}_onDimensionRemove(e){const{computations:t,_dimensionsToComputations:i}=this,n=t.findIndex(a=>a.dimension===e),s=t.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),t.removeAt(n),i.delete(e),ie(s)}_onDimensionsClear(){this.computations.drain(e=>e.destroy()),this._dimensionsToComputations.clear()}};d([c({readOnly:!0})],$.prototype,"type",void 0),d([c()],$.prototype,"tool",void 0),d([c()],$.prototype,"updating",null),d([c({readOnly:!0})],$.prototype,"results",null),d([c({readOnly:!0})],$.prototype,"computations",void 0),d([c()],$.prototype,"selectedDimension",void 0),d([c()],$.prototype,"selectedComputation",null),d([c()],$.prototype,"_analysisVisualization",void 0),d([c()],$.prototype,"_analysisController",void 0),d([c()],$.prototype,"_dimensionsToComputations",void 0),d([c()],$.prototype,"_placementTask",void 0),$=d([F("esri.views.3d.analysis.DimensionAnalysisView3D")],$);const Zn=$;export{Zn as default};
