import{gP as ee,bj as te,gQ as G,ak as W,b7 as P,gR as pe,gS as de,gT as ye,aF as me,by as ge,gU as be,gV as Se,gq as we,a7 as Me,gW as Te,r as M,i as q,aD as b,gX as Ee,E as ve,dj as ae,a$ as Ie,eN as K,gY as I,gZ as j,ba as x,aN as E,g_ as ne,ah as O,g$ as xe,h0 as re,h1 as oe,h2 as Re,h3 as se,h4 as qe,h5 as ie,aQ as Q,aP as Ne,h6 as Ce,gE as Z,gD as ze,h7 as De,h8 as Ue,aj as B,aO as H,h9 as v,eq as F,dd as We}from"./index.a33ecea7.js";import{I as Oe}from"./I3SBinaryReader.a07cc377.js";function $e(e,t,a,n){const r=ke(e,t,a),o=G();return ee(a,r,o,n),o}const ce=1,J=5-ce;function ke(e,t,a){const n=W(),r=e[3],o=2**(Math.ceil(Math.log(r)*Math.LOG2E/J)*J+ce);if(a.isGeographic){const c=o/te(a).radius*180/Math.PI,u=Math.round(e[1]/c),p=Math.max(-90,Math.min(90,u*c)),h=c/Math.cos((Math.abs(p)-c/2)/180*Math.PI),y=Math.round(e[0]/h)*h;n[0]=y,n[1]=p}else{const c=Math.round(e[0]/o),u=Math.round(e[1]/o);n[0]=c*o,n[1]=u*o}const s=e[2]+t,i=Math.round(s/o);return n[2]=i*o,n}function le(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function ft(e){var t;if(Me("disable-feature:i3s-draco")||!e)return!1;for(const a of e)for(const n of a.geometryBuffers)if(((t=n.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function ht(e,t,a,n){a.traverse(t,r=>{const o=r.mbs;return(o!=null&&Fe(e,o))!==T.OUTSIDE&&(n(r),!0)})}function pt(e,t,a){let n=0,r=0;for(let o=0;o<t.length&&n<e.length;o++)e[n]===t[o]&&(a(o)&&(e[r]=e[n],r++),n++);e.length=r}function dt(e,t,a){let n=0,r=0;for(;n<a.length;)Te(e,a[n])>=0===t&&(a[r]=a[n],r++),n++;a.length=r}const R=P();function yt(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return R[0]=(e[0]-t.position[0])/t.rotationScale[0],R[1]=(e[1]-t.position[1])/t.rotationScale[4],R[2]=(e[2]-t.position[0])/t.rotationScale[0],R[3]=(e[3]-t.position[1])/t.rotationScale[4],R}var T;function Fe(e,t){const a=t[0],n=t[1],r=t[3],o=e[0]-a,s=a-e[2],i=e[1]-n,c=n-e[3],u=Math.max(o,s,0),p=Math.max(i,c,0),h=u*u+p*p;return h>r*r?T.OUTSIDE:h>0?T.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,s,i,c)>r?T.INSIDE:T.INTERSECTS_CENTER_INSIDE}function _e(e,t,a){const n=[],r=a&&a.missingFields,o=a&&a.originalFields;for(const s of e){const i=s.toLowerCase();let c=!1;for(const u of t)if(i===u.name.toLowerCase()){n.push(u.name),c=!0,o&&o.push(s);break}!c&&r&&r.push(s)}return n}async function mt(e,t,a,n,r){if(t.length===0)return[];const o=e.attributeStorageInfo;if(M(e.associatedLayer))try{return await Le(e.associatedLayer,t,a,n)}catch(s){if(e.associatedLayer.loaded)throw s}if(o){const s=Ae(t,a,r);if(q(s))throw new b("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const i=e.parsedUrl.path;return(await Promise.all(s.map(c=>Ge(i,o,c.node,c.indices,n).then(u=>{for(let p=0;p<c.graphics.length;p++){const h=c.graphics[p],y=u[p];if(h.attributes)for(const f in h.attributes)f in y||(y[f]=h.attributes[f]);h.attributes=y}return c.graphics})))).flat()}throw new b("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function Ae(e,t,a){const n=new Map,r=[],o=a();for(const s of e){const i=s.attributes[t];for(let c=0;c<o.length;c++){const u=o[c],p=u.featureIds.indexOf(i);if(p>=0){let h=n.get(u.node);h||(h={node:u.node,indices:[],graphics:[]},r.push(h),n.set(u.node,h)),h.indices.push(p),h.graphics.push(s);for(let y=c;y>0;y--)o[y]=o[y-1];o[0]=u;break}}}return r}async function Le(e,t,a,n){t.sort((c,u)=>c.attributes[a]-u.attributes[a]);const r=t.map(c=>c.attributes[a]),o=[],s=_e(n,e.fields,{originalFields:o}),i=await ue(e,r,s);for(let c=0;c<t.length;c++){const u=t[c],p=i[c],h={};if(u.attributes)for(const y in u.attributes)h[y]=u.attributes[y];for(let y=0;y<o.length;y++)h[o[y]]=p[s[y]];u.attributes=h}return t}function ue(e,t,a){const n=e.capabilities.query.maxRecordCount;if(n!=null&&t.length>n){const o=Ee(t,n);return Promise.all(o.map(s=>ue(e,s,a))).then(s=>s.flat())}const r=new ve({objectIds:t,outFields:a,orderByFields:[e.objectIdField]});return e.queryFeatures(r).then(o=>{if(o&&o.features&&o.features.length===t.length)return o.features.map(s=>s.attributes);throw new b("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function Ge(e,t,a,n,r){return Pe(e,t,a.resources.attributes,n,r)}function Pe(e,t,a,n,r){const o=[];for(const s of t)if(s&&r.includes(s.name)){const i=`${e}/nodes/${a}/attributes/${s.key}/0`;o.push({url:i,storageInfo:s})}return me(o.map(s=>ge(s.url,{responseType:"array-buffer"}).then(i=>Oe(s.storageInfo,i.data)))).then(s=>{const i=[];for(const c of n){const u={};for(let p=0;p<s.length;p++){const h=s[p].value;h!=null&&(u[o[p].storageInfo.name]=Qe(h,c))}i.push(u)}return i})}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(T||(T={}));const Ke=-32768,je=-(2**31);function Qe(e,t){if(!e)return null;const a=e[t];return be(e)?a===Ke?null:a:Se(e)?a===je?null:a:a!=a?null:a}function Ze(e){const t=e.store,a=t.indexCRS||t.geographicCRS,n=a===void 0?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=a?new ae(le(a)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function Be(e){const t=e.store,a=t.vertexCRS||t.projectedCRS,n=a===void 0?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=a?new ae(le(a)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function gt(e,t){return q(t)?"@null":t===I(t)?"@ECEF":e.equals(t)?"":t.wkid!=null?"@"+t.wkid:null}function A(e,t,a){if(!Ie(e,t))throw new b("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if(a==="local"&&!He(e,t))throw new b("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function bt(e,t,a){var n,r;if(((n=e.serviceUpdateTimeStamp)==null?void 0:n.lastUpdate)!==((r=t.serviceUpdateTimeStamp)==null?void 0:r.lastUpdate)||!a.isEmpty||K(e.associatedLayer,o=>o.url)!==K(t.associatedLayer,o=>o.url))throw new b("layerview:recycle-failed")}function He(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function Je(e,t,a){const n=Ze(e),r=Be(e);A(n,t,a),A(r,t,a)}function Ve(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function St(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Ve(e.store.defaultGeometrySchema))throw new b("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function wt(e,t){Je(e,t.spatialReference,t.viewingMode)}function Xe(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function Mt(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Xe(e.store.defaultGeometrySchema))throw new b("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Tt(e,t){A(e.spatialReference,t.spatialReference,t.viewingMode)}function Ye(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function et(e){return e.type==="mesh-3d"}function Et(e){if(e==null||!Ye(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.getSymbols();if(t.length===0)return!0;for(const a of t){if(!et(a)||a.symbolLayers.length===0)return!0;for(const n of a.symbolLayers.items)if(n.type!=="fill"||q(n.material)||q(n.material.color)||n.material.colorMixMode!=="replace")return!0}return!1}const vt=pe({color:[0,0,0,0],opacity:0});class tt{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function It(e){const t=new tt;let a=!1,n=!1;for(const r of e.symbolLayers.items)if(r.type==="fill"&&r.enabled){const o=r.material,s=r.edges;if(M(o)&&!a){const i=o.color,c=Ce(o.colorMixMode);M(i)?t.material={color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:c}:t.material={color:[1,1,1],alpha:1,colorMixMode:Z.Multiply},t.castShadows=r.castShadows,a=!0}M(s)&&!n&&(t.edgeMaterial=ze(s,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:Z.Multiply}),t}function xt(e,t){return(0|e)+(0|t)|0}function at(e,t,a,n,r=0){n===I(n)?t.isGeographic?ct(e,a,t,r):it(e,a,t,r):t.isWGS84&&(n.isWebMercator||j(n))?nt(t,e,n,a,r):t.isWebMercator&&j(n)?st(t,e,n,a,r):e===a?(a.center[2]+=r,x(a.center,t,0,a.center,n,0,1)):(E(a.center,e.center[0],e.center[1],e.center[2]+r),x(a.center,t,0,a.center,n,0,1),ne(a.quaternion,e.quaternion),O(a.halfSize,e.halfSize))}function nt(e,t,a,n,r){O(w,t.center),w[2]+=r;const o=I(a);x(w,e,0,w,o,0,1),fe(o,t,w,a,n)}const U=new Array(24),rt=new we(U,3,!0),V=W(),w=W(),ot=De();function st(e,t,a,n,r){O(w,t.center),w[2]+=r,fe(e,t,w,a,n)}function fe(e,t,a,n,r){const o=xe(ot,t.quaternion);for(let s=0;s<8;++s){for(let i=0;i<3;++i)V[i]=t.halfSize[i]*((s&1<<i)!=0?-1:1);for(let i=0;i<3;++i){let c=a[i];for(let u=0;u<3;++u)c+=V[u]*o[3*u+i];U[3*s+i]=c}}x(U,e,0,U,n,0,8),re(rt,r)}function it(e,t,a,n){oe(e,L),E(t.center,e.center[0],e.center[1],e.center[2]+n),ee(a,t.center,g,I(a)),E(t.center,g[12],g[13],g[14]);const r=2*Math.sqrt(1+g[0]+g[5]+g[10]);S[0]=(g[6]-g[9])/r,S[1]=(g[8]-g[2])/r,S[2]=(g[1]-g[4])/r,S[3]=.25*r,Re(t.quaternion,S,e.quaternion),se(S,t.quaternion);let o=0,s=0,i=0;for(const c of L)c[2]+=n,x(c,a,0,c,I(a),0,1),qe(l,c,t.center),ie(l,l,S),o=Math.max(o,Math.abs(l[0])),s=Math.max(s,Math.abs(l[1])),i=Math.max(i,Math.abs(l[2]));E(t.halfSize,o,s,i)}function ct(e,t,a,n){const r=te(a),o=1+Math.max(0,n)/(r.radius+e.center[2]);E(t.center,e.center[0],e.center[1],e.center[2]+n),x(t.center,a,0,t.center,I(a),0,1),ne(t.quaternion,e.quaternion),se(S,e.quaternion),E(l,0,0,1),ie(l,l,S),E(l,e.halfSize[0]*Math.abs(l[0]),e.halfSize[1]*Math.abs(l[1]),e.halfSize[2]*Math.abs(l[2])),Q(l,l,r.inverseFlattening),Ne(t.halfSize,e.halfSize,l),Q(t.halfSize,t.halfSize,o)}function Rt(e,t,a,n,r,o){if(!o||o.length===0||q(t)||!e.mbs)return null;const s=$e(e.mbs,r,a,t);Ue(D,s);let i=null;const c=()=>{if(!i)if(i=L,B(z),M(e.serviceObb)){at(e.serviceObb,a,X,t,r),oe(X,i);for(const f of i)v(f,f,D),F(z,f)}else{const f=e.mbs;if(!f)return;const d=f[3];H(f,a,l,t),v(l,l,D),l[2]+=r;for(let m=0;m<8;++m){const N=1&m?d:-d,$=2&m?d:-d,k=4&m?d:-d,C=i[m];O(C,[l[0]+N,l[1]+$,l[2]+k]),F(z,C)}}};let u=1/0,p=-1/0;const h=f=>{if(f.type!=="replace")return;const d=f.geometry;if(!(d!=null&&d.hasZ))return;B(_);const m=d.spatialReference||n,N=d.rings.reduce(($,k)=>k.reduce((C,he)=>(H(he,m,l,t),v(l,l,D),F(_,l),Math.min(l[2],C)),$),1/0);c(),We(z,_)&&(u=Math.min(u,N),p=Math.max(p,N))};if(o.forEach(f=>h(f)),u===1/0)return null;const y=(f,d,m)=>{v(l,m,s),f[d+0]=l[0],f[d+1]=l[1],f[d+2]=l[2],d+=24,m[2]=u,v(l,m,s),f[d+0]=l[0],f[d+1]=l[1],f[d+2]=l[2],d+=24,m[2]=p,v(l,m,s),f[d+0]=l[0],f[d+1]=l[1],f[d+2]=l[2]};for(let f=0;f<8;++f)y(Y.data,3*f,i[f]);return re(Y)}function qt(e){return M(e)&&e.halfSize[0]>=0}function Nt(e){return e[3]>=0}function Ct(e){M(e)&&(e.halfSize[0]=-1)}function zt(e){M(e)&&(e[3]=-1)}const g=G(),S=de(),L=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],_=P(),z=P(),X=ye(),l=W(),Y={data:new Array(72),size:3,exclusive:!0,stride:3},D=G();export{qt as $,It as C,St as E,zt as H,Mt as I,ft as J,xt as N,Rt as P,Nt as Q,Tt as R,vt as U,ht as V,pt as X,dt as Y,Ct as Z,mt as a,A as b,ke as c,Fe as d,Be as e,bt as g,Ze as h,Qe as m,$e as n,_e as o,Et as q,T as r,yt as t,Pe as u,wt as v,Je as w,gt as y,at as z};
