import{a as x,n as ae}from"./WGLContainer.5bbfc124.js";import{bO as Tt,c7 as ut,c8 as zt,a7 as It,cs as ne,by as Jt,ct as re,cu as oe,cv as he,cw as ce,aD as C,cx as R,cy as $,i as J,ae as Kt,cz as ue,a4 as le,u as Ct,cA as de,c2 as Mt,cB as K,cC as Dt,r as E,cc as O,cD as me,aX as Et,bR as k,c6 as ge,c9 as _e,Y as pe,cE as fe,cn as I,cF as P,cG as we,cH as ye,cI as ve,aC as be,e as _,y as f,b as G,d as q,cJ as Ft,cK as xe,cL as Me,ak as $e,cM as mt,aR as gt,ay as te,cN as lt,aQ as Se,cO as Te,cP as ze,cQ as Ie,cR as Re,cS as Pe,cT as Ce,cU as De,cV as tt,cW as Ee,cX as $t,cY as Fe,cZ as Ae,a as et,c_ as At}from"./index.a33ecea7.js";import{o as Be,e as ke,i as Le}from"./cimAnalyzer.32b2260b.js";import{o as Ne}from"./fontUtils.401be2b9.js";import{c as Ue}from"./Rasterizer.dd2845f9.js";import{e as v,z as Bt,y as kt,j as Ve,U as Oe,V as Ge}from"./definitions.618cbc79.js";import{_ as it,T as qe}from"./enums.a12f2baf.js";import{t as b}from"./Rect.85ff00e1.js";import{e as Lt}from"./GeometryUtils.b69b6363.js";import{u as Ze,p as He,l as We,n as Nt,r as Ye,I as Qe,f as st,s as Ut,d as Vt,i as Xe,o as je,m as Je}from"./color.d55e9401.js";import{c as Ke}from"./imageutils.5e5bb181.js";import{e as ti}from"./Matcher.91da54bc.js";import{s as ei}from"./CircularArray.155c6653.js";import{t as ii}from"./ComputedAttributeStorage.fd12c291.js";import{e as si}from"./ProgramTemplate.6d98fd14.js";const os={shaders:{vertexShader:x("bitBlit/bitBlit.vert"),fragmentShader:x("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class dt{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new b(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new b;let i=null,a=-1;for(let r=0;r<this._free.length;++r){const n=this._free[r];t<=n.width&&e<=n.height&&(i===null||n.y<=i.y&&n.x<=i.x)&&(i=n,a=r)}return i===null?new b:(this._free.splice(a,1),i.width<i.height?(i.width>t&&this._free.push(new b(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new b(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new b(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new b(i.x,i.y+e,t,i.height-e))),new b(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}const ai=256,ni=s=>Math.floor(s/256);function ri(s){const t=new Set;for(const e of s)t.add(ni(e));return t}function oi(s,t,e){return s.has(t)||s.set(t,e().then(()=>{s.delete(t)}).catch(i=>{s.delete(t),ne(i)})),s.get(t)}const hi=s=>({rect:new b(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:s,sdf:!0});class ci{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=i,this._binPack=new dt(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const t=[117,149,181,207,207,181,149,117],e=[];for(let a=0;a<t.length;a++){const r=t[a];for(let n=0;n<11;n++)e.push(r)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)};this._recordGlyph(i)}async getGlyphItems(t,e,i){const a=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map(r=>this._getMosaicItem(a,t,r))}bind(t,e,i,a){const r=this._getTexture(t,i);r.setSamplingMode(e),this._dirties[i]&&(r.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(r,a)}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,e){return this._textures[e]||(this._textures[e]=new Tt(t,{pixelFormat:ut.ALPHA,dataType:zt.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[e]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,e,i){const a=ri(e),r=[];a.forEach(n=>{r.push(this._fetchRange(t,n,i))}),await Promise.all(r)}async _fetchRange(t,e,i){if(e>ai)return;const a=t+e;return oi(this._rangePromises,a,()=>this._glyphSource.getRange(t,e,i))}_getMosaicItem(t,e,i){if(!t[i]){const a=this._glyphSource.getGlyph(e,i);if(!a||!a.metrics)return hi(i);const r=this._recordGlyph(a),n=this._currentPage,o=a.metrics;t[i]={rect:r,page:n,metrics:o,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(e.width===0)i=new b(0,0,0,0);else{const r=e.width+6,n=e.height+2*3;i=this._binPack.allocate(r,n),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new dt(this.width-4,this.height-4),i=this._binPack.allocate(r,n));const o=this._glyphData[this._currentPage],h=t.bitmap;let c,u;if(h)for(let d=0;d<n;d++){c=r*d,u=this.width*(i.y+d)+i.x;for(let l=0;l<r;l++)o[u+l]=h[c+l]}It("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),a=new ImageData(this.width,this.height),r=a.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let n=0;n<t.length;++n)r[4*n+0]=t[n],r[4*n+1]=0,r[4*n+2]=0,r[4*n+3]=255;i.putImageData(a,0,0),document.body.appendChild(e)}}class ui{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const i=e.getMessage();let a,r,n,o,h,c,u;for(;i.next();)switch(i.tag()){case 1:a=i.getUInt32();break;case 2:r=i.getBytes();break;case 3:n=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:h=i.getSInt32();break;case 6:c=i.getSInt32();break;case 7:u=i.getUInt32();break;default:i.skip()}i.release(),a&&(this._metrics[a]={width:n,height:o,left:h,top:c,advance:u},this._bitmaps[a]=r);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class li{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class di{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const a=this._getFontStack(t);if(a.getRange(e))return Promise.resolve();const r=256*e,n=r+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",r+"-"+n);return Jt(o,{responseType:"array-buffer",...i}).then(h=>{a.addRange(e,new ui(new re(new Uint8Array(h.data),new DataView(h.data))))})}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const a=Math.floor(e/256);if(a>256)return;const r=i.getRange(a);return r?{metrics:r.getMetrics(e),bitmap:r.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new li),e}}const Z=1e20;class mi{constructor(t){this._svg=null,this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,e,i=31){this._initSVG();const a=this.createSVGString(t);return new Promise((r,n)=>{const o=new Image;o.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(a),o.onload=()=>{o.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(o,0,0,this.size,this.size);const c=this._context.getImageData(0,0,this.size,this.size),u=new Uint8Array(this.size*this.size*4);for(let d=0;d<this.size*this.size;d++){const l=c.data[4*d+3]/255;this._gridOuter[d]=l===1?0:l===0?Z:Math.max(0,.5-l)**2,this._gridInner[d]=l===1?Z:l===0?0:Math.max(0,l-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let d=0;d<this.size*this.size;d++){const l=this._gridOuter[d]-this._gridInner[d];oe(.5-l/(2*i),u,4*d)}r(u)};const h=e&&e.signal;h&&he(h,()=>n(ce()))})}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}return this._svg}createSVGString(t){const e=this._initSVG(),i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",t),e.appendChild(i);const a=i.getBBox(),r=a.width/a.height,n=this.size/2;let o,h,c,u;if(r>1){h=o=n/a.width;const g=n*(1/r);c=this.size/4,u=n-g/2}else o=h=n/a.height,c=n-n*r/2,u=this.size/4;const d=-a.x*o+c,l=-a.y*h+u;i.setAttribute("style",`transform: matrix(${o}, 0, 0, ${h}, ${d}, ${l})`);const m=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${e.innerHTML}</svg>`;return e.removeChild(i),m}_edt(t,e,i){const a=this._f,r=this._d,n=this._v,o=this._z;for(let h=0;h<e;h++){for(let c=0;c<i;c++)a[c]=t[c*e+h];this._edt1d(a,r,n,o,i);for(let c=0;c<i;c++)t[c*e+h]=r[c]}for(let h=0;h<i;h++){for(let c=0;c<e;c++)a[c]=t[h*e+c];this._edt1d(a,r,n,o,e);for(let c=0;c<e;c++)t[h*e+c]=Math.sqrt(r[c])}}_edt1d(t,e,i,a,r){i[0]=0,a[0]=-Z,a[1]=+Z;for(let n=1,o=0;n<r;n++){let h=(t[n]+n*n-(t[i[o]]+i[o]*i[o]))/(2*n-2*i[o]);for(;h<=a[o];)o--,h=(t[n]+n*n-(t[i[o]]+i[o]*i[o]))/(2*n-2*i[o]);o++,i[o]=n,a[o]=h,a[o+1]=+Z}for(let n=0,o=0;n<r;n++){for(;a[o+1]<n;)o++;e[n]=(n-i[o])*(n-i[o])+t[i[o]]}}}function L(s){return s&&s.type==="static"}class Rt{constructor(t,e,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new dt(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*r)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,a,r,n,o=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let h,c,u;if(L(i))[h,c,u]=this._allocateImage(e[0],e[1]);else{h=new b(0,0,e[0],e[1]),c=this._mosaicPages.length;const l=void 0;this._mosaicPages.push({mosaicsData:i,size:[e[0]+2*v,e[1]+2*v],dirty:!0,texture:l})}if(h.width<=0||h.height<=0)return null;const d={rect:h,width:e[0],height:e[1],sdf:r,simplePattern:n,pixelRatio:o,page:c};return this._mosaicRects.set(t,d),L(i)&&this._copy({rect:h,spriteSize:e,spriteData:i.data,page:c,pageSize:u,repeat:a,sdf:r}),d}hasItemsToProcess(){return this._spriteCopyQueue.length!==0}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const a=e.width,r=e.height,n=v,o=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+n)/o[0],(i.y+n)/o[1]],br:[(i.x+n+a)/o[0],(i.y+n+r)/o[1]],page:e.page}}bind(t,e,i=0,a=0){const r=this._mosaicPages[i],n=r.mosaicsData;let o=r.texture;o||(o=gi(t,r.size),r.texture=o),o.setSamplingMode(e),L(n)?(t.bindTexture(o,a),r.dirty&&(o.setData(new Uint8Array(n.data.buffer)),o.generateMipmap())):(n.data.bindFrame(t,o,a),o.generateMipmap()),r.dirty=!1}static _copyBits(t,e,i,a,r,n,o,h,c,u,d){let l=a*e+i,m=h*n+o;if(d){m-=n;for(let g=-1;g<=u;g++,l=((g+u)%u+a)*e+i,m+=n)for(let p=-1;p<=c;p++)r[m+p]=t[l+(p+c)%c]}else for(let g=0;g<u;g++){for(let p=0;p<c;p++)r[m+p]=t[l+p];l+=e,m+=n}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!L(e.mosaicsData))throw new C("mapview-invalid-resource","unsuitable data type!");const a=t.spriteData,r=i.data;r&&a||console.error("Source or target images are uninitialized!"),Rt._copyBits(a,t.spriteSize[0],0,0,r,t.pageSize[0],t.rect.x+v,t.rect.y+v,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*v,e+=2*v;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const r=2**Math.ceil(Lt(t)),n=2**Math.ceil(Lt(e)),o=new b(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*n)},size:[r,n],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[r,n]]}const a=this._binPack.allocate(t,e);if(a.width<=0){const r=this._mosaicPages[this._currentPage];return!r.dirty&&L(r.mosaicsData)&&(r.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new dt(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[a,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;L(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}}function gi(s,t){return new Tt(s,{pixelFormat:ut.RGBA,dataType:zt.UNSIGNED_BYTE,width:t[0],height:t[1]},null)}function ee(s){return $(s.frameDurations.reduce((t,e)=>t+e,0))}function _i(s){const{width:t,height:e}=s;return{frameDurations:s.frameDurations.reverse(),getFrame:i=>{const a=s.frameDurations.length-1-i;return s.getFrame(a)},width:t,height:e}}function pi(s,t){const{width:e,height:i,getFrame:a}=s,r=t/ee(s);return{frameDurations:s.frameDurations.map(n=>$(n*r)),getFrame:a,width:e,height:i}}function fi(s,t){const{width:e,height:i,getFrame:a}=s,r=s.frameDurations.slice(),n=r.shift();return r.unshift($(n+t)),{frameDurations:r,getFrame:a,width:e,height:i}}function Ot(s,t){const{width:e,height:i,getFrame:a}=s,r=s.frameDurations.slice(),n=r.pop();return r.push($(n+t)),{frameDurations:r,getFrame:a,width:e,height:i}}class wi{constructor(t,e,i,a){this._animation=t,this._repeatType=i,this._onFrameData=a,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let r=0;for(;e>r;)r+=this.timeToFrame,this.nextFrame();const n=this._animation.getFrame(this._currentFrame);this._onFrameData(n)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case R.None:this._currentFrame-=this._direction;break;case R.Loop:this._currentFrame=0;break;case R.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(this._currentFrame===-1)switch(this._repeatType){case R.None:this._currentFrame-=this._direction;break;case R.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case R.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const t=this._animation.getFrame(this._currentFrame);this._onFrameData(t)}}function yi(s,t,e,i){let a,{repeatType:r}=t;if(r==null&&(r=R.Loop),t.reverseAnimation===!0&&(s=_i(s)),t.duration!=null&&(s=pi(s,$(1e3*t.duration))),t.repeatDelay!=null){const n=1e3*t.repeatDelay;r===R.Loop?s=Ot(s,$(n)):r===R.Oscillate&&(s=fi(Ot(s,$(n/2)),$(n/2)))}if(t.startTimeOffset!=null)a=$(1e3*t.startTimeOffset);else if(t.randomizeStartTime!=null){const n=Be(e),o=82749913,h=t.randomizeStartSeed!=null?t.randomizeStartSeed:o,c=ke(n,h);a=$(c*ee(s))}else a=$(0);return new wi(s,a,r,i)}function vi(s,t,e,i){const a=t.playAnimation==null||t.playAnimation,r=yi(s,t,e,i);let n,o=r.timeToFrame;function h(){n=a?setTimeout(()=>{r.nextFrame(),o=r.timeToFrame,h()},o):void 0}return h(),{remove:()=>{a&&clearTimeout(n)}}}const St=document.createElement("canvas"),at=St.getContext("2d");function bi(s,t,e){St.width=t,St.height=e;const i=[],a=s.frameDurations.length;for(let r=0;r<a;r++){const n=s.getFrame(r);at.clearRect(0,0,t,e),n instanceof ImageData?at.drawImage(Ke(n),0,0,t,e):at.drawImage(n,0,0,t,e),i.push(at.getImageData(0,0,t,e))}return{width:t,height:e,frameDurations:s.frameDurations,getFrame:r=>i[r]}}class xi{constructor(t,e,i,a){this._animation=t,this._frameData=null;const r=n=>{this._frameData=n,e.requestRender()};this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=vi(this._animation,i,a,r)}destroy(){this._playHandle.remove()}bindFrame(t,e,i){t.bindTexture(e,i),J(this._frameData)||(e.updateData(0,v,v,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}}function Mi(s){switch(s.type){case"esriSMS":return`${s.style}.${s.path}`;case"esriSLS":return`${s.style}.${s.cap}`;case"esriSFS":return`${s.style}`;case"esriPFS":case"esriPMS":return s.imageData?`${s.imageData}${s.width}${s.height}`:`${s.url}${s.width}${s.height}`;default:return"mosaicHash"in s?s.mosaicHash:JSON.stringify(s)}}const Gt=me(),qt="arial-unicode-ms-regular",pt=126,ie=Kt.getLogger("esri.views.2d.engine.webgl.TextureManager");function Zt(s,t){const e=Math.round(O(t)*window.devicePixelRatio),i=e>=128?2:4;return Math.min(s,e*i)}const ft=(s,t,e)=>ie.error(new C(s,t,e));class Pt{static fromMosaic(t,e){return new Pt(t,e.page,e.sdf)}constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}}class hs{constructor(t,e,i){this._requestRender=t,this.resourceManager=e,this._allowNonPowerOfTwo=i,this._invalidFontsMap=new Map,this._sdfConverter=new mi(pt),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new ue({concurrency:10,process:async(a,r)=>{le(r);try{return await Jt(a,{responseType:"image",signal:r})}catch(n){throw Ct(n)?n:new C("mapview-invalid-resource",`Could not fetch requested resource at ${a}`,n)}}}),this._spriteMosaic=new Rt(2048,2048,500),this._glyphSource=new di(`${de.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new ci(1024,1024,this._glyphSource),this._rasterizer=new Ue(e)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(t,e,i,a){if(J(t))return ft("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const r=await this._rasterizeText(t,i,a);return r.forEach(n=>this._setTextureBinding(it.GLYPH,n)),{glyphMosaicItems:r}}default:{if(Ze(t))return ft("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const r=await this._rasterizeSpriteSymbol(t,e,a);return ti(r)&&r&&this._setTextureBinding(it.SPRITE,r),{spriteMosaicItem:r}}}}bindTextures(t,e,i,a=!1){if(i.textureBinding===0)return;const r=this._bindingInfos[i.textureBinding-1],n=r.page,o=a?Mt.LINEAR_MIPMAP_LINEAR:Mt.LINEAR;switch(r.mosaicType){case it.SPRITE:{const h=this.sprites.getWidth(n),c=this.sprites.getHeight(n),u=K(Gt,h,c);return this._spriteMosaic.bind(t,o,n,kt),e.setUniform1i("u_texture",kt),void e.setUniform2fv("u_mosaicSize",u)}case it.GLYPH:{const h=this.glyphs.width,c=this.glyphs.height,u=K(Gt,h,c);return this._glyphMosaic.bind(t,o,n,Bt),e.setUniform1i("u_texture",Bt),void e.setUniform2fv("u_mosaicSize",u)}default:ie.error("mapview-texture-manager",`Cannot handle unknown type ${r.mosaicType}`)}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const a=Pt.fromMosaic(t,e),r=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,r),this._bindingInfos.push(a)}e.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,e,i){let a,r;if("cim"in t){const h=t;a=h.fontName,r=h.text}else{const h=t;a=Ne(h.font),r=h.text}const n=this._invalidFontsMap.has(a),o=e||He(Le(r)[0]);try{return await this._glyphMosaic.getGlyphItems(n?qt:a,o,i)}catch{return ft("mapview-invalid-resource",`Couldn't find font ${a}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(a,!0),this._glyphMosaic.getGlyphItems(qt,o,i)}}async _rasterizeSpriteSymbol(t,e,i){if(We(t))return;const a=Mi(t);if(this._spriteMosaic.has(a))return this._spriteMosaic.getSpriteItem(a);if(Nt(t)||Ye(t)&&!Qe(t))return this._handleAsyncResource(a,t,i);const r=Ve,n=this._rasterizer.rasterizeJSONResource(t,r);if(n){const{size:o,image:h,sdf:c,simplePattern:u,rasterizationScale:d}=n;return this._addItemToMosaic(a,o,{type:"static",data:h},st(t),c,u,d)}return new C("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(t,e,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let a;a=Nt(e)?this._handleSVG(e,t,i):this._handleImage(e,t,i),this._ongoingRasterizations.set(t,a);try{await a,this._ongoingRasterizations.delete(t)}catch{this._ongoingRasterizations.delete(t)}return a}async _handleSVG(t,e,i){const a=[pt,pt],r=await this._sdfConverter.draw(t.path,i);return this._addItemToMosaic(e,a,{type:"static",data:new Uint32Array(r.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,e,i){const a=Ut(t);await this.resourceManager.fetchResource(a,i);let r=this.resourceManager.getResource(a);if(J(r))return new C("mapview-invalid-resource",`Could not fetch requested resource at ${a}.`);let n=r.width,o=r.height;if(r instanceof HTMLImageElement){t.type==="esriPMS"&&(n=Math.round(Zt(r.width,Vt(t))),o=Math.round(r.height*(n/r.width)));const d="cim"in t?t.cim.colorSubstitutions:void 0,{size:l,sdf:m,image:g}=this._rasterizer.rasterizeImageResource(n,o,r,d);return this._addItemToMosaic(e,l,{type:"static",data:g},st(t),m,!1)}this._allowNonPowerOfTwo||(n=Dt(r.width+2*v)-2*v,o=Dt(r.height+2*v)-2*v),n===r.width&&o===r.height||(r=bi(r,n,o));const h=t.animatedSymbolProperties||{},c=t.objectId,u=new xi(r,this._requestRender,h,c);return this._addItemToMosaic(e,[u.width,u.height],{type:"animated",data:u},st(t),!1,!1)}async _handleImage(t,e,i){var r;if(Xe(t)||je(t))return this._handleGIFOrPNG(t,e,i);const a=Ut(t);try{let n;const o=this.resourceManager.getResource(a);if(E(o)&&o instanceof HTMLImageElement)n=o;else{const{data:g}=await this._imageRequestQueue.push(a,{...i});n=g}if(Je(a)){if("width"in t&&"height"in t)n.width=O(t.width),n.height=O(t.height);else if("cim"in t){const g=t.cim;n.width=O((r=g.width)!=null?r:g.scaleX*g.size),n.height=O(g.size)}}if(!n.width||!n.height)return null;let h=n.width,c=n.height;t.type==="esriPMS"&&(h=Math.round(Zt(n.width,Vt(t))),c=Math.round(n.height*(h/n.width)));const u="cim"in t?t.cim.colorSubstitutions:void 0,{size:d,sdf:l,image:m}=this._rasterizer.rasterizeImageResource(h,c,n,u);return this._addItemToMosaic(e,d,{type:"static",data:m},st(t),l,!1)}catch(n){if(!Ct(n))return new C("mapview-invalid-resource",`Could not fetch requested resource at ${a}. ${n.message}`)}}_addItemToMosaic(t,e,i,a,r,n,o){return this._spriteMosaic.addSpriteItem(t,e,i,a,r,n,o)}}const cs={shaders:{vertexShader:x("stencil/stencil.vert"),fragmentShader:x("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},$i=s=>s.replace("-","_").toUpperCase(),Ht=s=>`#define ${$i(s)}
`;function Wt(s){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:Ht(s)+x("blend/blend.vert"),fragmentShader:Ht(s)+x("blend/blend.frag")}}}const Yt=Kt.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class us{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture=Et(this._backBufferTexture),this._quad=Et(this._quad)}draw(t,e,i,a,r){const{context:n,drawPhase:o}=t;if(this._setupShader(n),a&&a!=="normal"&&o!==qe.LABEL)return void this._drawBlended(t,e,i,a,r);const h=Wt("normal"),c=n.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!c)return void Yt.error(new C("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));n.useProgram(c),e.setSamplingMode(i),n.bindTexture(e,0),c.setUniform1i("u_layerTexture",0),c.setUniform1f("u_opacity",r),n.setBlendingEnabled(!0),n.setBlendFunction(k.ONE,k.ONE_MINUS_SRC_ALPHA);const u=this._quad;u.draw(),u.unbind(),c.dispose()}_drawBlended(t,e,i,a,r){const{context:n,state:o,pixelRatio:h,inFadeTransition:c}=t,{size:u}=o,d=n.getBoundFramebufferObject();let l,m;if(E(d)){const F=d.descriptor;l=F.width,m=F.height}else l=Math.round(h*u[0]),m=Math.round(h*u[1]);this._createOrResizeTexture(t,l,m);const g=this._backBufferTexture;d.copyToTexture(0,0,l,m,0,0,g),n.setStencilTestEnabled(!1),n.setStencilWriteMask(0),n.setBlendingEnabled(!0),n.setDepthTestEnabled(!1),n.setDepthWriteEnabled(!1);const p=Wt(a),y=n.programCache.acquire(p.shaders.vertexShader,p.shaders.fragmentShader,p.attributes);if(!y)return void Yt.error(new C("mapview-BlendEffect",`Error creating shader program for blend mode ${a}`));n.useProgram(y),g.setSamplingMode(i),n.bindTexture(g,0),y.setUniform1i("u_backbufferTexture",0),e.setSamplingMode(i),n.bindTexture(e,1),y.setUniform1i("u_layerTexture",1),y.setUniform1f("u_opacity",r),y.setUniform1f("u_inFadeOpacity",c?1:0),n.setBlendFunction(k.ONE,k.ZERO);const w=this._quad;w.draw(),w.unbind(),y.dispose(),n.setBlendFunction(k.ONE,k.ONE_MINUS_SRC_ALPHA)}_setupShader(t){this._quad||(this._quad=new ae(t,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(t,e,i){const{context:a}=t;this._backBufferTexture!==null&&e===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(e,i):this._backBufferTexture=new Tt(a,{target:ge.TEXTURE_2D,pixelFormat:ut.RGBA,internalFormat:ut.RGBA,dataType:zt.UNSIGNED_BYTE,wrapMode:_e.CLAMP_TO_EDGE,samplingMode:Mt.LINEAR,flipped:!1,width:e,height:i}),this._size[0]=e,this._size[1]=i)}}const ls={shaders:{vertexShader:x("highlight/textured.vert"),fragmentShader:x("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},ds={shaders:{vertexShader:x("highlight/textured.vert"),fragmentShader:x("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},M=It("esri-2d-profiler");class ms{constructor(t,e){if(this._events=new pe,this._entries=new Map,this._timings=new ei(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!M)return;this._ext=fe(t.gl,{}),this._debugOutput=e;const i=t.gl;if(this.enableCommandLogging){for(const a in i)if(typeof i[a]=="function"){const r=i[a],n=a.includes("draw");i[a]=(...o)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:a,args:o,isDrawCommand:n}),this._currentSummary&&(this._currentSummary.commands++,n&&this._currentSummary.drawCommands++),r.apply(i,o))}}}get enableCommandLogging(){return!(typeof M=="object"&&M.disableCommands)}recordContainerStart(t){M&&(this._currentContainer=t)}recordContainerEnd(){M&&(this._currentContainer=null)}recordPassStart(t){M&&(this._currentPass=t,this._initSummary())}recordPassEnd(){M&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){M&&(this._currentBrush=t)}recordBrushEnd(){M&&(this._currentBrush=null)}recordStart(t){if(M&&E(this._ext)){if(this._entries.has(t)){const i=this._entries.get(t),a=this._ext.resultAvailable(i.query),r=this._ext.disjoint();if(a&&!r){const n=this._ext.getResult(i.query)/1e6;let o=0;if(E(this._timings.enqueue(n))){const u=this._timings.entries,d=u.length;let l=0;for(const m of u)l+=m;o=l/d}const h=n.toFixed(2),c=o?o.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${h} ms (${c} last 10 avg)
${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${h} ms (${c} last 10 avg)`),this._debugOutput.innerHTML=`${h} (${c})`}for(const n of i.handles)n.remove();this._ext.deleteQuery(i.query),this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",i=>{e.commandsLen++,e.commands.push(i),i.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",i=>{e.summaries.push(i)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){M&&E(this._ext)&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}const nt=2,T=1,Q=0,X=1,j=2;class Si{constructor(t,e,i){this._debugMap=new Map,this._width=t*i,this._height=e*i,this._pixelRatio=i;const a=Math.ceil(this._width/T),r=Math.ceil(this._height/T);this._cols=a,this._rows=r,this._cells=ii.create(a*r)}insertMetrics(t){const e=this._hasCollision(t);return e===Q&&this._markMetrics(t),e}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_collide(t,e,i,a){const r=t-i/2,n=e-a/2,o=r+i,h=n+a;if(o<0||h<0||r>this._width||n>this._height)return X;const c=I(Math.floor(r/T),0,this._cols),u=I(Math.floor(n/T),0,this._rows),d=I(Math.ceil(o/T),0,this._cols),l=I(Math.ceil(h/T),0,this._rows);for(let m=u;m<=l;m++)for(let g=c;g<=d;g++){const p=this.getCellId(g,m);if(this.has(p))return j}return Q}_mark(t,e,i,a,r){const n=t-i/2,o=e-a/2,h=n+i,c=o+a,u=I(Math.floor(n/T),0,this._cols),d=I(Math.floor(o/T),0,this._rows),l=I(Math.ceil(h/T),0,this._cols),m=I(Math.ceil(c/T),0,this._rows);for(let g=d;g<=m;g++)for(let p=u;p<=l;p++){const y=this.getCellId(p,g);this._debugMap.set(y,r),this.set(y)}return!1}_hasCollision(t){const e=t.id;let i=0,a=0;t.save();do{const r=t.boundsCount;i+=r;for(let n=0;n<r;n++){const o=t.boundsComputedAnchorX(n),h=t.boundsComputedAnchorY(n),c=(t.boundsWidth(n)+nt)*this._pixelRatio,u=(t.boundsHeight(n)+nt)*this._pixelRatio;switch(this._collide(o,h,c,u)){case j:return j;case X:a++}}}while(t.peekId()===e&&t.next());return t.restore(),i===a?X:Q}_markMetrics(t){const e=t.id;t.save();do{const i=t.boundsCount;for(let a=0;a<i;a++){const r=t.boundsComputedAnchorX(a),n=t.boundsComputedAnchorY(a),o=(t.boundsWidth(a)+nt)*this._pixelRatio,h=(t.boundsHeight(a)+nt)*this._pixelRatio;this._mark(r,n,o,h,t.id)}}while(t.peekId()===e&&t.next());t.restore()}}const Ti=Math.PI;function se(s,t){switch(t.transformationType){case P.Additive:return zi(s,t);case P.Constant:return Ii(t,s);case P.ClampedLinear:return Ri(s,t);case P.Proportional:return Pi(s,t);case P.Stops:return Ci(s,t);case P.RealWorldSize:return Di(s,t);case P.Identity:return s;case P.Unknown:return null}}function S(s,t){return typeof s=="number"?s:se(t,s)}function zi(s,t){return s+(S(t.minSize,s)||t.minDataValue)}function Ii(s,t){const e=s.stops;let i=e&&e.length&&e[0].size;return i==null&&(i=s.minSize),S(i,t)}function Ri(s,t){const e=t.minDataValue,i=t.maxDataValue,a=(s-e)/(i-e),r=S(t.minSize,s),n=S(t.maxSize,s);return s<=e?r:s>=i?n:r+a*(n-r)}function Pi(s,t){const e=s/t.minDataValue,i=S(t.minSize,s),a=S(t.maxSize,s);let r=null;return r=e*i,I(r,i,a)}function Ci(s,t){const[e,i,a]=Ei(s,t.cache.ipData);if(e===i)return S(t.stops[e].size,s);{const r=S(t.stops[e].size,s);return r+(S(t.stops[i].size,s)-r)*a}}function Di(s,t){const e=we[t.valueUnit],i=S(t.minSize,s),a=S(t.maxSize,s),{valueRepresentation:r}=t;let n=null;return n=r==="area"?2*Math.sqrt(s/Ti)/e:r==="radius"||r==="distance"?2*s/e:s/e,I(n,i,a)}function Ei(s,t){if(!t)return;let e=0,i=t.length-1;return t.some((a,r)=>s<a?(i=r,!0):(e=r,!1)),[e,i,(s-t[e])/(t[i]-t[e])]}const wt=254,rt=255,H=0;function N(s,t){const e=[];s.forEachTile(i=>e.push(i)),e.sort((i,a)=>i.instanceId-a.instanceId),e.forEach(i=>{E(i.labelMetrics)&&i.isReady&&t(i,i.labelMetrics.getCursor())})}function Fi(s){return s.layer&&(s.layer.type==="feature"||s.layer.type==="csv"||s.layer.type==="geojson"||s.layer.type==="ogc-feature"||s.layer.type==="stream"||s.layer.type==="subtype-group"||s.layer.type==="wfs")}function Ai(s){return t=>O(se(t,s))}function Bi(s){const t=s!=null&&"visualVariables"in s&&s.visualVariables;if(!t)return null;for(const e of t)if(e.type==="size")return Ai(e);return null}function ki(s){for(const t of s){const e="featureReduction"in t&&t.featureReduction&&"labelingInfo"in t.featureReduction?t.featureReduction:void 0,i=[...t.labelingInfo||[],...(e==null?void 0:e.labelingInfo)||[]];if(!(!t.labelsVisible||!i.length)&&i.some(a=>a.deconflictionStrategy==="none"))return!0}return!1}function Li(s,t){var h;if(!Fi(t))return;const e=t.layer.type==="subtype-group"?t.layer.sublayers.items:[t.layer],i=t.layer.geometryType,a=!ki(e),r={};if(t.layer.type!=="subtype-group"){if(((h=t.tileRenderer)==null?void 0:h.type)==="heatmap")return;const c=Bi(t.layer.renderer);r[0]=c}const n=t.tileRenderer;if(J(n))return;const o=t.layer.visible&&!t.suspended;s.push({tileRenderer:n,vvEvaluators:r,deconflictionEnabled:a,geometryType:i,visible:o})}class Ni{run(t,e,i){const a=[];for(let r=t.length-1;r>=0;r--)Li(a,t[r]);this._transformMetrics(a),this._runCollision(a,e,i)}_runCollision(t,e,i){const[a,r]=e.state.size,n=new Si(a,r,e.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:h,visible:c}of t){const u=o.featuresView.attributeView;h?c?(this._prepare(o),this._collideVisible(n,o,i),this._collideInvisible(n,o)):N(o,(d,l)=>{for(;l.nextId();)u.setLabelMinZoom(l.id,rt)}):N(o,(d,l)=>{for(;l.nextId();)u.setLabelMinZoom(l.id,H),c&&n.insertMetrics(l)})}}_isFiltered(t,e,i){const a=e.getFilterFlags(t),r=!i.hasFilter||!!(a&Oe),n=J(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(a&Ge);return!(r&&n)}_prepare(t){const e=t.featuresView.attributeView,i=new Set;N(t,(a,r)=>{for(;r.nextId();)if(!i.has(r.id)){if(i.add(r.id),this._isFiltered(r.id,e,t.layerView)){e.setLabelMinZoom(r.id,wt);continue}e.getLabelMinZoom(r.id)!==H?e.setLabelMinZoom(r.id,rt):e.setLabelMinZoom(r.id,H)}})}_collideVisible(t,e,i){const a=e.featuresView.attributeView,r=new Set;N(e,(n,o)=>{for(;o.nextId();)if(!r.has(o.id))if(n.key.level===i){if(a.getLabelMinZoom(o.id)===0)switch(t.insertMetrics(o)){case X:break;case j:a.setLabelMinZoom(o.id,wt),r.add(o.id);break;case Q:a.setLabelMinZoom(o.id,H),r.add(o.id)}}else a.setLabelMinZoom(o.id,wt)})}_collideInvisible(t,e){const i=e.featuresView.attributeView,a=new Set;N(e,(r,n)=>{for(;n.nextId();)if(!a.has(n.id)&&i.getLabelMinZoom(n.id)===rt)switch(t.insertMetrics(n)){case X:break;case j:i.setLabelMinZoom(n.id,rt),a.add(n.id);break;case Q:i.setLabelMinZoom(n.id,H),a.add(n.id)}})}_transformMetrics(t){for(const{tileRenderer:e,geometryType:i,vvEvaluators:a}of t)N(e,(r,n)=>{const o=e.featuresView.attributeView,h=r.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const c=i==="polyline";for(;n.next();){const u=n.boundsCount,d=n.anchorX,l=n.anchorY;let m=n.size;const g=a[0];if(E(g)){const w=g(o.getVVSize(n.id));m=isNaN(w)||w==null||w===1/0?m:w}const p=n.directionX*(m/2),y=n.directionY*(m/2);for(let w=0;w<u;w++){let F=d,_t=n.anchorY;if(c){let A=F+n.boundsX(w)+p,B=_t+n.boundsY(w)+y;A=h[0]*A+h[2]*B+h[4],B=h[1]*A+h[3]*B+h[5],n.setBoundsComputedAnchorX(w,Math.floor(A)),n.setBoundsComputedAnchorY(w,Math.floor(B))}else{F=h[0]*d+h[2]*l+h[4],_t=h[1]*d+h[3]*l+h[5];const A=F+n.boundsX(w)+p,B=_t+n.boundsY(w)+y;n.setBoundsComputedAnchorX(w,A),n.setBoundsComputedAnchorY(w,B)}}}})}}const Ui=32;let D=class extends ye(q){constructor(s){super(s),this._applyVisibilityPassThrottled=ve(this._applyVisibilityPass,Ui,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new Ni}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled=be(this._applyVisibilityPassThrottled)}get updating(){return It("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:
-> updateRequested: ${this.updateRequested}`),this.updateRequested}update(s){this._applyVisibilityPassThrottled(s)}viewChange(){this.requestUpdate()}requestUpdate(){var s;this.updateRequested||(this.updateRequested=!0,(s=this.view)==null||s.requestUpdate())}processUpdate(s){this._set("updateParameters",s),this.updateRequested&&(this.updateRequested=!1,this.update(s))}_applyVisibilityPass(s){const t=this.view;if(t)try{const e=t.featuresTilingScheme.getClosestInfoForScale(s.state.scale).level;this.collisionEngine.run(t.allLayerViews.items,s,e)}catch{}}};_([f()],D.prototype,"updateRequested",void 0),_([f({readOnly:!0})],D.prototype,"updateParameters",void 0),_([f()],D.prototype,"updating",null),_([f()],D.prototype,"view",void 0),D=_([G("esri.views.2d.layers.labels.LabelManager")],D);const gs=D,ot="esri-zoom-box",ht={container:`${ot}__container`,overlay:`${ot}__overlay`,background:`${ot}__overlay-background`,box:`${ot}__outline`},yt={zoom:"Shift",counter:"Ctrl"};let W=class extends q{constructor(s){super(s),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._handles=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(s){this._handles&&this._handles.forEach(t=>{t.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",s),s&&(s.on("drag",[yt.zoom],t=>this._handleDrag(t,1),Ft.INTERNAL),s.on("drag",[yt.zoom,yt.counter],t=>this._handleDrag(t,-1),Ft.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(s,t,e,i){this._box.x=s,this._box.y=t,this._box.width=e,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(s,t,e,i,a){const r=this.view,n=r.toMap(xe(s+.5*e,t+.5*i));let o=Math.max(e/r.width,i/r.height);a===-1&&(o=1/o),this._destroyOverlay(),this.navigation.end(),r.goTo({center:n,scale:r.scale*o})}_updateBox(s,t,e,i){const a=this._boxShape;a.setAttributeNS(null,"x",""+s),a.setAttributeNS(null,"y",""+t),a.setAttributeNS(null,"width",""+e),a.setAttributeNS(null,"height",""+i),a.setAttributeNS(null,"class",ht.box)}_updateBackground(s,t,e,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(s,t,e,i,this.view.width,this.view.height))}_createContainer(){const s=document.createElement("div");s.className=ht.container,this.view.root.appendChild(s),this._container=s}_createOverlay(){const s=this.view.width,t=this.view.height,e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttributeNS(null,"d","M 0 0 L "+s+" 0 L "+s+" "+t+" L 0 "+t+" Z"),e.setAttributeNS(null,"class",ht.background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),a.setAttributeNS(null,"class",ht.overlay),a.appendChild(e),a.appendChild(i),this._container.appendChild(a),this._backgroundShape=e,this._boxShape=i,this._overlay=a}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(s,t,e,i,a,r){const n=s+e,o=t+i;return"M 0 0 L "+a+" 0 L "+a+" "+r+" L 0 "+r+" ZM "+s+" "+t+" L "+s+" "+o+" L "+n+" "+o+" L "+n+" "+t+" Z"}_handleDrag(s,t){const e=s.x,i=s.y,a=s.origin.x,r=s.origin.y;let n,o,h,c;switch(e>a?(n=a,h=e-a):(n=e,h=a-e),i>r?(o=r,c=i-r):(o=i,c=r-i),s.action){case"start":this._start();break;case"update":this._update(n,o,h,c);break;case"end":this._end(n,o,h,c,t)}s.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:s,y:t,width:e,height:i}=this._box;this._updateBox(s,t,e,i),this._updateBackground(s,t,e,i),this._rafId=requestAnimationFrame(this._redraw)}};_([f()],W.prototype,"navigation",void 0),_([f()],W.prototype,"view",null),W=_([G("esri.views.2d.navigation.ZoomBox")],W);const Vi=W;let U=class extends q{constructor(s){super(s),this.animationTime=0,this.momentumEstimator=new Me(500,6,.92),this.momentum=null,this.tmpMomentum=$e(),this.momentumFinished=!1,this.viewpoint=new mt({targetGeometry:new gt,scale:0,rotation:0}),this._previousDrag=null,te(()=>this.momentumFinished,()=>this.navigation.stop())}begin(s,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this._previousDrag=t}update(s,t){this.addToEstimator(t);let e=t.center.x,i=t.center.y;const a=this._previousDrag;e=a?a.center.x-e:-e,i=a?i-a.center.y:i,s.viewpoint=lt(this.viewpoint,s.viewpoint,[e||0,i||0]),this._previousDrag=t}end(s,t){this.addToEstimator(t);const e=s.navigation.momentumEnabled;this.momentum=e?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(s),this._previousDrag=null,this.navigation.end()}addToEstimator(s){const t=s.center.x,e=s.center.y,i=Te(-t,e),a=ze(-t,e,0);this.momentumEstimator.add(i,a,.001*s.timestamp)}onAnimationUpdate(s){var t;(t=this.navigation.animationManager)==null||t.animateContinous(s.viewpoint,(e,i)=>{const{momentum:a,animationTime:r,tmpMomentum:n}=this,o=.001*i;if(!(this.momentumFinished=!a||a.isFinished(r))){const h=a.valueDelta(r,o);Se(n,a.direction,h),lt(e,e,n),s.constraints.constrainByGeometry(e)}this.animationTime+=o})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};_([f()],U.prototype,"momentumFinished",void 0),_([f()],U.prototype,"viewpoint",void 0),_([f()],U.prototype,"navigation",void 0),U=_([G("esri.views.2d.navigation.actions.Pan")],U);const Oi=U;let V=class extends q{constructor(s){super(s),this._animationTime=0,this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new Ie(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Re,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new mt({targetGeometry:new gt,scale:0,rotation:0}),this.addHandles(te(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(s,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,s.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(s,t){this._updateTimestamp===null&&(this._updateTimestamp=t.timestamp);const e=t.angle,i=t.radius,a=t.center,r=Math.abs(180*(e-this._startAngle)/Math.PI),n=Math.abs(i-this._startRadius),o=this._startRadius/i;if(this._previousRadius&&this._previousCenter){const h=i/this._previousRadius;let c=180*(e-this._previousAngle)/Math.PI;this._rotationDirection=c>=0?1:-1,this._zoomDirection=h>=1?1:-1,s.constraints.rotationEnabled?(this._zoomOnly===null&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=n-r>0),this._zoomOnly===null||this._zoomOnly?c=0:this.addToRotateEstimator(e-this._startAngle,t.timestamp)):c=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([a.x,a.y],1/h,c,[this._previousCenter.x-a.x,a.y-this._previousCenter.y])}this._previousAngle=e,this._previousRadius=i,this._previousCenter=a}end(s){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(s),this.navigation.end()}addToRotateEstimator(s,t){this._rotationMomentumEstimator.add(s,.001*t)}addToZoomEstimator(s,t){this._zoomMomentumEstimator.add(t,.001*s.timestamp)}canZoomIn(s){const t=s.scale,e=s.constraints.effectiveMaxScale;return e===0||t>e}canZoomOut(s){const t=s.scale,e=s.constraints.effectiveMinScale;return e===0||t<e}onAnimationUpdate(s){var t;(t=this.navigation.animationManager)==null||t.animateContinous(s.viewpoint,(e,i)=>{const a=!this.canZoomIn(s)&&this._zoomDirection>1||!this.canZoomOut(s)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=a||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),o=.001*i;if(this._momentumFinished=r&&n,!this._momentumFinished){const h=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,o))*this._rotationDirection*180/Math.PI:0;let c=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,o)):1;const u=tt(),d=tt();if(this._previousCenter){K(u,this._previousCenter.x,this._previousCenter.y),Pe(d,s.size,s.padding),Ce(u,u,d);const{constraints:l,scale:m}=s,g=m*c;c<1&&!l.canZoomInTo(g)?(c=m/l.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):c>1&&!l.canZoomOutTo(g)&&(c=m/l.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),De(e,s.viewpoint,c,h,u,s.size),s.constraints.constrainByGeometry(e)}}this._animationTime+=o})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};_([f()],V.prototype,"_momentumFinished",void 0),_([f()],V.prototype,"viewpoint",void 0),_([f()],V.prototype,"navigation",void 0),V=_([G("esri.views.2d.navigation.actions.Pinch")],V);const Gi=V,vt=tt(),Qt=tt();let Y=class extends q{constructor(s){super(s),this._previousCenter=tt(),this.viewpoint=new mt({targetGeometry:new gt,scale:0,rotation:0})}begin(s,t){this.navigation.begin(),K(this._previousCenter,t.center.x,t.center.y)}update(s,t){const{state:{size:e,padding:i}}=s;K(vt,t.center.x,t.center.y),Ee(Qt,e,i),s.viewpoint=$t(this.viewpoint,s.state.paddedViewState.viewpoint,Fe(Qt,this._previousCenter,vt)),Ae(this._previousCenter,vt)}end(){this.navigation.end()}};_([f()],Y.prototype,"viewpoint",void 0),_([f()],Y.prototype,"navigation",void 0),Y=_([G("esri.views.2d.actions.Rotate")],Y);const qi=Y,ct=10,Xt=1,bt=new mt({targetGeometry:new gt}),xt=[0,0],jt=250;let z=class extends q{constructor(s){super(s),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new Oi({navigation:this}),this.rotate=new qi({navigation:this}),this.pinch=new Gi({navigation:this}),this.zoomBox=new Vi({view:this.view,navigation:this})}destroy(){this.pan=et(this.pan),this.rotate=et(this.rotate),this.pinch=et(this.pinch),this.zoomBox=et(this.zoomBox),this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(jt)}async zoom(s,t=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return s<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,s,0,[0,0])}async zoomIn(s){const t=this.view,e=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(e,s)}async zoomOut(s){const t=this.view,e=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(e,s)}setViewpoint(s,t,e,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,s,t,e,i),this.end()}setViewpointImmediate(s,t=0,e=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,s,t,e)}continousRotateClockwise(){var t;const s=this.get("view.viewpoint");(t=this.animationManager)==null||t.animateContinous(s,e=>{$t(e,e,-Xt)})}continousRotateCounterclockwise(){var t;const s=this.get("view.viewpoint");(t=this.animationManager)==null||t.animateContinous(s,e=>{$t(e,e,Xt)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-ct,0])}continousPanRight(){this._continuousPan([ct,0])}continousPanUp(){this._continuousPan([0,ct])}continousPanDown(){this._continuousPan([0,-ct])}stop(){var s;this.pan.stopMomentumNavigation(),(s=this.animationManager)==null||s.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(s){var e;const t=this.view.viewpoint;(e=this.animationManager)==null||e.animateContinous(t,i=>{lt(i,i,s),this.view.constraints.constrainByGeometry(i)})}_startTimer(s){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{var e;this._endTimer=null;const t=performance.now()-((e=this._lastEventTimestamp)!=null?e:0);t<jt?this._endTimer=this._startTimer(t):this._set("interacting",!1)},s)),this._endTimer}_getDefaultAnchor(){const{size:s,padding:{left:t,right:e,top:i,bottom:a}}=this.view;return xt[0]=.5*(s[0]-e+t),xt[1]=.5*(s[1]-a+i),xt}async _zoomToScale(s,t=this._getDefaultAnchor()){const{view:e}=this,{constraints:i,scale:a,viewpoint:r,size:n,padding:o}=e,h=i.canZoomInTo(s),c=i.canZoomOutTo(s);if(!(s<a&&!h||s>a&&!c))return At(bt,r,s/a,0,t,n,o),i.constrainByGeometry(bt),e.goTo(bt,{animate:!0})}_scaleRotateTranslateViewpoint(s,t,e,i,a){const{view:r}=this,{size:n,padding:o,constraints:h,scale:c,viewpoint:u}=r,d=c*e,l=h.canZoomInTo(d),m=h.canZoomOutTo(d);return(e<1&&!l||e>1&&!m)&&(e=1),lt(u,u,a),At(s,u,e,i,t,n,o),h.constrainByGeometry(s)}};_([f()],z.prototype,"animationManager",void 0),_([f({type:Boolean,readOnly:!0})],z.prototype,"interacting",void 0),_([f()],z.prototype,"pan",void 0),_([f()],z.prototype,"pinch",void 0),_([f()],z.prototype,"rotate",void 0),_([f()],z.prototype,"view",void 0),_([f()],z.prototype,"zoomBox",void 0),z=_([G("esri.views.2d.navigation.MapViewNavigation")],z);const _s=z,Zi={shaders:{vertexShader:x("magnifier/magnifier.vert"),fragmentShader:x("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function ps(s){return si(s,Zi)}export{hs as J,us as _,ds as a,ps as b,Zi as c,os as e,ms as i,cs as r,ls as t,gs as u,_s as y};
